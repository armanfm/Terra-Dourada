<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üåç Terra Dourada - Candidato Sem Partido</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/pouchdb@7.3.1/dist/pouchdb.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    body {
      background-color: #050703;
      color: #f5f5f5;
      display: flex; 
      justify-content: center; 
      align-items: center;
      min-height: 100vh;
      font-family: 'Segoe UI', system-ui, sans-serif;
      padding: 20px;
    }
    .container {
      text-align: center;
      padding: 40px;
      background: linear-gradient(145deg, rgba(20,20,15,0.9), rgba(30,25,10,0.9));
      border-radius: 20px;
      border: 1px solid rgba(212,175,55,0.3);
      width: 100%;
      max-width: 500px;
      box-shadow: 0 0 20px rgba(212,175,55,0.2);
    }
    h1 { 
      color: #d4af37; 
      margin-bottom: 10px;
      font-size: 2rem;
    }
    .subtitle {
      color: #bbb;
      margin-bottom: 30px;
      font-size: 1.1rem;
    }
    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }
    label {
      display: block;
      margin-bottom: 8px;
      color: #d4af37;
    }
    input, textarea {
      width: 100%; 
      padding: 12px;
      border-radius: 8px; 
      border: 1px solid #d4af37;
      background: #111; 
      color: #fff; 
      font-size: 0.95rem;
      box-sizing: border-box;
    }
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    .photo-upload {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 20px;
    }
    .photo-preview {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      border: 2px solid #d4af37;
      background-color: #111;
      margin-bottom: 15px;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .photo-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .photo-preview i {
      font-size: 3rem;
      color: #555;
    }
    .photo-upload label {
      background: transparent; 
      border: 1px solid #d4af37;
      color: #d4af37; 
      padding: 10px 20px; 
      border-radius: 30px;
      cursor: pointer; 
      transition: 0.3s ease;
      display: inline-block;
    }
    .photo-upload label:hover {
      background: rgba(212,175,55,0.15);
      transform: translateY(-2px);
    }
    .photo-upload input[type="file"] {
      display: none;
    }
    button {
      background: transparent; 
      border: 1px solid #d4af37;
      color: #d4af37; 
      padding: 12px 35px; 
      border-radius: 30px;
      cursor: pointer; 
      transition: 0.3s ease;
      font-size: 1rem;
      margin-top: 10px;
    }
    button:hover {
      background: rgba(212,175,55,0.15);
      transform: translateY(-2px);
    }
    .back-button {
      margin-top: 20px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.3);
    }
    .back-button:hover {
      background: rgba(255,255,255,0.2);
    }
    .success-message {
      display: none;
      background: rgba(20, 100, 20, 0.3);
      border: 1px solid rgba(100, 255, 100, 0.5);
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
    }

    /* Estilos para a tela de confirma√ß√£o */
    .confirmation-screen {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(10, 15, 10, 0.95);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .confirmation-card {
      background: #1a1f1a;
      border: 2px solid #d4af37;
      border-radius: 15px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      text-align: center;
    }

    .confirmation-card img {
      width: 200px;
      height: 200px;
      object-fit: cover;
      margin: 0 auto 20px;
      border-radius: 50%;
      border: 3px solid #d4af37;
      display: block;
    }

    .confirmation-card h2 {
      color: #d4af37;
      margin-bottom: 20px;
    }

    .confirmation-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
    }

    .confirm-button {
      background: rgba(212,175,55,0.2);
      border: 1px solid #d4af37;
      color: #d4af37;
      padding: 12px 25px;
      border-radius: 20px;
      cursor: pointer;
      transition: 0.3s;
      font-size: 1rem;
    }

    .confirm-button:hover {
      background: rgba(212,175,55,0.4);
    }

    .cancel-button {
      background: transparent;
      border: 1px solid #888;
      color: #888;
      padding: 12px 25px;
      border-radius: 20px;
      cursor: pointer;
      transition: 0.3s;
      font-size: 1rem;
    }

    .cancel-button:hover {
      background: rgba(136,136,136,0.2);
    }

    #processando {
      display:none;
      position:fixed;
      top:0; left:0; right:0; bottom:0;
      background:#000c;
      color:#d4af37;
      font-size:1.5rem;
      font-family:system-ui;
      backdrop-filter:blur(4px);
      justify-content:center;
      align-items:center;
      text-shadow:0 0 8px #d4af37;
    }
  </style>
</head>
<body>
  <!-- Formul√°rio de cadastro -->
  <div class="container" id="formContainer">
    <h1>üåç Terra Dourada</h1>
    <p class="subtitle">Candidato Sem Partido</p>
    
    <div class="photo-upload">
      <div class="photo-preview" id="photoPreview">
        <i class="fas fa-user"></i>
      </div>
      <label for="photoInput">
        <i class="fas fa-camera"></i> Escolher Foto
      </label>
      <input type="file" id="photoInput" accept="image/*">
    </div>
    
    <div class="form-group">
      <label for="nameInput">Nome Completo</label>
      <input type="text" id="nameInput" placeholder="Digite seu nome completo">
    </div>
    
    <div class="form-group">
      <label for="positionInput">Cargo</label>
      <input type="text" id="positionInput" placeholder="Ex: Vereador, Prefeito, Deputado">
    </div>
    
    <div class="form-group">
      <label for="bioInput">Biografia (Opcional)</label>
      <textarea id="bioInput" placeholder="Fale sobre sua trajet√≥ria e propostas"></textarea>
    </div>
    
    <button id="registerButton">CADASTRAR CANDIDATO</button>
    
    <div class="success-message" id="successMessage">
      <p><i class="fas fa-check-circle"></i> Candidato cadastrado com sucesso!</p>
    </div>
    
    <button class="back-button" id="backButton">
      <i class="fas fa-arrow-left"></i> Voltar ao Login
    </button>
  </div>

  <!-- Tela de confirma√ß√£o -->
  <div id="confirmationScreen" class="confirmation-screen">
    <div id="confirmationCard" class="confirmation-card">
      <img id="confirmationImage" src="" alt="Candidato">
      <h2 id="confirmationName">Confirma√ß√£o de Cadastro</h2>
      <p>Voc√™ est√° prestes a cadastrar:</p>
      <h3 id="confirmationCandidateName" style="color: #d4af37; margin: 10px 0 20px;"></h3>
      <p id="confirmationPosition" style="margin-bottom: 20px;"></p>
      <p>Tem certeza de que deseja confirmar o cadastro?</p>
      <div class="confirmation-buttons">
        <button id="confirmCadastroButton" class="confirm-button">Sim, confirmar cadastro</button>
        <button onclick="fecharTelaConfirmacao()" class="cancel-button">Cancelar</button>
      </div>
    </div>
  </div>

  <div id="processando"><div>Processando cadastro‚Ä¶</div></div>

<script>
// Inicializar o banco de dados local
const localDB = new PouchDB('terra_dourada_candidates');

// Elementos da interface
const photoInput = document.getElementById('photoInput');
const photoPreview = document.getElementById('photoPreview');
const nameInput = document.getElementById('nameInput');
const positionInput = document.getElementById('positionInput');
const bioInput = document.getElementById('bioInput');
const registerButton = document.getElementById('registerButton');
const successMessage = document.getElementById('successMessage');
const backButton = document.getElementById('backButton');
const formContainer = document.getElementById('formContainer');

// Vari√°veis para armazenar dados
let photoBase64 = null;
let candidateData = null;

// Fun√ß√£o para pr√©-visualizar a foto selecionada
photoInput.addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(event) {
      photoBase64 = event.target.result;
      photoPreview.innerHTML = `<img src="${photoBase64}" alt="Foto do candidato">`;
    };
    reader.readAsDataURL(file);
  }
});

// ==============================
// SHA-256 (igual ao do voto)
// ==============================
async function sha256Base64(dataURL) {
  const base64 = dataURL.split(",")[1];
  const bytes = Uint8Array.from(atob(base64), c => c.charCodeAt(0));
  const hashBuffer = await crypto.subtle.digest("SHA-256", bytes);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
}

// ==============================
// Capturar print da tela de confirma√ß√£o
// ==============================
async function capturarPrint() {
  const elemento = document.getElementById("confirmationCard");
  const canvas = await html2canvas(elemento);
  return canvas.toDataURL("image/png");
}

// ==============================
// Fun√ß√µes para a tela de confirma√ß√£o
// ==============================
function abrirTelaConfirmacao(dadosCandidato) {
  candidateData = dadosCandidato;
  
  // Preencher informa√ß√µes na tela de confirma√ß√£o
  document.getElementById('confirmationImage').src = dadosCandidato.photo;
  document.getElementById('confirmationCandidateName').textContent = dadosCandidato.name;
  document.getElementById('confirmationPosition').textContent = `Cargo: ${dadosCandidato.position}`;
  
  // Configurar o bot√£o de confirma√ß√£o
  const confirmButton = document.getElementById('confirmCadastroButton');
  confirmButton.onclick = function() {
    confirmarCadastro();
  };
  
  // Mostrar a tela de confirma√ß√£o
  document.getElementById('confirmationScreen').style.display = 'flex';
  formContainer.style.display = 'none';
}

function fecharTelaConfirmacao() {
  document.getElementById('confirmationScreen').style.display = 'none';
  formContainer.style.display = 'block';
  candidateData = null;
}

// ==============================
// Confirmar cadastro (com screenshot e hash)
// ==============================
async function confirmarCadastro() {
  document.getElementById("processando").style.display = "flex";

  try {
    // ‚úÖ CAPTURA SCREENSHOT DA TELA DE CONFIRMA√á√ÉO
    const printBase64 = await capturarPrint();
    const hashPrint = await sha256Base64(printBase64);
    
    console.log("üì∏ Screenshot do cadastro capturada. Hash: " + hashPrint);

    // Criar um ID √∫nico baseado no timestamp
    const candidateId = `candidate_${Date.now()}`;
    
    // Criar o documento do candidato COM O HASH DO SCREENSHOT
    const candidate = {
      _id: candidateId,
      name: candidateData.name,
      position: candidateData.position,
      bio: candidateData.bio,
      photo: candidateData.photo,
      screenshot_hash: hashPrint, // ‚úÖ HASH DO SCREENSHOT INCLU√çDO
      timestamp: new Date().toISOString()
    };
    
    // Salvar no banco de dados local
    await localDB.put(candidate);
    
    console.log("üíæ Candidato cadastrado COM HASH:", candidate);

    // Mostrar mensagem de sucesso
    document.getElementById("processando").style.display = "none";
    successMessage.style.display = 'block';
    
    // Limpar o formul√°rio
    nameInput.value = '';
    positionInput.value = '';
    bioInput.value = '';
    photoPreview.innerHTML = '<i class="fas fa-user"></i>';
    photoBase64 = null;
    
    // Voltar para o formul√°rio
    fecharTelaConfirmacao();
    
    // Esconder a mensagem ap√≥s alguns segundos
    setTimeout(() => {
      successMessage.style.display = 'none';
    }, 5000);
    
  } catch (error) {
    console.error('Erro ao cadastrar candidato:', error);
    document.getElementById("processando").style.display = "none";
    alert('Erro ao cadastrar candidato. Tente novamente.');
  }
}

// ==============================
// Evento do bot√£o de cadastro
// ==============================
registerButton.addEventListener('click', function() {
  const name = nameInput.value.trim();
  const position = positionInput.value.trim();
  const bio = bioInput.value.trim();
  
  // Valida√ß√£o b√°sica
  if (!name || !position) {
    alert('Por favor, preencha pelo menos o nome e o cargo do candidato.');
    return;
  }
  
  if (!photoBase64) {
    alert('Por favor, selecione uma foto para o candidato.');
    return;
  }
  
  // Preparar dados do candidato
  const dadosCandidato = {
    name: name,
    position: position,
    bio: bio,
    photo: photoBase64
  };
  
  // Abrir tela de confirma√ß√£o (que ser√° printada)
  abrirTelaConfirmacao(dadosCandidato);
});

// Voltar para a tela de login
backButton.addEventListener('click', function() {
  window.location.href = 'login.html';
});
</script>
</body>
</html>