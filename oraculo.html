<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåç Or√°culo Terra Dourada - Multi-Protocolo</title>
    <script src="https://cdn.jsdelivr.net/npm/pouchdb@7.3.1/dist/pouchdb.min.js"></script>
    <style>
        :root {
            --gold: #d4af37;
            --dark-gold: #b8941f;
            --black: #050703;
            --dark-bg: #0f0f0f;
            --darker-bg: #1a1a1a;
            --text: #f5f5f5;
            --text-muted: #cccccc;
            --serial: #4caf50;
            --bluetooth: #2196f3;
            --hid: #9c27b0;
            --usb: #ff9800;
            --wifi: #00bcd4;
            --offline: #795548;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: var(--black);
            color: var(--text);
            font-family: 'Segoe UI', system-ui, sans-serif;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, var(--black) 0%, var(--darker-bg) 100%);
            border-bottom: 2px solid var(--gold);
            margin-bottom: 30px;
        }

        .logo {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .title {
            color: var(--gold);
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .subtitle {
            color: var(--text-muted);
            font-size: 1.2rem;
            margin-bottom: 20px;
        }

        .tagline {
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid var(--gold);
            border-radius: 20px;
            padding: 10px 20px;
            display: inline-block;
            font-size: 0.9rem;
            color: var(--gold);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .tab {
            background: transparent;
            border: 1px solid var(--gold);
            color: var(--gold);
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .tab:hover {
            background: rgba(212, 175, 55, 0.1);
        }

        .tab.active {
            background: var(--gold);
            color: var(--black);
            font-weight: 600;
        }

        /* Content Areas */
        .content {
            background: var(--darker-bg);
            border-radius: 15px;
            padding: 30px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            margin-bottom: 20px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--dark-bg);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-header {
            color: var(--gold);
            font-size: 1.3rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Protocol Cards */
        .protocol-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .protocol-card {
            background: rgba(212, 175, 55, 0.05);
            border: 2px solid;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .protocol-card:hover {
            transform: translateY(-2px);
            background: rgba(212, 175, 55, 0.1);
        }

        .protocol-card.serial { border-color: var(--serial); }
        .protocol-card.bluetooth { border-color: var(--bluetooth); }
        .protocol-card.hid { border-color: var(--hid); }
        .protocol-card.usb { border-color: var(--usb); }
        .protocol-card.wifi { border-color: var(--wifi); }
        .protocol-card.offline { border-color: var(--offline); }

        .protocol-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .protocol-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .protocol-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-top: 8px;
        }

        .status-online { background: rgba(76, 175, 80, 0.2); color: #4caf50; border: 1px solid #4caf50; }
        .status-offline { background: rgba(244, 67, 54, 0.2); color: #f44336; border: 1px solid #f44336; }
        .status-connecting { background: rgba(255, 193, 7, 0.2); color: #ffc107; border: 1px solid #ffc107; }

        /* Status Indicators */
        .status {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status.online {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
            border: 1px solid #4caf50;
        }

        .status.offline {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
            border: 1px solid #f44336;
        }

        .status.processing {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border: 1px solid #ffc107;
        }

        /* Buttons */
        .btn {
            background: rgba(212, 175, 55, 0.2);
            border: 1px solid var(--gold);
            color: var(--gold);
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            margin: 5px;
        }

        .btn:hover {
            background: rgba(212, 175, 55, 0.4);
        }

        .btn-primary {
            background: var(--gold);
            color: var(--black);
            font-weight: 600;
        }

        .btn-primary:hover {
            background: var(--dark-gold);
        }

        .btn-serial { background: rgba(76, 175, 80, 0.2); border-color: var(--serial); color: var(--serial); }
        .btn-bluetooth { background: rgba(33, 150, 243, 0.2); border-color: var(--bluetooth); color: var(--bluetooth); }
        .btn-hid { background: rgba(156, 39, 176, 0.2); border-color: var(--hid); color: var(--hid); }
        .btn-usb { background: rgba(255, 152, 0, 0.2); border-color: var(--usb); color: var(--usb); }
        .btn-wifi { background: rgba(0, 188, 212, 0.2); border-color: var(--wifi); color: var(--wifi); }

        /* Data Display */
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .data-item {
            background: rgba(212, 175, 55, 0.05);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 8px;
            padding: 15px;
        }

        .data-label {
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-bottom: 5px;
        }

        .data-value {
            color: var(--gold);
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 1000;
        }

        /* Protocol Console */
        .protocol-console {
            background: var(--black);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-family: monospace;
            font-size: 0.8rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .console-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-left: 3px solid var(--gold);
            background: rgba(212, 175, 55, 0.05);
        }

        .console-time {
            color: var(--text-muted);
            font-size: 0.7rem;
        }

        .export-section {
            background: rgba(212, 175, 55, 0.05);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .hash-preview {
            font-family: monospace;
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        /* üî• NOVO CSS: Sistema de Confirma√ß√µes */
        .cid-link {
            color: var(--gold);
            text-decoration: none;
            font-family: monospace;
            background: rgba(212, 175, 55, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
            display: inline-block;
            margin: 2px;
            font-size: 0.8rem;
        }

        .cid-link:hover {
            background: rgba(212, 175, 55, 0.2);
            transform: translateY(-1px);
            text-decoration: underline;
        }

        .confirmacao-item {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .confirmacao-item:hover {
            background: rgba(76, 175, 80, 0.15);
            transform: translateX(5px);
        }

        .pendente-item {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 8px;
        }

        .status-confirmado { background: rgba(76, 175, 80, 0.2); color: #4caf50; }
        .status-pendente { background: rgba(255, 193, 7, 0.2); color: #ffc107; }
        .status-falha { background: rgba(244, 67, 54, 0.2); color: #f44336; }

        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal-content {
            background: var(--darker-bg);
            border: 2px solid var(--gold);
            border-radius: 15px;
            padding: 20px;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            width: 500px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            opacity: 0.6;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .title {
                font-size: 2rem;
            }
            
            .tabs {
                flex-direction: column;
                align-items: center;
            }
            
            .tab {
                width: 100%;
                max-width: 300px;
            }
            
            .content {
                padding: 20px;
            }
            
            .protocol-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status status online">
        ‚óè ONLINE
    </div>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">üåç</div>
            <h1 class="title">Or√°culo Terra Dourada</h1>
            <p class="subtitle">Multi-Protocolo ‚Ä¢ Soberania de Dados ‚Ä¢ Ledger Obrigat√≥rio</p>
            <div class="tagline">Conectado ao Mundo Externo - Serial, Bluetooth, HID, USB, WiFi</div>
        </header>

        <!-- Navigation Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="showTab('confirmacoes')">‚úÖ Confirma√ß√µes</button>
            <button class="tab" onclick="showTab('protocolos')">üîå Protocolos</button>
            <button class="tab" onclick="showTab('ledger')">üîó Ledger</button>
            <button class="tab" onclick="showTab('provas')">üîê Provas</button>
            <button class="tab" onclick="showTab('dados')">üì¶ Dados</button>
            <button class="tab" onclick="showTab('export')">üì§ Exportar</button>
        </div>

        <!-- Tab Contents -->
        <div class="content">
            <!-- Dashboard Tab -->
            <div id="tab-dashboard" class="tab-content active">
                <div class="controls">
                    <button onclick="atualizarDashboard()">üìä Atualizar Dashboard</button>
                    <button id="btnVerPendentes" class="btn" onclick="mostrarPendentes()" style="display: none;">
                        üìã Ver Pendentes (0)
                    </button>
                    <button onclick="processarFilaPendentes()">üîÑ Sincronizar Agora</button>
                    <button onclick="exportarDadosCompletos()">üì§ Exportar Tudo</button>
                </div>

                <div class="card">
                    <div class="card-header">üìä Status do Sistema Multi-Protocolo</div>
                    <div class="data-grid">
                        <div class="data-item">
                            <div class="data-label">Status Global</div>
                            <div class="data-value" id="statusGlobal">Online</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Protocolos Ativos</div>
                            <div class="data-value" id="protocolosAtivos">0/6</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Dados Recebidos</div>
                            <div class="data-value" id="totalDadosRecebidos">0</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Fila Offline</div>
                            <div class="data-value" id="filaOffline">0 pendentes</div>
                        </div>
                    </div>
                </div>

                <!-- üî• NOVA SE√á√ÉO: Status de Envios -->
                <div class="card">
                    <div class="card-header">üì® Status de Envios & Confirma√ß√µes</div>
                    <div class="data-grid">
                        <div class="data-item">
                            <div class="data-label">Envios Confirmados</div>
                            <div class="data-value" id="countConfirmados">0</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Pendentes de Envio</div>
                            <div class="data-value" id="countPendentes">0</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">√öltimo CID</div>
                            <div class="data-value" id="ultimoCID">Nenhum</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Status Conex√£o</div>
                            <div class="data-value" id="statusConexao">Online</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">üöÄ Conex√µes Ativas</div>
                    <div id="conexoesAtivas">
                        <div class="ledger-entry">
                            <div>Nenhuma conex√£o ativa</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">üìà Atividade Recente</div>
                    <div id="atividadeRecente">
                        <div class="ledger-entry">
                            <div>Nenhuma atividade recente</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- üî• NOVA ABA: Confirma√ß√µes -->
            <div id="tab-confirmacoes" class="tab-content">
                <div class="card">
                    <div class="card-header">‚úÖ Envios Confirmados com CID</div>
                    <p style="color: var(--text-muted); margin-bottom: 15px;">
                        Todos os envios confirmados com CID/IPFS Hash. Clique nos links para verificar.
                    </p>
                    
                    <div class="controls">
                        <button class="btn btn-primary" onclick="carregarConfirmacoes()">
                            üîÑ Atualizar Lista
                        </button>
                        <button class="btn" onclick="exportarConfirmacoes()">
                            üíæ Exportar Confirma√ß√µes
                        </button>
                    </div>

                    <div id="listaConfirmacoes" style="margin-top: 20px;">
                        <div class="empty-state">
                            <i>üì≠</i>
                            Nenhuma confirma√ß√£o carregada
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">üìã Pendentes de Envio</div>
                    <div id="listaPendentes">
                        <div class="empty-state">
                            <i>üì¨</i>
                            Nenhum item pendente
                        </div>
                    </div>
                </div>
            </div>

            <!-- Protocolos Tab -->
            <div id="tab-protocolos" class="tab-content">
                <div class="card">
                    <div class="card-header">üîå Protocolos de Comunica√ß√£o</div>
                    <p style="color: var(--text-muted); margin-bottom: 20px;">
                        Conecte seu Or√°culo a dispositivos externos atrav√©s de m√∫ltiplos protocolos.
                    </p>
                    
                    <div class="protocol-grid">
                        <!-- Web Serial -->
                        <div class="protocol-card serial" onclick="iniciarWebSerial()">
                            <div class="protocol-icon">üì°</div>
                            <div class="protocol-title">Web Serial</div>
                            <div class="protocol-desc">Dispositivos RS-232, Arduino, ESP32</div>
                            <div class="protocol-status status-offline" id="statusSerial">OFFLINE</div>
                        </div>

                        <!-- Web Bluetooth -->
                        <div class="protocol-card bluetooth" onclick="iniciarWebBluetooth()">
                            <div class="protocol-icon">üì±</div>
                            <div class="protocol-title">Web Bluetooth</div>
                            <div class="protocol-desc">Sensores BLE, Beacons, Dispositivos IoT</div>
                            <div class="protocol-status status-offline" id="statusBluetooth">OFFLINE</div>
                        </div>

                        <!-- WebHID -->
                        <div class="protocol-card hid" onclick="iniciarWebHID()">
                            <div class="protocol-icon">‚å®Ô∏è</div>
                            <div class="protocol-title">WebHID</div>
                            <div class="protocol-desc">Human Interface Devices</div>
                            <div class="protocol-status status-offline" id="statusHID">OFFLINE</div>
                        </div>

                        <!-- WebUSB -->
                        <div class="protocol-card usb" onclick="iniciarWebUSB()">
                            <div class="protocol-icon">üîå</div>
                            <div class="protocol-title">WebUSB</div>
                            <div class="protocol-desc">Dispositivos USB customizados</div>
                            <div class="protocol-status status-offline" id="statusUSB">OFFLINE</div>
                        </div>

                        <!-- WiFi Local -->
                        <div class="protocol-card wifi" onclick="iniciarWiFiPolling()">
                            <div class="protocol-icon">üì∂</div>
                            <div class="protocol-title">WiFi Local</div>
                            <div class="protocol-desc">Polling autom√°tico de APIs locais</div>
                            <div class="protocol-status status-offline" id="statusWiFi">OFFLINE</div>
                        </div>

                        <!-- Fila Offline -->
                        <div class="protocol-card offline" onclick="gerenciarFilaOffline()">
                            <div class="protocol-icon">üíæ</div>
                            <div class="protocol-title">Fila Offline</div>
                            <div class="protocol-desc">Sync autom√°tico quando online</div>
                            <div class="protocol-status status-online" id="statusOffline">ATIVO</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">üîÑ Console de Protocolos</div>
                    <div class="protocol-console" id="protocolConsole">
                        <div class="console-entry">
                            <span class="console-time">[00:00:00]</span> Sistema multi-protocolo inicializado
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ledger Tab -->
            <div id="tab-ledger" class="tab-content">
                <div class="card">
                    <div class="card-header">üîó Ledger Obrigat√≥rio Multi-Fonte</div>
                    <p style="color: var(--text-muted); margin-bottom: 15px;">
                        <strong>TODOS os dados de TODOS os protocolos s√£o registrados no Ledger.</strong>
                    </p>
                    
                    <div id="ledgerEntries">
                        <div class="ledger-entry">
                            <div>Ledger inicializado. Aguardando dados multi-protocolo...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Provas Tab -->
            <div id="tab-provas" class="tab-content">
                <div class="card">
                    <div class="card-header">üîê Sistema de Provas Multi-Fonte</div>
                    
                    <div class="form-group">
                        <label class="form-label">Dados para Gerar Prova</label>
                        <textarea id="dadosProva" class="form-input" rows="4" 
                                  placeholder='{"tipo": "preco", "valor": 100, "moeda": "BTC"}'></textarea>
                    </div>

                    <button class="btn btn-primary" onclick="gerarProvaComDados()">
                        üîê Gerar Prova Real
                    </button>

                    <div id="statusProva" style="margin-top: 15px;"></div>
                </div>

                <div class="card">
                    <div class="card-header">üìú Provas Geradas</div>
                    <div id="listaProvas">
                        <div class="ledger-entry">
                            <div>Nenhuma prova gerada ainda</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dados Tab -->
            <div id="tab-dados" class="tab-content">
                <div class="card">
                    <div class="card-header">üì¶ Dados Multi-Fonte</div>
                    
                    <div class="form-group">
                        <label class="form-label">Novo Dado Manual (JSON)</label>
                        <textarea id="novoDado" class="form-input" rows="3" 
                                  placeholder='{"tipo": "sensor", "valor": 25.5, "unidade": "C"}'></textarea>
                    </div>

                    <button class="btn btn-primary" onclick="adicionarDado()">
                        üíæ Salvar + Ledger
                    </button>
                </div>

                <div class="card">
                    <div class="card-header">üìã Dados Recebidos</div>
                    <div id="listaDados">
                        <div class="ledger-entry">
                            <div>Nenhum dado recebido</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Export Tab -->
            <div id="tab-export" class="tab-content">
                <div class="card">
                    <div class="card-header">üì§ Exportar Dados Multi-Protocolo</div>
                    
                    <div class="export-section">
                        <h3 style="color: var(--gold); margin-bottom: 15px;">üîó Exportar Ledger Completo</h3>
                        <button class="btn btn-primary" onclick="exportarLedgerTXT()">
                            üíæ Exportar Ledger.txt
                        </button>
                        <button class="btn btn-primary" onclick="exportarDadosCompletos()">
                            üìÅ Exportar Backup Completo
                        </button>
                    </div>

                    <div class="export-section">
                        <h3 style="color: var(--gold); margin-bottom: 15px;">üîå Exportar por Protocolo</h3>
                        <button class="btn btn-serial" onclick="exportarDadosSerial()">üì° Dados Serial</button>
                        <button class="btn btn-bluetooth" onclick="exportarDadosBluetooth()">üì± Dados Bluetooth</button>
                        <button class="btn btn-hid" onclick="exportarDadosHID()">‚å®Ô∏è Dados HID</button>
                        <button class="btn btn-usb" onclick="exportarDadosUSB()">üîå Dados USB</button>
                        <button class="btn btn-wifi" onclick="exportarDadosWiFi()">üì∂ Dados WiFi</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== BANCOS DE DADOS ====================
        const dbDados = new PouchDB('terra_dourada_dados');
        const dbLedger = new PouchDB('terra_dourada_ledger');
        const dbProvas = new PouchDB('terra_dourada_provas');
        const dbFilaOffline = new PouchDB('terra_dourada_fila');
        const dbEnvios = new PouchDB('terra_dourada_envios_confirmados');

        // ==================== ESTADO DA APLICA√á√ÉO ====================
        let estadoApp = {
            online: navigator.onLine,
            lastHash: 'genesis',
            protocolosAtivos: 0,
            dadosRecebidos: 0,
            conexoes: {}
        };

        let sistemaEnvio = {
            enviando: false,
            ultimoCID: null,
            filaPendentes: 0,
            IPFS_GATEWAY: "https://ipfs.io/ipfs/"
        };

        // ==================== INICIALIZA√á√ÉO ====================
        document.addEventListener('DOMContentLoaded', function() {
            inicializarApp();
            atualizarDashboard();
            verificarConexao();
            iniciarFilaOffline();
            
            // üî• NOVO: Inicializar sistema de confirma√ß√µes
            setTimeout(() => {
                atualizarContadorPendentes();
                atualizarStatusEnvios();
            }, 1000);
            
            // Processar pendentes a cada 30 segundos (quando online)
            setInterval(() => {
                if (estadoApp.online && sistemaEnvio.filaPendentes > 0 && !sistemaEnvio.enviando) {
                    processarFilaPendentes();
                }
            }, 30000);
            
            console.log('üåç Or√°culo Terra Dourada Multi-Protocolo inicializado!');
        });

        // ==================== SISTEMA DE CONFIRMA√á√ÉO COM CID ====================

        // ‚úÖ FUN√á√ÉO PRINCIPAL: Enviar dados com confirma√ß√£o de CID
        async function enviarDadosComConfirmacao(dados, tipo = 'dado_externo') {
            try {
                // Verificar se j√° foi enviado (preven√ß√£o de duplica√ß√£o)
                const jaEnviado = await verificarSeJaEnviado(dados);
                if (jaEnviado) {
                    console.log('üì≠ Dado j√° enviado anteriormente, ignorando...');
                    return { sucesso: true, cid: jaEnviado.cid, status: 'ja_enviado' };
                }

                // Se offline, salvar na fila
                if (!estadoApp.online) {
                    return await salvarNaFilaOffline(dados, tipo);
                }

                // Tentar envio para o backend
                const resultado = await enviarParaBackend(dados);
                
                if (resultado.sucesso && resultado.cid) {
                    // ‚úÖ SUCESSO: Salvar confirma√ß√£o com CID
                    await salvarConfirmacaoEnvio(dados, resultado.cid, tipo);
                    sistemaEnvio.ultimoCID = resultado.cid;
                    
                    // Atualizar UI
                    await atualizarStatusEnvios();
                    await atualizarContadorPendentes();
                    
                    adicionarLogProtocolo('ENVIO', `‚úÖ Enviado com sucesso! CID: ${resultado.cid.substring(0, 20)}...`);
                    return resultado;
                } else {
                    // ‚ùå FALHA: Salvar na fila para retentar depois
                    throw new Error('Backend n√£o retornou CID v√°lido');
                }

            } catch (error) {
                console.error('‚ùå Erro no envio:', error);
                
                // Salvar na fila offline para retentar depois
                const resultadoFila = await salvarNaFilaOffline(dados, tipo);
                adicionarLogProtocolo('ENVIO', `üíæ Salvo na fila offline: ${error.message}`);
                
                return resultadoFila;
            }
        }

        // ‚úÖ VERIFICAR se dado j√° foi enviado (preven√ß√£o de duplica√ß√£o)
        async function verificarSeJaEnviado(dados) {
            try {
                // Criar hash √∫nico dos dados para verifica√ß√£o
                const hashDados = await calcularHash(JSON.stringify(dados));
                
                // Buscar no banco de envios confirmados
                const resultado = await dbEnvios.allDocs({
                    include_docs: true,
                    startkey: 'envio_',
                    endkey: 'envio_\uffff'
                });

                // Verificar se algum envio tem o mesmo hash de dados
                const envioExistente = resultado.rows.find(row => 
                    row.doc.hashDados === hashDados && row.doc.cid
                );

                return envioExistente ? envioExistente.doc : null;
            } catch (error) {
                console.error('Erro ao verificar envio:', error);
                return null;
            }
        }

        // ‚úÖ SALVAR confirma√ß√£o de envio com CID
        async function salvarConfirmacaoEnvio(dados, cid, tipo) {
            const hashDados = await calcularHash(JSON.stringify(dados));
            
            const confirmacao = {
                _id: `envio_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,
                timestamp: new Date().toISOString(),
                cid: cid,
                hashDados: hashDados,
                tipo: tipo,
                dados: dados,
                status: 'confirmado',
                protocolo: dados.protocolo || 'manual',
                linkIPFS: `${sistemaEnvio.IPFS_GATEWAY}${cid}`
            };

            await dbEnvios.put(confirmacao);
            return confirmacao;
        }

        // ‚úÖ SALVAR na fila offline (quando n√£o h√° conex√£o)
        async function salvarNaFilaOffline(dados, tipo) {
            const hashDados = await calcularHash(JSON.stringify(dados));
            
            const itemFila = {
                _id: `fila_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,
                timestamp: new Date().toISOString(),
                hashDados: hashDados,
                tipo: tipo,
                dados: dados,
                status: 'pendente',
                tentativas: 0,
                protocolo: dados.protocolo || 'manual'
            };

            await dbFilaOffline.put(itemFila);
            await atualizarContadorPendentes();
            
            return { 
                sucesso: false, 
                status: 'salvo_na_fila',
                mensagem: 'Dado salvo na fila offline para envio posterior'
            };
        }

        // ‚úÖ PROCESSAR fila de pendentes (quando conex√£o voltar)
        async function processarFilaPendentes() {
            if (sistemaEnvio.enviando) {
                console.log('üîÑ J√° processando fila...');
                return;
            }

            sistemaEnvio.enviando = true;
            adicionarLogProtocolo('FILA', 'üîÑ Iniciando sincroniza√ß√£o de pendentes...');
            
            try {
                const pendentes = await dbFilaOffline.allDocs({ include_docs: true });
                if (pendentes.rows.length === 0) {
                    adicionarLogProtocolo('FILA', 'üì≠ Nenhum item pendente na fila');
                    return;
                }

                adicionarLogProtocolo('FILA', `üì¶ Processando ${pendentes.rows.length} itens pendentes...`);

                let sucessos = 0;
                let erros = 0;

                for (const row of pendentes.rows) {
                    try {
                        // Verificar se j√° foi enviado (dupla verifica√ß√£o)
                        const jaEnviado = await verificarSeJaEnviado(row.doc.dados);
                        if (jaEnviado) {
                            // J√° foi enviado, remover da fila
                            await dbFilaOffline.remove(row.doc);
                            adicionarLogProtocolo('FILA', `‚úÖ J√° enviado: ${jaEnviado.cid.substring(0, 20)}...`);
                            sucessos++;
                            continue;
                        }

                        // Tentar enviar
                        const resultado = await enviarParaBackend(row.doc.dados);
                        
                        if (resultado.sucesso && resultado.cid) {
                            // ‚úÖ SUCESSO: Salvar confirma√ß√£o e remover da fila
                            await salvarConfirmacaoEnvio(row.doc.dados, resultado.cid, row.doc.tipo);
                            await dbFilaOffline.remove(row.doc);
                            
                            adicionarLogProtocolo('FILA', `‚úÖ Enviado: CID ${resultado.cid.substring(0, 20)}...`);
                            sucessos++;
                        } else {
                            // ‚ùå FALHA: Incrementar tentativas
                            row.doc.tentativas = (row.doc.tentativas || 0) + 1;
                            row.doc.ultimoErro = resultado.mensagem || 'Erro desconhecido';
                            
                            if (row.doc.tentativas >= 5) {
                                // Muitas tentativas, marcar como falha permanente
                                row.doc.status = 'falha_permanente';
                                adicionarLogProtocolo('FILA', `‚ùå Falha permanente ap√≥s 5 tentativas: ${row.doc.ultimoErro}`);
                            }
                            
                            await dbFilaOffline.put(row.doc);
                            erros++;
                        }

                    } catch (error) {
                        console.error(`Erro processando item ${row.id}:`, error);
                        erros++;
                    }
                }

                adicionarLogProtocolo('FILA', `üìä Sincroniza√ß√£o conclu√≠da: ${sucessos} sucessos, ${erros} erros`);
                await atualizarContadorPendentes();
                await atualizarStatusEnvios();

            } catch (error) {
                console.error('Erro geral ao processar fila:', error);
                adicionarLogProtocolo('FILA', `‚ùå Erro no processamento: ${error.message}`);
            } finally {
                sistemaEnvio.enviando = false;
            }
        }

        // ‚úÖ ATUALIZAR contador de pendentes na UI
        async function atualizarContadorPendentes() {
            try {
                const pendentes = await dbFilaOffline.allDocs({ include_docs: false });
                sistemaEnvio.filaPendentes = pendentes.rows.length;
                
                // Atualizar na interface
                const elementoPendentes = document.getElementById('countPendentes');
                const botaoPendentes = document.getElementById('btnVerPendentes');
                
                if (elementoPendentes) {
                    elementoPendentes.textContent = pendentes.rows.length;
                }
                
                if (botaoPendentes) {
                    if (pendentes.rows.length > 0) {
                        botaoPendentes.innerHTML = `üìã Ver Pendentes (${pendentes.rows.length})`;
                        botaoPendentes.style.display = 'inline-block';
                    } else {
                        botaoPendentes.style.display = 'none';
                    }
                }

            } catch (error) {
                console.error('Erro ao atualizar contador:', error);
            }
        }

        // ‚úÖ ATUALIZAR status geral de envios
        async function atualizarStatusEnvios() {
            try {
                const [confirmados, pendentes] = await Promise.all([
                    dbEnvios.allDocs({ include_docs: false }),
                    dbFilaOffline.allDocs({ include_docs: false })
                ]);

                // Atualizar contadores
                const countConfirmados = document.getElementById('countConfirmados');
                const countPendentes = document.getElementById('countPendentes');
                const statusConexao = document.getElementById('statusConexao');
                const ultimoCID = document.getElementById('ultimoCID');
                
                if (countConfirmados) countConfirmados.textContent = confirmados.rows.length;
                if (countPendentes) countPendentes.textContent = pendentes.rows.length;
                if (statusConexao) statusConexao.textContent = estadoApp.online ? 'üü¢ Online' : 'üî¥ Offline';
                if (ultimoCID) {
                    ultimoCID.textContent = sistemaEnvio.ultimoCID 
                        ? `${sistemaEnvio.ultimoCID.substring(0, 20)}...` 
                        : 'Nenhum';
                }

            } catch (error) {
                console.error('Erro ao atualizar status:', error);
            }
        }

        // ‚úÖ ENVIAR para backend (fun√ß√£o simulada - adapte para seu backend real)
        async function enviarParaBackend(dados) {
            try {
                // üîÑ ADAPTE ESTA PARTE PARA SEU BACKEND REAL
                const payload = {
                    dados: dados,
                    timestamp: new Date().toISOString(),
                    tipo: 'oraculo_multi_protocolo'
                };

                // Simula√ß√£o de envio para backend que retorna CID
                const response = await fetch('https://seu-backend.com/api/dados', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const resultado = await response.json();
                
                // ‚ö†Ô∏è SEU BACKEND DEVE RETORNAR UM CID/IPFS_HASH
                return {
                    sucesso: true,
                    cid: resultado.cid || resultado.IpfsHash || resultado.hash,
                    mensagem: 'Enviado com sucesso'
                };

            } catch (error) {
                return {
                    sucesso: false,
                    mensagem: error.message,
                    cid: null
                };
            }
        }

        // ==================== INTERFACE DO USU√ÅRIO ====================

        // ‚úÖ MODAL para mostrar pendentes
        function mostrarPendentes() {
            // Criar modal
            const modal = document.createElement('div');
            modal.className = 'modal-backdrop';
            
            modal.innerHTML = `
                <div class="modal-content">
                    <h3 style="color: var(--gold); margin-bottom: 15px;">
                        üìã Dados Pendentes de Envio (${sistemaEnvio.filaPendentes})
                    </h3>
                    <div id="listaPendentesModal" style="max-height: 400px; overflow-y: auto;"></div>
                    <div style="margin-top: 15px; text-align: center;">
                        <button class="btn btn-primary" onclick="processarFilaPendentes()">
                            üîÑ Tentar Enviar Tudo
                        </button>
                        <button class="btn" onclick="this.closest('.modal-backdrop').remove()">
                            Fechar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            carregarListaPendentesModal();
        }

        // ‚úÖ CARREGAR lista de pendentes no modal
        async function carregarListaPendentesModal() {
            const container = document.getElementById('listaPendentesModal');
            
            try {
                const pendentes = await dbFilaOffline.allDocs({ include_docs: true });
                
                if (pendentes.rows.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-muted);">üéâ Nenhum dado pendente!</p>';
                    return;
                }

                container.innerHTML = pendentes.rows.map(row => `
                    <div class="pendente-item">
                        <div><strong>Protocolo:</strong> ${row.doc.protocolo || 'N/A'}</div>
                        <div><strong>Tipo:</strong> ${row.doc.tipo}</div>
                        <div><strong>Timestamp:</strong> ${new Date(row.doc.timestamp).toLocaleString()}</div>
                        <div><strong>Tentativas:</strong> ${row.doc.tentativas || 0}</div>
                        ${row.doc.ultimoErro ? `<div><strong>√öltimo Erro:</strong> ${row.doc.ultimoErro}</div>` : ''}
                        <div style="margin-top: 8px;">
                            <button class="btn" onclick="reenviarItemUnico('${row.id}')" style="padding: 5px 10px; font-size: 0.8rem;">
                                üîÑ Reenviar Este Item
                            </button>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                container.innerHTML = `<p style="color: red;">Erro ao carregar pendentes: ${error.message}</p>`;
            }
        }

        // ‚úÖ CARREGAR confirma√ß√µes na aba dedicada
        async function carregarConfirmacoes() {
            const container = document.getElementById('listaConfirmacoes');
            
            try {
                const confirmacoes = await dbEnvios.allDocs({ include_docs: true });
                
                if (confirmacoes.rows.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i>üì≠</i>
                            Nenhuma confirma√ß√£o encontrada
                        </div>
                    `;
                    return;
                }

                // Ordenar por timestamp (mais recente primeiro)
                const confirmacoesOrdenadas = confirmacoes.rows
                    .map(row => row.doc)
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                container.innerHTML = confirmacoesOrdenadas.map(doc => `
                    <div class="confirmacao-item">
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 8px;">
                            <strong>${doc.protocolo.toUpperCase()} - ${doc.tipo}</strong>
                            <span class="status-badge status-confirmado">CONFIRMADO</span>
                        </div>
                        <div><strong>CID:</strong> 
                            <a href="${doc.linkIPFS}" target="_blank" class="cid-link" title="Abrir no IPFS">
                                ${doc.cid.substring(0, 30)}...
                            </a>
                        </div>
                        <div><strong>Timestamp:</strong> ${new Date(doc.timestamp).toLocaleString()}</div>
                        <div><strong>Hash Dados:</strong> <span class="hash-preview">${doc.hashDados.substring(0, 20)}...</span></div>
                    </div>
                `).join('');

            } catch (error) {
                container.innerHTML = `<div style="color: red; text-align: center;">Erro ao carregar confirma√ß√µes: ${error.message}</div>`;
            }
        }

        // ‚úÖ CARREGAR pendentes na aba de confirma√ß√µes
        async function carregarPendentesConfirmacoes() {
            const container = document.getElementById('listaPendentes');
            
            try {
                const pendentes = await dbFilaOffline.allDocs({ include_docs: true });
                
                if (pendentes.rows.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i>üì¨</i>
                            Nenhum item pendente
                        </div>
                    `;
                    return;
                }

                container.innerHTML = pendentes.rows.map(row => `
                    <div class="pendente-item">
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 8px;">
                            <strong>${row.doc.protocolo.toUpperCase()} - ${row.doc.tipo}</strong>
                            <span class="status-badge status-pendente">PENDENTE</span>
                        </div>
                        <div><strong>Timestamp:</strong> ${new Date(row.doc.timestamp).toLocaleString()}</div>
                        <div><strong>Tentativas:</strong> ${row.doc.tentativas || 0}</div>
                        ${row.doc.ultimoErro ? `<div><strong>√öltimo Erro:</strong> ${row.doc.ultimoErro}</div>` : ''}
                    </div>
                `).join('');

            } catch (error) {
                container.innerHTML = `<div style="color: red; text-align: center;">Erro ao carregar pendentes: ${error.message}</div>`;
            }
        }

        // ‚úÖ REENVIAR item individual
        async function reenviarItemUnico(id) {
            try {
                const doc = await dbFilaOffline.get(id);
                const resultado = await enviarParaBackend(doc.dados);
                
                if (resultado.sucesso && resultado.cid) {
                    await salvarConfirmacaoEnvio(doc.dados, resultado.cid, doc.tipo);
                    await dbFilaOffline.remove(doc);
                    
                    alert(`‚úÖ Enviado com sucesso!\nCID: ${resultado.cid}\n\nClique no link para verificar:`);
                    
                    // Atualizar todas as UIs
                    carregarListaPendentesModal();
                    await atualizarContadorPendentes();
                    await atualizarStatusEnvios();
                    
                    // Fechar modal se n√£o h√° mais pendentes
                    if (sistemaEnvio.filaPendentes === 0) {
                        document.querySelector('.modal-backdrop')?.remove();
                    }
                } else {
                    throw new Error(resultado.mensagem);
                }
            } catch (error) {
                alert(`‚ùå Erro ao reenviar: ${error.message}`);
            }
        }

        // ‚úÖ EXPORTAR confirma√ß√µes
        async function exportarConfirmacoes() {
            try {
                const confirmacoes = await dbEnvios.allDocs({ include_docs: true });
                const dadosExportar = confirmacoes.rows.map(row => row.doc);
                
                const blob = new Blob([JSON.stringify(dadosExportar, null, 2)], {
                    type: 'application/json'
                });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `confirmacoes_envios_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                
                adicionarLogProtocolo('EXPORT', `‚úÖ ${dadosExportar.length} confirma√ß√µes exportadas`);
            } catch (error) {
                alert(`‚ùå Erro ao exportar: ${error.message}`);
            }
        }

        // ==================== SISTEMA MULTI-PROTOCOLO ====================

        // A ‚Äî WEB SERIAL
        async function iniciarWebSerial() {
            try {
                if (!('serial' in navigator)) {
                    throw new Error('Web Serial API n√£o suportada neste navegador');
                }

                adicionarLogProtocolo('SERIAL', 'Solicitando permiss√£o...');
                
                const port = await navigator.serial.requestPort();
                await port.open({ baudRate: 9600 });
                
                estadoApp.conexoes.serial = { port, status: 'conectado' };
                atualizarStatusProtocolo('serial', 'online');
                adicionarLogProtocolo('SERIAL', '‚úÖ Conectado - Baud Rate: 9600');

                // Leitura cont√≠nua
                const reader = port.readable.getReader();
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    const dados = new TextDecoder().decode(value);
                    await processarDadosExternos(dados, 'serial');
                }

            } catch (error) {
                adicionarLogProtocolo('SERIAL', `‚ùå Erro: ${error.message}`);
                atualizarStatusProtocolo('serial', 'offline');
            }
        }

        // B ‚Äî WEB BLUETOOTH
        async function iniciarWebBluetooth() {
            try {
                if (!('bluetooth' in navigator)) {
                    throw new Error('Web Bluetooth API n√£o suportada');
                }

                adicionarLogProtocolo('BLUETOOTH', 'Procurando dispositivos...');
                
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: ['battery_service', 'device_information']
                });

                const server = await device.gatt.connect();
                estadoApp.conexoes.bluetooth = { device, server, status: 'conectado' };
                atualizarStatusProtocolo('bluetooth', 'online');
                adicionarLogProtocolo('BLUETOOTH', `‚úÖ Conectado: ${device.name}`);

                // Monitorar desconex√£o
                device.addEventListener('gattserverdisconnected', () => {
                    adicionarLogProtocolo('BLUETOOTH', '‚ùå Dispositivo desconectado');
                    atualizarStatusProtocolo('bluetooth', 'offline');
                });

            } catch (error) {
                adicionarLogProtocolo('BLUETOOTH', `‚ùå Erro: ${error.message}`);
                atualizarStatusProtocolo('bluetooth', 'offline');
            }
        }

        // C ‚Äî WEB HID
        async function iniciarWebHID() {
            try {
                if (!('hid' in navigator)) {
                    throw new Error('WebHID API n√£o suportada');
                }

                adicionarLogProtocolo('HID', 'Procurando dispositivos HID...');
                
                const devices = await navigator.hid.requestDevice({
                    filters: [] // Todos os dispositivos HID
                });

                if (devices.length === 0) {
                    throw new Error('Nenhum dispositivo HID selecionado');
                }

                const device = devices[0];
                await device.open();
                
                estadoApp.conexoes.hid = { device, status: 'conectado' };
                atualizarStatusProtocolo('hid', 'online');
                adicionarLogProtocolo('HID', `‚úÖ Conectado: ${device.productName}`);

                // Ouvir eventos de entrada
                device.addEventListener('inputreport', event => {
                    const dados = new Uint8Array(event.data.buffer);
                    processarDadosExternos(dados, 'hid');
                });

            } catch (error) {
                adicionarLogProtocolo('HID', `‚ùå Erro: ${error.message}`);
                atualizarStatusProtocolo('hid', 'offline');
            }
        }

        // D ‚Äî WEB USB
        async function iniciarWebUSB() {
            try {
                if (!('usb' in navigator)) {
                    throw new Error('WebUSB API n√£o suportada');
                }

                adicionarLogProtocolo('USB', 'Procurando dispositivos USB...');
                
                const device = await navigator.usb.requestDevice({
                    filters: [] // Todos os dispositivos USB
                });

                await device.open();
                await device.selectConfiguration(1);
                await device.claimInterface(0);
                
                estadoApp.conexoes.usb = { device, status: 'conectado' };
                atualizarStatusProtocolo('usb', 'online');
                adicionarLogProtocolo('USB', `‚úÖ Conectado: ${device.productName}`);

                // Transfer√™ncia de dados
                const result = await device.transferIn(1, 64);
                const dados = new TextDecoder().decode(result.data.buffer);
                await processarDadosExternos(dados, 'usb');

            } catch (error) {
                adicionarLogProtocolo('USB', `‚ùå Erro: ${error.message}`);
                atualizarStatusProtocolo('usb', 'offline');
            }
        }

        // E ‚Äî WIFI LOCAL POLLING
        async function iniciarWiFiPolling() {
            try {
                adicionarLogProtocolo('WIFI', 'Iniciando polling de APIs locais...');
                
                // URLs de APIs locais para polling
                const endpoints = [
                    'http://localhost:3000/api/sensors',
                    'http://192.168.1.100:8080/data',
                    'http://esp32.local/telemetry'
                ];

                estadoApp.conexoes.wifi = { 
                    interval: setInterval(async () => {
                        for (const endpoint of endpoints) {
                            try {
                                const response = await fetch(endpoint);
                                const dados = await response.json();
                                await processarDadosExternos(dados, 'wifi');
                            } catch (error) {
                                adicionarLogProtocolo('WIFI', `‚ùå Erro ${endpoint}: ${error.message}`);
                            }
                        }
                    }, 5000), // Poll a cada 5 segundos
                    status: 'conectado'
                };

                atualizarStatusProtocolo('wifi', 'online');
                adicionarLogProtocolo('WIFI', '‚úÖ Polling ativo - Intervalo: 5s');

            } catch (error) {
                adicionarLogProtocolo('WIFI', `‚ùå Erro: ${error.message}`);
                atualizarStatusProtocolo('wifi', 'offline');
            }
        }

        // F ‚Äî FILA OFFLINE + SYNC AUTOM√ÅTICO
        async function iniciarFilaOffline() {
            adicionarLogProtocolo('OFFLINE', 'Sistema de fila offline ativado');
            
            // Verificar itens pendentes periodicamente
            setInterval(async () => {
                if (estadoApp.online) {
                    await processarFilaOffline();
                }
            }, 10000); // Verificar a cada 10 segundos
        }

        // PROCESSADOR CENTRAL DE DADOS EXTERNOS - ATUALIZADO
        async function processarDadosExternos(dadosBrutos, protocolo) {
            try {
                const timestamp = new Date().toISOString();
                const dadosFormatados = {
                    _id: `dado_${protocolo}_${Date.now()}`,
                    dados: dadosBrutos,
                    protocolo: protocolo,
                    timestamp: timestamp,
                    raw: dadosBrutos
                };

                // 1. Salvar no PouchDB
                await dbDados.put(dadosFormatados);
                
                // 2. Registrar no Ledger OBRIGAT√ìRIO
                await adicionarEntradaLedger(dadosFormatados, `dado_${protocolo}`);
                
                // 3. ‚úÖ NOVO: Enviar com sistema de confirma√ß√£o
                const resultadoEnvio = await enviarDadosComConfirmacao(dadosFormatados, 'dado_externo');
                
                // 4. Atualizar contadores
                estadoApp.dadosRecebidos++;
                await atualizarContadorPendentes();
                await atualizarStatusEnvios();
                
                // 5. Log apropriado baseado no resultado
                if (resultadoEnvio.status === 'ja_enviado') {
                    adicionarLogProtocolo(protocolo.toUpperCase(), 'üì≠ Dado j√° enviado anteriormente (ignorado)');
                } else if (resultadoEnvio.sucesso) {
                    adicionarLogProtocolo(protocolo.toUpperCase(), `‚úÖ Enviado! CID: ${resultadoEnvio.cid.substring(0, 20)}...`);
                } else {
                    adicionarLogProtocolo(protocolo.toUpperCase(), `üíæ Salvo na fila offline: ${resultadoEnvio.mensagem}`);
                }

            } catch (error) {
                adicionarLogProtocolo('ERRO', `Falha ao processar dados ${protocolo}: ${error.message}`);
            }
        }

        // ==================== FUN√á√ïES AUXILIARES ====================

        function adicionarLogProtocolo(protocolo, mensagem) {
            const console = document.getElementById('protocolConsole');
            const entry = document.createElement('div');
            entry.className = 'console-entry';
            entry.innerHTML = `
                <span class="console-time">[${new Date().toLocaleTimeString()}]</span>
                <strong>${protocolo}:</strong> ${mensagem}
            `;
            console.appendChild(entry);
            console.scrollTop = console.scrollHeight;
        }

        function atualizarStatusProtocolo(protocolo, status) {
            const element = document.getElementById(`status${protocolo.charAt(0).toUpperCase() + protocolo.slice(1)}`);
            if (element) {
                element.className = `protocol-status status-${status}`;
                element.textContent = status.toUpperCase();
                
                // Atualizar contador de protocolos ativos
                if (status === 'online') {
                    estadoApp.protocolosAtivos++;
                } else if (status === 'offline' && estadoApp.protocolosAtivos > 0) {
                    estadoApp.protocolosAtivos--;
                }
                atualizarDashboard();
            }
        }

        async function gerenciarFilaOffline() {
            const pendentes = await dbFilaOffline.allDocs({ include_docs: true });
            alert(`Fila Offline: ${pendentes.rows.length} itens pendentes de sync`);
        }

        // ==================== FUN√á√ïES EXISTENTES ATUALIZADAS ====================

        async function inicializarApp() {
            try {
                const ledgerInfo = await dbLedger.get('ledger_info');
                estadoApp.lastHash = ledgerInfo.lastHash;
            } catch (error) {
                await dbLedger.put({
                    _id: 'ledger_info',
                    lastHash: 'genesis',
                    criadoEm: new Date().toISOString()
                });
            }
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            document.querySelectorAll('.tab').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            if (tabName === 'dashboard') {
                atualizarDashboard();
                atualizarStatusEnvios();
            }
            if (tabName === 'confirmacoes') {
                carregarConfirmacoes();
                carregarPendentesConfirmacoes();
            }
            if (tabName === 'ledger') carregarLedger();
            if (tabName === 'provas') carregarProvas();
            if (tabName === 'dados') carregarDados();
        }

        async function atualizarDashboard() {
            const [dados, ledger, fila] = await Promise.all([
                dbDados.allDocs({include_docs: false}),
                dbLedger.allDocs({include_docs: false}),
                dbFilaOffline.allDocs({include_docs: false})
            ]);

            const entradasLedger = ledger.rows.filter(row => !row.id.includes('ledger_info'));

            document.getElementById('statusGlobal').textContent = estadoApp.online ? 'Online' : 'Offline';
            document.getElementById('protocolosAtivos').textContent = `${estadoApp.protocolosAtivos}/6`;
            document.getElementById('totalDadosRecebidos').textContent = estadoApp.dadosRecebidos;
            document.getElementById('filaOffline').textContent = `${fila.rows.length} pendentes`;

            await atualizarConexoesAtivas();
            await atualizarAtividadeRecente();
        }

        async function atualizarConexoesAtivas() {
            const container = document.getElementById('conexoesAtivas');
            container.innerHTML = '';

            const conexoes = Object.entries(estadoApp.conexoes);
            if (conexoes.length === 0) {
                container.innerHTML = '<div class="ledger-entry">Nenhuma conex√£o ativa</div>';
                return;
            }

            conexoes.forEach(([protocolo, info]) => {
                const div = document.createElement('div');
                div.className = 'ledger-entry';
                div.innerHTML = `
                    <div><strong>${protocolo.toUpperCase()}</strong> - ${info.status}</div>
                    <div class="ledger-timestamp">Ativo</div>
                `;
                container.appendChild(div);
            });
        }

        // ‚úÖ LEDGER OBRIGAT√ìRIO - fun√ß√£o centralizada
        async function adicionarEntradaLedger(dado, tipo = 'dado_registrado') {
            const timestamp = new Date().toISOString();
            const hashData = await calcularHash(JSON.stringify(dado) + timestamp + estadoApp.lastHash);
            
            const entrada = {
                _id: `ledger_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,
                hash: hashData,
                previousHash: estadoApp.lastHash,
                timestamp: timestamp,
                dataId: dado._id,
                tipo: tipo,
                dados: dado,
                protocolo: dado.protocolo || 'manual'
            };

            await dbLedger.put(entrada);
            
            estadoApp.lastHash = hashData;
            await dbLedger.put({
                _id: 'ledger_info',
                lastHash: estadoApp.lastHash,
                atualizadoEm: timestamp
            });

            return entrada;
        }

        async function calcularHash(texto) {
            const encoder = new TextEncoder();
            const data = encoder.encode(texto);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // ‚úÖ ATUALIZADA: verifica√ß√£o de conex√£o
        function verificarConexao() {
            const statusElement = document.getElementById('connectionStatus');
            const statusGlobal = document.getElementById('statusGlobal');

            function atualizarStatus() {
                estadoApp.online = navigator.onLine;
                
                if (estadoApp.online) {
                    statusElement.className = 'connection-status status online';
                    statusElement.textContent = '‚óè ONLINE';
                    statusGlobal.textContent = 'Online';
                    adicionarLogProtocolo('SISTEMA', 'üîó Conex√£o restaurada - Processando fila offline...');
                    
                    // ‚úÖ NOVO: Processar pendentes quando voltar online
                    setTimeout(() => processarFilaPendentes(), 2000);
                    
                } else {
                    statusElement.className = 'connection-status status offline';
                    statusElement.textContent = '‚óè OFFLINE';
                    statusGlobal.textContent = 'Offline';
                    adicionarLogProtocolo('SISTEMA', 'üî¥ Conex√£o perdida - Modo offline ativo');
                }
                
                atualizarContadorPendentes();
                atualizarStatusEnvios();
            }

            window.addEventListener('online', atualizarStatus);
            window.addEventListener('offline', atualizarStatus);
            atualizarStatus();
        }

        // ... (outras fun√ß√µes como carregarLedger, carregarProvas, carregarDados, exportar, etc.)
        // [Mantenha as fun√ß√µes existentes que n√£o foram modificadas]

    </script>
</body>
</html>
