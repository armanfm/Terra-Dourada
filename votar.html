<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Terra Dourada ‚Äî Vota√ß√£o Presidencial</title>

<script src="https://cdn.jsdelivr.net/npm/pouchdb@7.3.1/dist/pouchdb.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
body {
  background: #0a0f0a;
  color: #f5f5f5;
  font-family: system-ui, sans-serif;
  text-align: center;
  padding: 40px;
}
h1 {
  color: #d4af37;
  margin-bottom: 30px;
}

/* Campo de busca por n√∫mero */
.search-container {
  margin: 20px auto;
  max-width: 300px;
}

.search-input {
  width: 100%;
  padding: 12px 20px;
  border: 1px solid #d4af37;
  border-radius: 25px;
  background: #1a1f1a;
  color: #f5f5f5;
  font-size: 1.2rem;
  outline: none;
  text-align: center;
  letter-spacing: 2px;
}

.search-input::placeholder {
  color: #888;
  letter-spacing: normal;
}

.search-input:focus {
  border-color: #f5f5f5;
  box-shadow: 0 0 10px rgba(212,175,55,0.3);
}

/* Teclado num√©rico */
.teclado-numerico {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  max-width: 200px;
  margin: 15px auto;
}

.tecla {
  background: rgba(212,175,55,0.1);
  border: 1px solid #d4af37;
  color: #d4af37;
  padding: 15px;
  border-radius: 10px;
  font-size: 1.2rem;
  cursor: pointer;
  transition: 0.3s;
}

.tecla:hover {
  background: rgba(212,175,55,0.3);
}

.tecla:active {
  background: rgba(212,175,55,0.5);
}

.botoes-acao {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-top: 15px;
}

.btn-branco, .btn-corrige {
  background: transparent;
  border: 1px solid #888;
  color: #888;
  padding: 10px 15px;
  border-radius: 10px;
  cursor: pointer;
  font-size: 0.9rem;
}

.btn-branco:hover, .btn-corrige:hover {
  background: rgba(136,136,136,0.2);
}

.candidates {
  display: flex;
  justify-content: center;
  gap: 40px;
  flex-wrap: wrap;
  margin-top: 30px;
}
.card {
  background: #1a1f1a;
  border: 1px solid rgba(212,175,55,0.2);
  border-radius: 15px;
  padding: 20px;
  width: 250px;
  transition: transform 0.3s, border-color 0.3s;
}
.card:hover {
  transform: translateY(-5px);
  border-color: rgba(212,175,55,0.5);
}
.card img {
  width: 180px;
  height: 180px;
  object-fit: cover;
  margin: 0 auto 15px;
  border-radius: 50%;
  border: 2px solid #d4af37;
  display: block;
}
button {
  background: transparent;
  border: 1px solid #d4af37;
  color: #d4af37;
  padding: 10px 20px;
  border-radius: 20px;
  cursor: pointer;
  transition: 0.3s;
}
button:hover {
  background: rgba(212,175,55,0.1);
}
.results {
  margin-top: 50px;
  background: #111;
  border-radius: 10px;
  padding: 20px;
  display: inline-block;
}
.results div {
  margin: 10px 0;
}

#processando {
  display:none;
  position:fixed;
  top:0; left:0; right:0; bottom:0;
  background:#000c;
  color:#d4af37;
  font-size:1.5rem;
  font-family:system-ui;
  backdrop-filter:blur(4px);
  justify-content:center;
  align-items:center;
  text-shadow:0 0 8px #d4af37;
}

#debugBox {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 380px;
  padding: 15px;
  background: #111;
  border: 1px solid #d4af37;
  color: #d4af37;
  font-family: monospace;
  font-size: 0.82rem;
  white-space: pre-wrap;
  display: none;
  border-radius: 10px;
  box-shadow: 0 0 12px rgba(212,175,55,0.35);
  max-height: 320px;
  overflow-y: auto;
}

/* Estilos para a tela de confirma√ß√£o */
.confirmation-screen {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(10, 15, 10, 0.95);
  z-index: 1000;
  justify-content: center;
  align-items: center;
  flex-direction: column;
}

.confirmation-card {
  background: #1a1f1a;
  border: 2px solid #d4af37;
  border-radius: 15px;
  padding: 30px;
  max-width: 500px;
  width: 90%;
  text-align: center;
}

.confirmation-card img {
  width: 200px;
  height: 200px;
  object-fit: cover;
  margin: 0 auto 20px;
  border-radius: 50%;
  border: 3px solid #d4af37;
  display: block;
}

.confirmation-card h2 {
  color: #d4af37;
  margin-bottom: 20px;
}

.confirmation-buttons {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-top: 30px;
}

.confirm-button {
  background: rgba(212,175,55,0.2);
  border: 1px solid #d4af37;
  color: #d4af37;
  padding: 12px 25px;
  border-radius: 20px;
  cursor: pointer;
  transition: 0.3s;
  font-size: 1rem;
}

.confirm-button:hover {
  background: rgba(212,175,55,0.4);
}

.cancel-button {
  background: transparent;
  border: 1px solid #888;
  color: #888;
  padding: 12px 25px;
  border-radius: 20px;
  cursor: pointer;
  transition: 0.3s;
  font-size: 1rem;
}

.cancel-button:hover {
  background: rgba(136,136,136,0.2);
}

/* Loading */
.loading {
  color: #d4af37;
  font-size: 1.2rem;
  margin: 40px 0;
}

/* Mensagem quando n√£o h√° candidatos */
.no-candidates {
  color: #888;
  font-size: 1.1rem;
  margin: 40px 0;
}

/* Candidato encontrado via busca */
.candidato-encontrado {
  border-color: #56ab2f !important;
  box-shadow: 0 0 15px rgba(86, 171, 47, 0.3);
}

/* Display do n√∫mero digitado */
.numero-display {
  font-size: 2rem;
  color: #d4af37;
  margin: 10px 0;
  letter-spacing: 5px;
  font-weight: bold;
}
</style>
</head>
<body>

<div id="debugBox"></div>

<script>
history.pushState(null, "", location.href);
window.onpopstate = function () {
  history.pushState(null, "", location.href);
};
</script>

<h1>üó≥Ô∏è Elei√ß√£o Presidencial ‚Äî Terra Dourada</h1>

<!-- Campo de busca por n√∫mero -->
<div class="search-container">
  <input type="text" id="searchInput" class="search-input" placeholder="Digite o n√∫mero" 
         maxlength="2" onkeydown="filtrarPorTeclado(event)" oninput="filtrarPorNumero()">
  <div id="numeroDisplay" class="numero-display"></div>
</div>

<!-- Teclado num√©rico -->
<div class="teclado-numerico">
  <div class="tecla" onclick="adicionarNumero('1')">1</div>
  <div class="tecla" onclick="adicionarNumero('2')">2</div>
  <div class="tecla" onclick="adicionarNumero('3')">3</div>
  <div class="tecla" onclick="adicionarNumero('4')">4</div>
  <div class="tecla" onclick="adicionarNumero('5')">5</div>
  <div class="tecla" onclick="adicionarNumero('6')">6</div>
  <div class="tecla" onclick="adicionarNumero('7')">7</div>
  <div class="tecla" onclick="adicionarNumero('8')">8</div>
  <div class="tecla" onclick="adicionarNumero('9')">9</div>
  <div class="tecla" onclick="adicionarNumero('0')">0</div>
</div>

<div class="botoes-acao">
  <button class="btn-branco" onclick="votoBranco()">BRANCO</button>
  <button class="btn-corrige" onclick="corrigirNumero()">CORRIGE</button>
</div>

<!-- Container dos candidatos -->
<div class="candidates" id="urnaTela">
  <div class="loading" id="loadingMessage">Carregando candidatos...</div>
</div>

<!-- Tela de confirma√ß√£o -->
<div id="confirmationScreen" class="confirmation-screen">
  <div id="confirmationCard" class="confirmation-card">
    <img id="confirmationImage" src="" alt="Candidato">
    <h2 id="confirmationName">Candidato</h2>
    <p>Voc√™ est√° prestes a votar em:</p>
    <h3 id="confirmationCandidateName" style="color: #d4af37; margin: 10px 0 20px;"></h3>
    <p>Tem certeza de que deseja confirmar seu voto?</p>
    <div class="confirmation-buttons">
      <button id="confirmVoteButton" class="confirm-button">Sim, confirmar voto</button>
      <button onclick="fecharTelaConfirmacao()" class="cancel-button">Cancelar</button>
    </div>
  </div>
</div>

<div class="results">
  <div>üìä Total de candidatos: <span id="total-candidates">0</span></div>
  <div>üîç Buscando por n√∫mero</div>
</div>

<div id="processando"><div>Processando voto‚Ä¶</div></div>

<audio id="somFIM" src="fim.mp3"></audio>

<script>
// ==============================
// BANCOS DE DADOS
// ==============================
const db = new PouchDB('terra_dourada_votos_local');
const db2 = new PouchDB('terra_dourada_voto');
const dbCandidatos = new PouchDB('terra_dourada_candidatos');

const remoteURL = "http://admin:senha123@127.0.0.1:5984/terra_dourada_votos";
db.sync(remoteURL, { live: true, retry: true });

let todosCandidatos = [];
let voted = false;
const cid = localStorage.getItem("user_cid") || ("cid_" + Math.random().toString(36).slice(2));
let candidatoSelecionado = null;
let numeroDigitado = '';

function debug(msg) {
  const box = document.getElementById("debugBox");
  box.style.display = "block";
  box.textContent += "\n" + msg;
}

// ==============================
// CARREGAR CANDIDATOS DO BANCO
// ==============================
async function carregarCandidatos() {
  try {
    debug("üì• Carregando candidatos do banco...");
    
    const resultado = await dbCandidatos.allDocs({ include_docs: true });
    
    // Filtrar apenas candidatos ativos
    todosCandidatos = resultado.rows
      .filter(row => row.doc.ativo !== false)
      .map(row => row.doc);
    
    debug(`‚úÖ ${todosCandidatos.length} candidatos carregados`);
    
    atualizarInterfaceCandidatos();
    atualizarContadores();
    
  } catch (error) {
    debug("‚ùå Erro ao carregar candidatos: " + error.message);
    
    // Candidatos de exemplo caso o banco esteja vazio
    todosCandidatos = [
      {
        _id: "candidato_1",
        nome: "Jo√£o Silva",
        partido: "PSDB",
        numero: "45",
        foto: "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&h=400&fit=crop",
        ativo: true
      },
      {
        _id: "candidato_2", 
        nome: "Paulo Santos",
        partido: "PT",
        numero: "13",
        foto: "https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=400&h=400&fit=crop",
        ativo: true
      },
      {
        _id: "candidato_3", 
        nome: "Maria Oliveira",
        partido: "PDT",
        numero: "12",
        foto: "https://images.unsplash.com/photo-1494790108755-2616b612b786?w=400&h=400&fit=crop",
        ativo: true
      }
    ];
    
    atualizarInterfaceCandidatos();
    atualizarContadores();
  }
}

// ==============================
// ATUALIZAR INTERFACE DOS CANDIDATOS
// ==============================
function atualizarInterfaceCandidatos() {
  const container = document.getElementById("urnaTela");
  
  // Se tem n√∫mero digitado, mostra apenas o candidato correspondente
  if (numeroDigitado) {
    const candidatoEncontrado = todosCandidatos.find(c => c.numero === numeroDigitado);
    
    if (candidatoEncontrado) {
      container.innerHTML = `
        <div class="card candidato-encontrado">
          <img src="${candidatoEncontrado.foto || 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=400&h=400&fit=crop'}" 
               alt="${candidatoEncontrado.nome}" 
               onerror="this.src='https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=400&h=400&fit=crop'">
          <h3>${candidatoEncontrado.nome}</h3>
          <p><strong>${candidatoEncontrado.partido || 'Independ.'}</strong></p>
          <p>N¬∫ ${candidatoEncontrado.numero || '--'}</p>
          <button onclick="abrirTelaConfirmacao('${candidatoEncontrado._id}', '${candidatoEncontrado.nome}', '${candidatoEncontrado.foto || 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=400&h=400&fit=crop'}')">
            Votar em ${candidatoEncontrado.nome.split(' ')[0]}
          </button>
        </div>
      `;
    } else {
      container.innerHTML = '<div class="no-candidates">Nenhum candidato encontrado com o n√∫mero ' + numeroDigitado + '</div>';
    }
  } else {
    // Mostra todos os candidatos
    if (todosCandidatos.length === 0) {
      container.innerHTML = '<div class="no-candidates">Nenhum candidato cadastrado</div>';
      return;
    }
    
    container.innerHTML = todosCandidatos.map(candidato => `
      <div class="card">
        <img src="${candidato.foto || 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=400&h=400&fit=crop'}" 
             alt="${candidato.nome}" 
             onerror="this.src='https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=400&h=400&fit=crop'">
        <h3>${candidato.nome}</h3>
        <p><strong>${candidato.partido || 'Independ.'}</strong></p>
        <p>N¬∫ ${candidato.numero || '--'}</p>
        <button onclick="abrirTelaConfirmacao('${candidato._id}', '${candidato.nome}', '${candidato.foto || 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=400&h=400&fit=crop'}')">
          Votar em ${candidato.nome.split(' ')[0]}
        </button>
      </div>
    `).join('');
  }
}

// ==============================
// FUN√á√ïES DO TECLADO NUM√âRICO
// ==============================
function adicionarNumero(numero) {
  if (numeroDigitado.length < 2) {
    numeroDigitado += numero;
    atualizarDisplay();
    filtrarPorNumero();
  }
}

function corrigirNumero() {
  numeroDigitado = '';
  atualizarDisplay();
  atualizarInterfaceCandidatos();
}

function votoBranco() {
  if (voted) {
    alert("Voc√™ j√° votou!");
    return;
  }
  
  // Abre confirma√ß√£o para voto em branco
  abrirTelaConfirmacao('branco', 'VOTO EM BRANCO', 'https://images.unsplash.com/photo-1547658719-da2b51169166?w=400&h=400&fit=crop');
}

function atualizarDisplay() {
  document.getElementById('numeroDisplay').textContent = numeroDigitado;
  document.getElementById('searchInput').value = numeroDigitado;
}

function filtrarPorNumero() {
  numeroDigitado = document.getElementById('searchInput').value.replace(/\D/g, '');
  if (numeroDigitado.length > 2) {
    numeroDigitado = numeroDigitado.substring(0, 2);
  }
  atualizarDisplay();
  atualizarInterfaceCandidatos();
}

function filtrarPorTeclado(event) {
  // Permite apenas n√∫meros e teclas de controle
  if (!/[0-9]|Backspace|Delete|ArrowLeft|ArrowRight/.test(event.key)) {
    event.preventDefault();
  }
}

// ==============================
// ATUALIZAR CONTADORES
// ==============================
function atualizarContadores() {
  document.getElementById("total-candidates").textContent = todosCandidatos.length;
}

// ==============================
// Fun√ß√µes para a tela de confirma√ß√£o
// ==============================
function abrirTelaConfirmacao(candidatoId, nome, imagem) {
  if (voted) {
    alert("Voc√™ j√° votou!");
    return;
  }
  
  candidatoSelecionado = candidatoId;
  
  // Preencher informa√ß√µes na tela de confirma√ß√£o
  document.getElementById('confirmationImage').src = imagem;
  document.getElementById('confirmationName').textContent = nome;
  document.getElementById('confirmationCandidateName').textContent = nome;
  
  // Configurar o bot√£o de confirma√ß√£o
  const confirmButton = document.getElementById('confirmVoteButton');
  confirmButton.onclick = function() {
    confirmarVoto(candidatoSelecionado);
  };
  
  // Mostrar a tela de confirma√ß√£o
  document.getElementById('confirmationScreen').style.display = 'flex';
}

function fecharTelaConfirmacao() {
  document.getElementById('confirmationScreen').style.display = 'none';
  candidatoSelecionado = null;
}

// ==============================
// SHA-256
// ==============================
async function sha256Base64(dataURL) {
  const base64 = dataURL.split(",")[1];
  const bytes = Uint8Array.from(atob(base64), c => c.charCodeAt(0));
  const hashBuffer = await crypto.subtle.digest("SHA-256", bytes);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
}

// ==============================
// Capturar print - DA TELA DE CONFIRMA√á√ÉO
// ==============================
async function capturarPrint() {
  const elemento = document.getElementById("confirmationCard");
  const canvas = await html2canvas(elemento);
  return canvas.toDataURL("image/png");
}

// ==============================
// CONFIRMAR VOTO (FINAL)
// ==============================
async function confirmarVoto(candidatoId) {
  if (voted) return alert("Voc√™ j√° votou!");

  document.getElementById("processando").style.display = "flex";
  document.getElementById("somFIM").play();

  let candidato = null;
  
  if (candidatoId !== 'branco') {
    // Buscar dados completos do candidato
    candidato = todosCandidatos.find(c => c._id === candidatoId);
    if (!candidato) {
      alert("Candidato n√£o encontrado!");
      return;
    }
  }

  // ‚úÖ SEMPRE CAPTURA SCREENSHOT
  const printBase64 = await capturarPrint();
  const hashPrint = await sha256Base64(printBase64);
  debug("üì∏ Screenshot capturada. Hash: " + hashPrint);

  // Payload FINAL
  const payload = {
    nome_produtor: cid,
    candidato_id: candidatoId,
    candidato_nome: candidato ? candidato.nome : 'VOTO EM BRANCO',
    candidato_partido: candidato ? candidato.partido : 'BRANCO',
    candidato_numero: candidato ? candidato.numero : '000',
    screenshot_hash: hashPrint,
    tipo: "voto_presidencial",
    timestamp: new Date().toISOString()
  };

  debug("üì§ Enviando JSON:\n" + JSON.stringify(payload, null, 2));

  try {
    const res = await fetch("http://127.0.0.1:8085/enviar_voto", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    debug("üì• Backend retornou:\n" + JSON.stringify(data, null, 2));

    const cidPinata = data.IpfsHash;

    // ‚úÖ SALVA NOS DOIS BANCOS (COM HASH)
    await db.put({
      _id: cid + "_" + Date.now(),
      eleitor: cid,
      candidato_id: candidatoId,
      candidato_nome: candidato ? candidato.nome : 'VOTO EM BRANCO',
      cid_pinata: cidPinata,
      screenshot_hash: hashPrint,
      resposta_backend: data,
      timestamp: new Date().toISOString()
    });

    await db2.put({
      _id: cid + "_" + Date.now(),
      eleitor: cid,
      candidato_id: candidatoId,
      candidato_nome: candidato ? candidato.nome : 'VOTO EM BRANCO',
      cid_pinata: cidPinata,
      screenshot_hash: hashPrint,
      resposta_backend: data,
      timestamp: new Date().toISOString()
    });

    voted = true;
    setTimeout(() => window.location.href = "obrigado.html", 1200);

  } catch (err) {
    debug("‚ùå Erro no envio: " + err.message);

    // ‚úÖ SALVA OFFLINE NOS DOIS BANCOS COM HASH
    const docOffline = {
      _id: cid + "_" + Date.now(),
      eleitor: cid,
      candidato_id: candidatoId,
      candidato_nome: candidato ? candidato.nome : 'VOTO EM BRANCO',
      screenshot_hash: hashPrint,
      erro: "sem_conexao_backend",
      timestamp: new Date().toISOString()
    };

    await db.put(docOffline);
    await db2.put(docOffline);

    debug("üíæ Voto offline salvo COM HASH nos dois bancos!");
    voted = true;

    setTimeout(() => window.location.href = "obrigado.html", 1200);
  }
}

// ==============================
// INICIALIZA√á√ÉO
// ==============================
document.addEventListener("DOMContentLoaded", function() {
  carregarCandidatos();
});
</script>

</body>
</html>
