<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Terra Dourada ‚Äî Obrigado</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  /* SEUS ESTILOS MANTIDOS */
  body {
    background:#0a0f0a;
    color:#f5f5f5;
    font-family:system-ui, sans-serif;
    display:flex;
    justify-content:center;
    align-items:center;
    min-height:100vh;
    text-align:center;
    padding:20px;
    margin:0;
  }
  .box {
    background:#111;
    padding:40px;
    border-radius:20px;
    border:1px solid #d4af37;
    width:420px;
    box-shadow:0 0 20px rgba(212,175,55,0.35);
    animation: fadeIn 0.6s ease-out;
  }
  @keyframes fadeIn {
    from {opacity:0; transform:scale(0.95);}
    to {opacity:1; transform:scale(1);}
  }
  h1 {
    color:#d4af37;
    margin-bottom:15px;
  }

  /* ANEL DOURADO */
  .foto-container {
    width: 180px;
    height: 180px;
    margin: 20px auto;
    position: relative;
  }
  
  .anel-dourado {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: linear-gradient(45deg, #d4af37, #f5e6a4, #d4af37);
    padding: 6px;
    box-shadow: 0 0 25px rgba(212, 175, 55, 0.6);
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0% { box-shadow: 0 0 25px rgba(212, 175, 55, 0.6); }
    50% { box-shadow: 0 0 35px rgba(212, 175, 55, 0.9); }
    100% { box-shadow: 0 0 25px rgba(212, 175, 55, 0.6); }
  }
  
  .foto-candidato {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #0a0f0a;
    background: #1a1f1a;
  }
  
  .foto-vazia {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: #1a1f1a;
    border: 3px solid #0a0f0a;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #d4af37;
    font-size: 3rem;
  }

  #nome {
    font-size:1.3rem;
    margin-top:10px;
    color:#f5f5f5;
  }
  
  #cargo {
    font-size:1rem;
    margin-top:5px;
    color:#d4af37;
  }
  
  #partido {
    font-size:0.9rem;
    margin-top:5px;
    color:#bbb;
  }

  button {
    margin-top:15px;
    padding:12px 30px;
    border-radius:25px;
    cursor:pointer;
    font-size:1rem;
    display:block;
    width:100%;
    transition:0.3s;
    border:none;
    font-weight:bold;
  }
  
  /* Bot√£o ATIVO (com Pinata) */
  #provaBtn.ativo {
    background:#d4af37;
    color:#000;
  }
  #provaBtn.ativo:hover {
    background:#b9962c;
  }
  
  /* Bot√£o INATIVO (sem Pinata) */
  #provaBtn.inativo {
    background:#666;
    color:#999;
    cursor:not-allowed;
  }
  
  .btn-voltar {
    background:transparent;
    border:1px solid #d4af37;
    color:#d4af37;
  }
  .btn-voltar:hover {
    background:rgba(212,175,55,0.15);
  }
  
  /* Propaganda de auditoria */
  .audit-info {
    background:rgba(212,175,55,0.1);
    border:1px solid #d4af37;
    border-radius:15px;
    padding:20px;
    margin:20px 0;
    text-align:left;
  }
  .audit-info h3 {
    color:#d4af37;
    margin-top:0;
    display:flex;
    align-items:center;
    gap:10px;
  }
  .tech-badges {
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin:15px 0;
  }
  .badge {
    background:rgba(86,171,47,0.2);
    border:1px solid #56ab2f;
    color:#56ab2f;
    padding:5px 10px;
    border-radius:15px;
    font-size:0.8rem;
    font-weight:bold;
  }
  .benefits {
    font-size:0.9rem;
    color:#ccc;
    line-height:1.4;
    padding-left:20px;
    margin:15px 0;
  }
  .benefits li {
    margin:8px 0;
  }
  
  /* Status do voto */
  .status {
    padding:12px;
    border-radius:10px;
    margin:15px 0;
    font-weight:bold;
    text-align:center;
  }
  .status.online {
    background:rgba(86,171,47,0.2);
    border:1px solid #56ab2f;
    color:#56ab2f;
  }
  .status.offline {
    background:rgba(255,165,0,0.2);
    border:1px solid #ffa500;
    color:#ffa500;
  }

  /* Bloqueio de navega√ß√£o */
  .blocked-message {
    background:rgba(255,68,68,0.1);
    border:1px solid #ff4444;
    border-radius:10px;
    padding:10px;
    margin:10px 0;
    color:#ff4444;
    font-size:0.9rem;
  }

  /* Tooltip para bot√£o inativo */
  .tooltip {
    position:relative;
    display:inline-block;
    width:100%;
  }
  .tooltip .tooltiptext {
    visibility:hidden;
    width:200px;
    background:#333;
    color:#fff;
    text-align:center;
    border-radius:6px;
    padding:8px;
    position:absolute;
    z-index:1;
    bottom:125%;
    left:50%;
    margin-left:-100px;
    opacity:0;
    transition:opacity 0.3s;
    font-size:0.8rem;
  }
  .tooltip:hover .tooltiptext {
    visibility:visible;
    opacity:1;
  }
</style>
</head>

<body>
<div class="box">
  <h1>‚úîÔ∏è Voto Computado com Sucesso</h1>

  <!-- ANEL DOURADO -->
  <div class="foto-container">
    <div class="anel-dourado">
      <div id="fotoContainer">
        <div class="foto-vazia">‚è≥</div>
      </div>
    </div>
  </div>

  <div id="nome">Carregando candidato...</div>
  <div id="cargo"></div>
  <div id="partido"></div>

  <!-- Status do voto -->
  <div id="statusVoto" class="status">Buscando dados do voto...</div>

  <!-- Mensagem de bloqueio -->
  <div class="blocked-message">
    ‚ö†Ô∏è <strong>Sess√£o Finalizada</strong> - N√£o √© poss√≠vel voltar ou votar novamente
  </div>

  <!-- Bot√£o do comprovante -->
  <div class="tooltip">
    <button id="provaBtn" class="inativo">üîó Ver Comprovante no IPFS</button>
    <span class="tooltiptext" id="tooltipText">Comprovante dispon√≠vel apenas para votos com conex√£o ativa</span>
  </div>

  <!-- Propaganda de auditoria -->
  <div class="audit-info">
    <h3>üîí Seu voto √© 100% Audit√°vel</h3>
    
    <div class="tech-badges">
      <div class="badge">üì∏ Screenshot Hash</div>
      <div class="badge">üîó IPFS Pinata</div>
      <div class="badge">üîç ZK-Proof</div>
      <div class="badge">‚õìÔ∏è Solana</div>
    </div>
    
    <ul class="benefits">
      <li>‚úÖ <strong>Imut√°vel:</strong> Hash SHA-256 garante integridade do comprovante visual</li>
      <li>‚úÖ <strong>Transparente:</strong> Comprovante distribu√≠do via IPFS Pinata</li>
      <li>‚úÖ <strong>Verific√°vel:</strong> Qualquer auditor pode verificar a autenticidade</li>
      <li>‚úÖ <strong>Privacidade:</strong> Zero-Knowledge Proof protege sua identidade</li>
      <li>‚úÖ <strong>Blockchain:</strong> Registro imut√°vel na Solana para audit trail</li>
    </ul>
    
    <div style="text-align:center; margin-top:15px; font-size:0.9rem; color:#d4af37;">
      üåê <strong>Terra Dourada</strong> - Elei√ß√µes transparentes e cryptographicamente audit√°veis
    </div>
  </div>

  <button class="btn-voltar" onclick="sairDoSistema()">üö™ Finalizar Sess√£o</button>
</div>

<script>
// ==============================
// BLOQUEIO TOTAL DE NAVEGA√á√ÉO
// ==============================
history.pushState(null, null, location.href);
window.onpopstate = function(event) {
  history.go(1);
  alert("‚ùå Sess√£o finalizada. N√£o √© poss√≠vel voltar.");
};

document.onkeydown = function(e) {
  if (e.key === "F5" || (e.ctrlKey && e.key === "r")) {
    e.preventDefault();
    alert("‚ùå Sess√£o finalizada. N√£o √© poss√≠vel recarregar.");
    return false;
  }
};

document.addEventListener('contextmenu', function(e) {
  e.preventDefault();
  return false;
});

// ==============================
// CARREGAR DADOS DO VOTO - SIMPLIFICADO
// ==============================
async function carregarDadosVoto() {
  console.log("üöÄ Carregando dados do voto...");
  
  const db = new PouchDB('terra_dourada_votos_local');
  
  try {
    // 1. PRIMEIRO: Tenta pegar do localStorage (mais r√°pido e simples)
    const candidatoSalvo = localStorage.getItem("ultimo_candidato_votado");
    const cidPinataLocal = localStorage.getItem("voto_cid");
    
    if (candidatoSalvo) {
      console.log("‚úÖ Usando candidato do localStorage");
      const candidato = JSON.parse(candidatoSalvo);
      const usouBackend = !!cidPinataLocal;
      
      mostrarCandidato(candidato, usouBackend, cidPinataLocal);
      return;
    }

    // 2. SEGUNDO: Se n√£o tem no localStorage, busca no banco de votos
    console.log("üîç Buscando voto no banco...");
    const cid = localStorage.getItem("user_cid");
    
    if (!cid) {
      throw new Error("CID do usu√°rio n√£o encontrado");
    }

    const allDocs = await db.allDocs({ include_docs: true });
    
    // Filtra votos deste usu√°rio
    const votosUsuario = allDocs.rows.filter(row => 
      row.doc.eleitor === cid && row.doc.candidato
    );
    
    console.log("üó≥Ô∏è Votos encontrados:", votosUsuario.length);

    if (votosUsuario.length > 0) {
      // Pega o voto mais recente
      const ultimoVoto = votosUsuario.reduce((latest, current) => {
        return new Date(current.doc.timestamp) > new Date(latest.doc.timestamp) ? current : latest;
      });
      
      const dadosVoto = ultimoVoto.doc;
      const usouBackend = dadosVoto.cid_pinata && !dadosVoto.erro;
      const cidPinata = dadosVoto.cid_pinata;
      
      console.log("‚úÖ Voto encontrado:", dadosVoto.candidato);
      
      // ‚≠ê‚≠ê SIMPLIFICA√á√ÉO: Usa o candidato EXATAMENTE como estava na vota√ß√£o
      const candidato = dadosVoto.candidato;
      
      // Salva no localStorage para pr√≥xima vez
      localStorage.setItem("ultimo_candidato_votado", JSON.stringify(candidato));
      if (cidPinata) {
        localStorage.setItem("voto_cid", cidPinata);
      }

      mostrarCandidato(candidato, usouBackend, cidPinata);
      
    } else {
      throw new Error("Nenhum voto encontrado para este usu√°rio");
    }
    
  } catch (error) {
    console.error("‚ùå ERRO:", error.message);
    
    // Fallback simples
    document.getElementById("fotoContainer").innerHTML = '<div class="foto-vazia">‚úì</div>';
    document.getElementById("nome").textContent = "Voto Registrado";
    document.getElementById("statusVoto").innerHTML = '‚ö†Ô∏è <strong>Voto Computado</strong>';
    document.getElementById("statusVoto").className = 'status offline';
    
    atualizarBotaoComprovante(false, null);
  }
}

// ==============================
// MOSTRAR CANDIDATO - SIMPLES E DIRETO
// ==============================
function mostrarCandidato(candidato, usouBackend, cidPinata) {
  console.log("üéØ Mostrando candidato:", candidato);
  
  const fotoContainer = document.getElementById("fotoContainer");
  const nomeElement = document.getElementById("nome");
  const cargoElement = document.getElementById("cargo");
  const partidoElement = document.getElementById("partido");
  const statusElement = document.getElementById("statusVoto");

  // Atualiza informa√ß√µes b√°sicas
  nomeElement.textContent = candidato.nome || "Candidato";
  cargoElement.textContent = candidato.cargo || "";
  partidoElement.textContent = candidato.partido ? `Partido: ${candidato.partido}` : "";

  // ‚≠ê‚≠ê SIMPLIFICA√á√ÉO: Carrega a foto EXATAMENTE como estava na vota√ß√£o
  if (candidato.foto && candidato.foto.startsWith('data:image')) {
    console.log("üì∏ Carregando foto do candidato...");
    
    const img = new Image();
    img.className = "foto-candidato";
    img.alt = candidato.nome;
    img.src = candidato.foto;
    
    img.onload = function() {
      console.log("‚úÖ Foto carregada com sucesso!");
      fotoContainer.innerHTML = '';
      fotoContainer.appendChild(img);
    };
    
    img.onerror = function() {
      console.log("‚ùå Erro ao carregar foto");
      fotoContainer.innerHTML = candidato._id === "branco" ? 
        '<div class="foto-vazia">‚ö™</div>' : 
        '<div class="foto-vazia">üë§</div>';
    };
    
    // Coloca a imagem imediatamente
    fotoContainer.innerHTML = '';
    fotoContainer.appendChild(img);
    
  } else {
    console.log("üì∑ Sem foto, usando √≠cone");
    // Usa √≠cone baseado no tipo de voto
    if (candidato._id === "branco" || (candidato.nome && candidato.nome.toUpperCase().includes("BRANCO"))) {
      fotoContainer.innerHTML = '<div class="foto-vazia">‚ö™</div>';
    } else {
      fotoContainer.innerHTML = '<div class="foto-vazia">üë§</div>';
    }
  }

  // Atualiza status
  if (usouBackend && cidPinata) {
    statusElement.innerHTML = `‚úÖ <strong>Voto Registrado com Auditoria Completa</strong>`;
    statusElement.className = 'status online';
  } else {
    statusElement.innerHTML = `‚ö†Ô∏è <strong>Voto Registrado Localmente</strong><br><small>Ser√° sincronizado quando online</small>`;
    statusElement.className = 'status offline';
  }

  atualizarBotaoComprovante(usouBackend, cidPinata);
}

// ==============================
// ATUALIZAR BOT√ÉO DE COMPROVANTE
// ==============================
function atualizarBotaoComprovante(usouBackend, cidPinata) {
  const provaBtn = document.getElementById("provaBtn");
  const tooltipText = document.getElementById("tooltipText");

  if (usouBackend && cidPinata) {
    provaBtn.className = "ativo";
    provaBtn.innerHTML = "üîó Ver Comprovante no IPFS";
    tooltipText.textContent = "Clique para ver seu comprovante no IPFS Pinata";
    
    provaBtn.onclick = function () {
      window.open("https://gateway.pinata.cloud/ipfs/" + cidPinata, "_blank");
    };
  } else {
    provaBtn.className = "inativo";
    provaBtn.innerHTML = "üîó Comprovante Indispon√≠vel";
    tooltipText.textContent = "Comprovante dispon√≠vel apenas para votos com conex√£o ativa ao backend";
    
    provaBtn.onclick = function () {
      alert("‚ùå Comprovante indispon√≠vel. Este voto foi registrado localmente e ser√° sincronizado quando online.");
    };
  }
}

// ==============================
// SAIR DO SISTEMA
// ==============================
function sairDoSistema() {
  localStorage.removeItem("voto_cid");
  localStorage.removeItem("ultimo_candidato_votado");
  window.location.href = "index.html";
}

// ==============================
// INICIALIZA√á√ÉO
// ==============================
document.addEventListener('DOMContentLoaded', function() {
  console.log("üìÑ P√°gina carregada - iniciando...");
  carregarDadosVoto();
  
  window.onbeforeunload = function() {
    return "‚ùå Sua sess√£o de vota√ß√£o foi finalizada. Tem certeza que deseja sair?";
  };
});
</script>
</body>
</html>
