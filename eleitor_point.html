<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ponto do Eleitor ‚Äî Terra Dourada</title>
  <script src="https://cdn.jsdelivr.net/npm/pouchdb@7.3.1/dist/pouchdb.min.js"></script>
  
  <style>
    body {
      background: #050703;
      color: #f5f5f5;
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    header {
      text-align: center;
      margin-bottom: 30px;
      border-bottom: 1px solid rgba(212,175,55,0.3);
      padding-bottom: 20px;
    }
    h1 {
      color: #d4af37;
      margin-bottom: 10px;
    }
    .card {
      background: #111;
      border-radius: 15px;
      padding: 30px;
      border: 1px solid rgba(212,175,55,0.3);
      margin-bottom: 20px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #d4af37;
    }
    .form-group input {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #d4af37;
      background: #1a1a1a;
      color: white;
      font-size: 16px;
    }
    .btn {
      background: rgba(212,175,55,0.2);
      border: 1px solid #d4af37;
      color: #d4af37;
      padding: 12px 25px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 1.1rem;
      transition: .3s;
      width: 100%;
    }
    .btn:hover {
      background: rgba(212,175,55,0.4);
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .status {
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
      text-align: center;
    }
    .status.success {
      background: rgba(86, 171, 47, 0.2);
      border: 1px solid #56ab2f;
      color: #56ab2f;
    }
    .status.error {
      background: rgba(255, 68, 68, 0.2);
      border: 1px solid #ff4444;
      color: #ff4444;
    }
    .status.info {
      background: rgba(212,175,55,0.2);
      border: 1px solid #d4af37;
      color: #d4af37;
    }
    .hidden {
      display: none;
    }
    .eleicao-info {
      background: rgba(212,175,55,0.1);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      text-align: center;
    }
    .eleicao-info h2 {
      color: #d4af37;
      margin: 0 0 10px 0;
    }
    .voltar-btn {
      background: rgba(128, 128, 128, 0.2);
      border: 1px solid #808080;
      color: #808080;
      padding: 10px 20px;
      border-radius: 20px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      margin-top: 20px;
    }
    .voltar-btn:hover {
      background: rgba(128, 128, 128, 0.4);
    }
    .candidatos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .candidato-card {
      background: #1a1a1a;
      border: 1px solid rgba(212,175,55,0.2);
      border-radius: 10px;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      transition: .3s;
    }
    .candidato-card:hover {
      border-color: #d4af37;
      transform: translateY(-2px);
    }
    .candidato-card.selected {
      border-color: #56ab2f;
      background: rgba(86, 171, 47, 0.1);
    }
    .candidato-foto {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      margin: 0 auto 10px;
      border: 2px solid #d4af37;
    }
    .candidato-card h3 {
      color: #d4af37;
      margin: 0 0 5px 0;
      font-size: 1rem;
    }
    .candidato-card p {
      margin: 2px 0;
      font-size: 0.9rem;
      color: #ccc;
    }
  </style>
</head>
<body>

<div class="container">
  <header>
    <h1>üó≥Ô∏è Ponto do Eleitor ‚Äî Terra Dourada</h1>
    <p>Valida√ß√£o e autoriza√ß√£o de votos</p>
  </header>

  <!-- INFO DA ELEI√á√ÉO -->
  <div id="eleicaoHeader" class="eleicao-info">
    <h2 id="eleicao-titulo">Carregando elei√ß√£o...</h2>
    <p id="eleicao-cargo">-</p>
  </div>

  <!-- CARD DE VALIDA√á√ÉO -->
  <div id="cardValidacao" class="card">
    <h2>üîç Validar Eleitor</h2>
    
    <div class="form-group">
      <label for="cpf">CPF do Eleitor</label>
      <input type="text" id="cpf" placeholder="000.000.000-00" maxlength="14">
    </div>

    <div class="form-group">
      <label for="codigoEleitor">C√≥digo do Eleitor (opcional)</label>
      <input type="text" id="codigoEleitor" placeholder="C√≥digo √∫nico do eleitor">
    </div>

    <button class="btn" onclick="validarEleitor()" id="btnValidar">
      ‚úÖ Validar Eleitor
    </button>

    <div id="statusValidacao"></div>
  </div>

  <!-- CARD DE AUTORIZA√á√ÉO (inicialmente oculto) -->
  <div id="cardAutorizacao" class="card hidden">
    <h2>üé´ Gerar Autoriza√ß√£o de Voto</h2>
    
    <div class="form-group">
      <label for="nomeEleitor">Nome do Eleitor</label>
      <input type="text" id="nomeEleitor" readonly style="background: #333;">
    </div>

    <div class="form-group">
      <label for="cpfValidado">CPF Validado</label>
      <input type="text" id="cpfValidado" readonly style="background: #333;">
    </div>

    <button class="btn" onclick="gerarAutorizacaoVoto()" id="btnAutorizar">
      üé´ Gerar Autoriza√ß√£o para Votar
    </button>

    <div id="linkAutorizacao"></div>
  </div>

  <!-- CARD DE VOTA√á√ÉO DIRETA (inicialmente oculto) -->
  <div id="cardVotacao" class="card hidden">
    <h2>üó≥Ô∏è Vota√ß√£o Direta</h2>
    <p>Selecione seu candidato:</p>
    
    <div id="listaCandidatos" class="candidatos-grid"></div>
    
    <button class="btn" onclick="confirmarVoto()" id="btnVotar" disabled>
      ‚úÖ Confirmar Voto
    </button>
    
    <div id="statusVoto"></div>
  </div>

  <div style="text-align: center;">
    <a href="index.html" class="voltar-btn">‚Üê Voltar ao In√≠cio</a>
  </div>
</div>

<script>
// --- BANCOS DE DADOS ---
const dbAuth = new PouchDB('terra_dourada_autorizacoes');
const dbEleicoes = new PouchDB('terra_dourada_eleicoes');
const dbCandidatos = new PouchDB('terra_dourada_candidatos');
const dbVotos = new PouchDB('terra_dourada_votos_local');

// --- VARI√ÅVEIS GLOBAIS ---
let ELEICAO_ATUAL_ID = null;
let ELEICAO_ATUAL_DATA = null;
let ELEITOR_VALIDADO = null;
let CANDIDATO_SELECIONADO = null;

// --- FUN√á√ÉO PARA OBTER ID DA ELEI√á√ÉO ---
function obterIdEleicao() {
    const urlParams = new URLSearchParams(window.location.search);
    
    // Tenta pegar o ID da elei√ß√£o de m√∫ltiplas formas
    const eleicaoId = urlParams.get('eleicao_id') || 
                     urlParams.get('eleicao') || 
                     urlParams.get('id');
    
    console.log('üîç Buscando ID da elei√ß√£o:', {
        eleicao_id: urlParams.get('eleicao_id'),
        eleicao: urlParams.get('eleicao'), 
        id: urlParams.get('id'),
        resultado: eleicaoId
    });
    
    if (!eleicaoId) {
        console.error('‚ùå ID da elei√ß√£o n√£o encontrado na URL');
        mostrarErro('Link inv√°lido: Elei√ß√£o n√£o identificada');
        return null;
    }
    
    console.log('‚úÖ Elei√ß√£o ID encontrado:', eleicaoId);
    return eleicaoId;
}

// --- INICIALIZA√á√ÉO ---
async function inicializarPainelEleitor() {
    console.log('üéØ Inicializando painel do eleitor...');
    
    ELEICAO_ATUAL_ID = obterIdEleicao();
    
    if (!ELEICAO_ATUAL_ID) {
        document.body.innerHTML = `
            <div style="text-align: center; padding: 50px; color: white; background: #111;">
                <h2 style="color: #ff4444;">‚ùå Elei√ß√£o n√£o identificada</h2>
                <p>Use um link v√°lido fornecido pela autoridade eleitoral</p>
                <a href="index.html" style="color: #d4af37; text-decoration: none;">Voltar ao in√≠cio</a>
            </div>
        `;
        return;
    }
    
    // Carrega os dados da elei√ß√£o espec√≠fica
    await carregarDadosEleicao(ELEICAO_ATUAL_ID);
}

// --- CARREGAR DADOS DA ELEI√á√ÉO ---
async function carregarDadosEleicao(eleicaoId) {
    try {
        console.log('üì• Carregando dados da elei√ß√£o:', eleicaoId);
        
        // Carrega a elei√ß√£o espec√≠fica
        const eleicao = await dbEleicoes.get(eleicaoId);
        console.log('‚úÖ Elei√ß√£o carregada:', eleicao);
        
        ELEICAO_ATUAL_DATA = eleicao;
        
        // Atualiza a interface com os dados da elei√ß√£o
        document.getElementById('eleicao-titulo').textContent = eleicao.name || 'Elei√ß√£o';
        document.getElementById('eleicao-cargo').textContent = eleicao.position || 'Cargo n√£o definido';
        
        // Carrega candidatos apenas dessa elei√ß√£o
        await carregarCandidatos(eleicaoId);
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar elei√ß√£o:', error);
        mostrarErro('Erro ao carregar elei√ß√£o. Verifique se o link est√° correto.');
    }
}

// --- CARREGAR CANDIDATOS ---
async function carregarCandidatos(eleicaoId) {
    try {
        console.log('üë• Carregando candidatos para elei√ß√£o:', eleicaoId);
        
        const res = await dbCandidatos.allDocs({ include_docs: true });
        
        // Filtra apenas candidatos da elei√ß√£o atual
        const candidatosFiltrados = res.rows.filter(row => 
            row.doc.eleicao_id === eleicaoId && row.doc.ativo !== false
        );
        
        console.log(`‚úÖ ${candidatosFiltrados.length} candidatos encontrados`);
        
        const container = document.getElementById('listaCandidatos');
        
        if (candidatosFiltrados.length === 0) {
            container.innerHTML = '<p style="color: #888; text-align: center;">Nenhum candidato cadastrado nesta elei√ß√£o</p>';
            return;
        }
        
        container.innerHTML = candidatosFiltrados.map(candidato => {
            const c = candidato.doc;
            return `
                <div class="candidato-card" onclick="selecionarCandidato('${c._id}')" id="candidato-${c._id}">
                    ${c.foto ? `<img src="${c.foto}" class="candidato-foto" alt="${c.nome}">` : '<div class="candidato-foto" style="background:#333; display:flex; align-items:center; justify-content:center;">üë§</div>'}
                    <h3>${c.nome}</h3>
                    <p><strong>${c.partido || 'Independ.'}</strong></p>
                    <p>N¬∫ ${c.numero || '--'}</p>
                </div>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Erro ao carregar candidatos:', error);
    }
}

// --- VALIDAR ELEITOR ---
async function validarEleitor() {
    const cpf = document.getElementById('cpf').value;
    const codigo = document.getElementById('codigoEleitor').value;
    
    if (!cpf) {
        mostrarStatus('Por favor, informe o CPF', 'error');
        return;
    }
    
    // Simula√ß√£o de valida√ß√£o - EM PRODU√á√ÉO ISSO IRIA CONSULTAR A API DO CLIENTE
    try {
        document.getElementById('btnValidar').disabled = true;
        document.getElementById('btnValidar').textContent = '‚è≥ Validando...';
        
        // Simula delay de rede
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        // Dados simulados do eleitor
        ELEITOR_VALIDADO = {
            nome: "Eleitor de Exemplo",
            cpf: cpf,
            codigo: codigo,
            validado: true
        };
        
        mostrarStatus('‚úÖ Eleitor validado com sucesso!', 'success');
        
        // Preenche os dados do eleitor validado
        document.getElementById('nomeEleitor').value = ELEITOR_VALIDADO.nome;
        document.getElementById('cpfValidado').value = ELEITOR_VALIDADO.cpf;
        
        // Mostra o card de autoriza√ß√£o
        document.getElementById('cardAutorizacao').classList.remove('hidden');
        document.getElementById('cardVotacao').classList.remove('hidden');
        
    } catch (error) {
        console.error('Erro na valida√ß√£o:', error);
        mostrarStatus('‚ùå Erro ao validar eleitor', 'error');
    } finally {
        document.getElementById('btnValidar').disabled = false;
        document.getElementById('btnValidar').textContent = '‚úÖ Validar Eleitor';
    }
}

// --- GERAR AUTORIZA√á√ÉO DE VOTO ---
async function gerarAutorizacaoVoto() {
    if (!ELEITOR_VALIDADO) {
        mostrarStatus('Valide o eleitor primeiro', 'error');
        return;
    }
    
    try {
        document.getElementById('btnAutorizar').disabled = true;
        document.getElementById('btnAutorizar').textContent = '‚è≥ Gerando...';
        
        const token = crypto.randomUUID();
        
        // Salva a autoriza√ß√£o no banco
        await dbAuth.put({
            _id: `auth_${Date.now()}`,
            token: token,
            eleicao_id: ELEICAO_ATUAL_ID,
            eleitor_nome: ELEITOR_VALIDADO.nome,
            eleitor_cpf: ELEITOR_VALIDADO.cpf,
            tipo: 'voto_eleitor',
            created_at: new Date().toISOString(),
            expires_at: new Date(Date.now() + 2 * 60 * 60 * 1000).toISOString(), // 2 horas
            usado: false
        });
        
        const voteURL = `${window.location.origin}/voto.html?auth=${token}&eleicao_id=${ELEICAO_ATUAL_ID}`;
        
        document.getElementById('linkAutorizacao').innerHTML = `
            <div class="status success">
                <h4>‚úÖ Autoriza√ß√£o Gerada com Sucesso!</h4>
                <p><strong>Eleitor:</strong> ${ELEITOR_VALIDADO.nome}</p>
                <p><strong>Link de Voto:</strong></p>
                <a href="${voteURL}" target="_blank" style="color: #56ab2f; word-break: break-all;">${voteURL}</a>
                <br><br>
                <button class="btn" onclick="copiarLink('${voteURL}')" style="background: rgba(86,171,47,0.2); border-color: #56ab2f; color: #56ab2f;">
                    üìã Copiar Link
                </button>
            </div>
        `;
        
    } catch (error) {
        console.error('Erro ao gerar autoriza√ß√£o:', error);
        mostrarStatus('‚ùå Erro ao gerar autoriza√ß√£o', 'error');
    } finally {
        document.getElementById('btnAutorizar').disabled = false;
        document.getElementById('btnAutorizar').textContent = 'üé´ Gerar Autoriza√ß√£o para Votar';
    }
}

// --- SELE√á√ÉO DE CANDIDATO ---
function selecionarCandidato(candidatoId) {
    // Remove sele√ß√£o anterior
    document.querySelectorAll('.candidato-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Adiciona sele√ß√£o nova
    document.getElementById(`candidato-${candidatoId}`).classList.add('selected');
    CANDIDATO_SELECIONADO = candidatoId;
    
    document.getElementById('btnVotar').disabled = false;
}

// --- CONFIRMAR VOTO DIRETO ---
async function confirmarVoto() {
    if (!CANDIDATO_SELECIONADO) {
        mostrarStatus('Selecione um candidato', 'error');
        return;
    }
    
    if (!ELEITOR_VALIDADO) {
        mostrarStatus('Valide o eleitor primeiro', 'error');
        return;
    }
    
    try {
        document.getElementById('btnVotar').disabled = true;
        document.getElementById('btnVotar').textContent = '‚è≥ Registrando voto...';
        
        // Registra o voto diretamente
        await dbVotos.put({
            _id: `voto_${Date.now()}`,
            eleicao_id: ELEICAO_ATUAL_ID,
            candidato_id: CANDIDATO_SELECIONADO,
            eleitor_cpf: ELEITOR_VALIDADO.cpf,
            eleitor_nome: ELEITOR_VALIDADO.nome,
            timestamp: new Date().toISOString(),
            tipo: 'voto_direto',
            ip: 'local'
        });
        
        document.getElementById('statusVoto').innerHTML = `
            <div class="status success">
                <h4>‚úÖ Voto Registrado com Sucesso!</h4>
                <p>Seu voto foi computado para esta elei√ß√£o.</p>
            </div>
        `;
        
        // Desabilita novos votos
        document.querySelectorAll('.candidato-card').forEach(card => {
            card.style.pointerEvents = 'none';
            card.style.opacity = '0.6';
        });
        
    } catch (error) {
        console.error('Erro ao registrar voto:', error);
        mostrarStatus('‚ùå Erro ao registrar voto', 'error');
    } finally {
        document.getElementById('btnVotar').disabled = true;
        document.getElementById('btnVotar').textContent = '‚úÖ Voto Registrado';
    }
}

// --- FUN√á√ïES AUXILIARES ---
function mostrarStatus(mensagem, tipo) {
    const div = document.getElementById('statusValidacao');
    div.innerHTML = `<div class="status ${tipo}">${mensagem}</div>`;
}

function mostrarErro(mensagem) {
    document.body.innerHTML = `
        <div style="text-align: center; padding: 50px; color: white; background: #111;">
            <h2 style="color: #ff4444;">‚ùå Erro</h2>
            <p>${mensagem}</p>
            <a href="index.html" style="color: #d4af37; text-decoration: none;">Voltar ao in√≠cio</a>
        </div>
    `;
}

function copiarLink(link) {
    navigator.clipboard.writeText(link).then(() => {
        alert('‚úÖ Link copiado para a √°rea de transfer√™ncia!');
    }).catch(err => {
        console.error('Erro ao copiar:', err);
        alert('‚ùå Erro ao copiar link');
    });
}

// --- M√ÅSCARA PARA CPF ---
document.getElementById('cpf').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    
    if (value.length <= 11) {
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
    }
    
    e.target.value = value;
});

// --- INICIALIZA√á√ÉO ---
document.addEventListener('DOMContentLoaded', function() {
    inicializarPainelEleitor();
});
</script>
</body>
</html>
