<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel de Autoridade ‚Äî Terra Dourada</title>
  <script src="https://cdn.jsdelivr.net/npm/pouchdb@7.3.1/dist/pouchdb.min.js"></script>

  <style>
    /* ESTILOS EXISTENTES MANTIDOS */
    body {
      background: #050703;
      color: #f5f5f5;
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }
    header {
      text-align: center;
      margin-bottom: 30px;
      border-bottom: 1px solid rgba(212,175,55,0.3);
      padding-bottom: 20px;
    }
    h1 {
      color: #d4af37;
      margin-bottom: 10px;
    }
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .tab {
      background: transparent;
      border: 1px solid #d4af37;
      color: #d4af37;
      padding: 10px 20px;
      border-radius: 20px;
      cursor: pointer;
      transition: .3s;
    }
    .tab.active {
      background: rgba(212,175,55,0.2);
    }
    .tab:hover {
      background: rgba(212,175,55,0.1);
    }
    .content {
      background: #111;
      border-radius: 15px;
      padding: 30px;
      border: 1px solid rgba(212,175,55,0.3);
      min-height: 400px;
    }
    .candidatos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .candidato-card {
      background: #1a1a1a;
      border: 1px solid rgba(212,175,55,0.2);
      border-radius: 10px;
      padding: 20px;
      text-align: center;
    }
    .candidato-card h3 {
      color: #d4af37;
      margin-bottom: 10px;
    }
    .candidato-card p {
      margin: 5px 0;
      color: #ccc;
    }
    .candidato-foto {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      margin: 0 auto 15px;
      border: 2px solid #d4af37;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 15px;
      font-size: 0.8rem;
      margin: 5px 0;
    }
    .status-ativa {
      background: rgba(86, 171, 47, 0.2);
      color: #56ab2f;
      border: 1px solid #56ab2f;
    }
    .status-inativa {
      background: rgba(255, 68, 68, 0.2);
      color: #ff4444;
      border: 1px solid #ff4444;
    }
    .action-btn {
      background: rgba(212,175,55,0.2);
      border: 1px solid #d4af37;
      color: #d4af37;
      padding: 8px 16px;
      border-radius: 15px;
      cursor: pointer;
      margin: 5px;
      font-size: 0.9rem;
      transition: .3s;
    }
    .action-btn:hover {
      background: rgba(212,175,55,0.4);
    }
    .delete-btn {
      background: #ff4444;
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 15px;
      cursor: pointer;
      margin: 5px;
      font-size: 0.9rem;
    }
    .auth-section {
      text-align: center;
      margin-top: 30px;
    }
    .auth-link {
      background: rgba(212,175,55,0.1);
      border: 1px dashed #d4af37;
      border-radius: 10px;
      padding: 15px;
      margin: 10px 0;
      word-break: break-all;
    }
    .generate-btn {
      background: transparent;
      border: 1px solid #d4af37;
      color: #d4af37;
      padding: 10px 20px;
      border-radius: 20px;
      cursor: pointer;
      margin: 10px;
    }
    .generate-btn:hover {
      background: rgba(212,175,55,0.2);
    }
    .cadastro-btn {
      background: rgba(212,175,55,0.2);
      border: 1px solid #d4af37;
      color: #d4af37;
      padding: 12px 25px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 1.1rem;
      margin-top: 20px;
    }
    .cadastro-btn:hover {
      background: rgba(212,175,55,0.4);
    }
    .empty-state {
      text-align: center;
      color: #888;
      padding: 40px;
    }
    .authorized-votes {
      margin-top: 30px;
      background: rgba(212,175,55,0.05);
      border-radius: 10px;
      padding: 15px;
    }
    .vote-status {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .auditor-btn {
      background: rgba(86, 171, 47, 0.2);
      border: 1px solid #56ab2f;
      color: #56ab2f;
      padding: 12px 25px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 1.1rem;
      margin-top: 20px;
      transition: .3s;
    }
    .auditor-btn:hover {
      background: rgba(86, 171, 47, 0.4);
    }
    .candidato-btn {
      background: rgba(148, 0, 211, 0.2);
      border: 1px solid #9400d3;
      color: #9400d3;
      padding: 12px 25px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 1.1rem;
      margin-top: 20px;
      transition: .3s;
    }
    .candidato-btn:hover {
      background: rgba(148, 0, 211, 0.4);
    }
    .eleicao-btn {
      background: rgba(30, 144, 255, 0.2);
      border: 1px solid #1e90ff;
      color: #1e90ff;
      padding: 12px 25px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 1.1rem;
      margin-top: 20px;
      transition: .3s;
    }
    .eleicao-btn:hover {
      background: rgba(30, 144, 255, 0.4);
    }
    .header-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    .voltar-btn {
      background: rgba(128, 128, 128, 0.2);
      border: 1px solid #808080;
      color: #808080;
      padding: 10px 20px;
      border-radius: 20px;
      cursor: pointer;
      margin: 10px;
      text-decoration: none;
      display: inline-block;
    }
    .voltar-btn:hover {
      background: rgba(128, 128, 128, 0.4);
    }

    /* NOVOS ESTILOS PARA MES√ÅRIOS E API */
    .mesarios-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .mesario-card {
      background: #1a1a1a;
      border: 1px solid rgba(212,175,55,0.2);
      border-radius: 10px;
      padding: 15px;
    }
    .mesario-card h4 {
      color: #d4af37;
      margin: 0 0 10px 0;
    }
    .mesario-info {
      font-size: 0.9rem;
      color: #ccc;
      margin: 5px 0;
    }
    .api-config-section {
      background: rgba(212,175,55,0.05);
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #d4af37;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #d4af37;
      background: #1a1a1a;
      color: white;
    }
    .api-status {
      padding: 8px 15px;
      border-radius: 15px;
      font-size: 0.9rem;
      display: inline-block;
      margin: 10px 0;
    }
    .api-status.configurada {
      background: rgba(86, 171, 47, 0.2);
      border: 1px solid #56ab2f;
      color: #56ab2f;
    }
    .api-status.nao-configurada {
      background: rgba(212,175,55,0.2);
      border: 1px solid #d4af37;
      color: #d4af37;
    }
    .credenciais-box {
      background: rgba(212,175,55,0.1);
      border: 1px dashed #d4af37;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      text-align: left;
    }

    /* INFO DA ELEI√á√ÉO */
    .eleicao-header {
      background: rgba(212,175,55,0.1);
      border: 1px solid #d4af37;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      text-align: center;
    }
    .eleicao-header h2 {
      color: #d4af37;
      margin: 0 0 10px 0;
    }
    .eleicao-header p {
      margin: 5px 0;
      color: #ccc;
    }

    /* NOVOS ESTILOS PARA MONITOR DE RESULTADOS */
    .candidato-resultado {
      background: #1a1a1a;
      border: 1px solid rgba(212,175,55,0.2);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 15px;
      transition: transform 0.3s;
    }
    .candidato-resultado:hover {
      transform: translateY(-2px);
      border-color: rgba(212,175,55,0.5);
    }
    .barra-progresso {
      background: #333;
      border-radius: 10px;
      height: 20px;
      overflow: hidden;
      margin: 10px 0;
      position: relative;
    }
    .preenchimento-barra {
      background: linear-gradient(90deg, #d4af37, #ffd700);
      height: 100%;
      border-radius: 10px;
      transition: width 0.5s ease-in-out;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 10px;
      font-size: 0.7rem;
      color: #000;
      font-weight: bold;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .stat-card {
      border-radius: 10px;
      padding: 15px;
      text-align: center;
      border: 1px solid;
    }
    .stat-icon {
      font-size: 2rem;
      margin-bottom: 10px;
    }
    .stat-number {
      font-size: 1.5rem;
      font-weight: bold;
      margin: 5px 0;
    }
    .stat-label {
      color: #ccc;
      font-size: 0.9rem;
    }
  </style>
</head>

<body>

<div class="container">
  <header>
    <h1>üåç Painel de Autoridade ‚Äî Terra Dourada</h1>
    <p>Gerencie elei√ß√µes, candidatos e cr√©ditos</p>
    
    <!-- INFO DA ELEI√á√ÉO ATUAL -->
    <div class="eleicao-header" id="eleicaoHeader">
      <h2 id="eleicaoNome">Carregando elei√ß√£o...</h2>
      <p id="eleicaoInfo">ID: <span id="eleicaoId">-</span></p>
    </div>
    
    <div class="header-buttons">
      <button class="candidato-btn" onclick="cadastrarCandidato()">
        üë§ Cadastrar Candidato
      </button>
      <button class="auditor-btn" onclick="window.location.href='auditor.html'">
        üëÅÔ∏è Painel do Auditor
      </button>
    </div>
  </header>

  <!-- BOT√ïES DAS ABAS -->
  <div class="tabs">
    <button class="tab active" onclick="showTab('candidatos')">üë• Candidatos</button>
    <button class="tab" onclick="showTab('mesarios')">üë• Mes√°rios</button>
    <button class="tab" onclick="showTab('api-cliente')">üîå API Cliente</button>
    <button class="tab" onclick="window.location.href='eleitor_point.html?eleicao=' + ELEICAO_ATUAL_ID">üîê Autorizar Votos</button>
    <button class="tab" onclick="showTab('monitor')">üìä Monitorar Votos</button>
    <button class="tab" onclick="showTab('pagamento')">üí∞ Comprar Cr√©ditos</button>
  </div>

  <!-- CONTE√öDO -->
  <div class="content">

    <!-- ABA CANDIDATOS -->
    <div id="tab-candidatos">
      <h2>Lista de Candidatos Cadastrados</h2>
      <div id="candidatos-list" class="candidatos-grid"></div>
    </div>

    <!-- ABA MES√ÅRIOS -->
    <div id="tab-mesarios" style="display: none;">
      <h2>üë• Gerenciar Mes√°rios</h2>
      
      <div style="text-align: center; margin: 20px 0;">
        <button class="cadastro-btn" onclick="criarNovoMesario()">
          ‚ûï Cadastrar Novo Mes√°rio
        </button>
      </div>

      <div id="lista-mesarios" class="mesarios-grid"></div>
    </div>

    <!-- ABA API CLIENTE -->
    <div id="tab-api-cliente" style="display: none;">
      <h2>üîå Configurar API do Cliente</h2>
      
      <div class="api-config-section">
        <h3>‚öôÔ∏è Configura√ß√£o da API</h3>
        
        <div class="form-group">
          <label>URL Base da API *</label>
          <input type="text" id="api-base-url" placeholder="https://api.cliente.com" style="width: 100%;">
        </div>
        
        <div class="form-group">
          <label>Token de Autentica√ß√£o *</label>
          <input type="password" id="api-token" placeholder="Bearer token..." style="width: 100%;">
        </div>

        <h4 style="color: #d4af37; margin: 20px 0 10px 0;">Endpoints Personalizados</h4>
        
        <div class="form-group">
          <label>Valida√ß√£o de Eleitor</label>
          <input type="text" id="endpoint-validar" placeholder="/api/eleitores/validar" style="width: 100%;">
        </div>
        
        <div class="form-group">
          <label>Valida√ß√£o por C√≥digo</label>
          <input type="text" id="endpoint-codigo" placeholder="/api/eleitores/codigo" style="width: 100%;">
        </div>

        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button class="action-btn" onclick="salvarConfigAPI()">üíæ Salvar Configura√ß√£o</button>
          <button class="action-btn" onclick="testarConexaoAPI()">üîç Testar Conex√£o</button>
        </div>

        <div id="api-status" class="api-status nao-configurada">‚ö†Ô∏è API: N√£o Configurada</div>
      </div>
    </div>

    <!-- ABA MONITOR - NOVA VERS√ÉO COM RESULTADOS EM TEMPO REAL -->
    <div id="tab-monitor" style="display: none;">
      <h2>üìä Resultados em Tempo Real</h2>
      
      <div style="text-align: center; margin: 20px 0;">
        <button class="action-btn" onclick="atualizarResultados()">
          üîÑ Atualizar Resultados
        </button>
        <button class="action-btn" onclick="exportarResultados()">
          üìà Exportar Resultados
        </button>
      </div>

      <!-- ESTAT√çSTICAS GERAIS -->
      <div class="stats-grid">
        <div class="stat-card" style="border-color: #d4af37; background: rgba(212,175,55,0.1);">
          <div class="stat-icon">üó≥Ô∏è</div>
          <div class="stat-number" id="total-votos">0</div>
          <div class="stat-label">Total de Votos</div>
        </div>
        
        <div class="stat-card" style="border-color: #56ab2f; background: rgba(86, 171, 47, 0.1);">
          <div class="stat-icon">‚úÖ</div>
          <div class="stat-number" id="votos-validos">0</div>
          <div class="stat-label">Votos V√°lidos</div>
        </div>
        
        <div class="stat-card" style="border-color: #ffa500; background: rgba(255, 165, 0, 0.1);">
          <div class="stat-icon">‚ö™</div>
          <div class="stat-number" id="votos-brancos">0</div>
          <div class="stat-label">Votos em Branco</div>
        </div>
        
        <div class="stat-card" style="border-color: #ff4444; background: rgba(255, 68, 68, 0.1);">
          <div class="stat-icon">üìä</div>
          <div class="stat-number" id="candidatos-ativos">0</div>
          <div class="stat-label">Candidatos Ativos</div>
        </div>
      </div>

      <!-- LISTA DE CANDIDATOS COM BARRAS DE PROGRESSO -->
      <div id="resultados-candidatos" style="margin-top: 30px;">
        <div class="empty-state">
          <h3>Carregando resultados...</h3>
          <p>Clique em "Atualizar Resultados" para ver os votos</p>
        </div>
      </div>

      <!-- GR√ÅFICO DE COMPARA√á√ÉO -->
      <div id="grafico-comparacao" style="margin-top: 40px; display: none;">
        <h3 style="color: #d4af37; border-bottom: 1px solid rgba(212,175,55,0.3); padding-bottom: 10px;">
          üìà Compara√ß√£o entre Candidatos
        </h3>
        <div id="barras-comparacao" style="margin-top: 20px;"></div>
      </div>
    </div>

    <!-- ABA PAGAMENTO -->
    <div id="tab-pagamento" style="display: none;">
      <h2>üí∞ Comprar Cr√©ditos de Vota√ß√£o</h2>
      
      <label>Quantidade de votos:</label><br>
      <input id="quantidade" type="number" min="10" placeholder="Ex: 500"
        style="padding:10px; width:220px; border-radius:8px; margin-top:10px;"><br><br>

      <label>Moeda de pagamento:</label><br>
      <select id="moeda" style="padding:10px; width:240px; border-radius:8px; margin-top:10px;">
        <option value="SOL">Solana (SOL)</option>
        <option value="USDC">USDC</option>
        <option value="USD">D√≥lar (USD)</option>
        <option value="EUR">Euro (EUR)</option>
        <option value="CNY">Yuan (CNY)</option>
        <option value="BRL">Real (BRL)</option>
      </select>

      <div id="precoEstimado" style="margin-top:20px; font-size:1.2rem; color:#d4af37;"></div>

      <button class="cadastro-btn" onclick="simularPagamento()" style="margin-top:20px;">
        üí≥ Simular Pagamento
      </button>

      <div id="resultadoPagamento" style="margin-top:20px; color:#0f0;"></div>
    </div>

  </div>
</div>

<script>
// --- BANCOS ---
const dbAuth = new PouchDB('terra_dourada_autorizacoes');
const dbEleicoes = new PouchDB('terra_dourada_eleicoes');
const dbVotes = new PouchDB('terra_dourada_votos_local');
const dbMesarios = new PouchDB('terra_dourada_mesarios');
const dbCandidatos = new PouchDB('terra_dourada_candidatos');

// --- VARI√ÅVEL GLOBAL DA ELEI√á√ÉO ATUAL ---
let ELEICAO_ATUAL_ID = null;
let ELEICAO_ATUAL_DATA = null;

// --- CONFIGURA√á√ÉO DA API ---
let API_CONFIG = {
  baseURL: '',
  token: '',
  endpoints: {
    validarCPF: '/api/eleitores/validar',
    validarCodigo: '/api/eleitores/codigo'
  },
  configurado: false
};

// --- INICIALIZA√á√ÉO - CARREGAR ELEI√á√ÉO ---
async function inicializarPainel() {
  // Pegar ID da elei√ß√£o da URL
  const urlParams = new URLSearchParams(window.location.search);
  ELEICAO_ATUAL_ID = urlParams.get('id');
  
  console.log('üÜî ID da Elei√ß√£o:', ELEICAO_ATUAL_ID);
  
  if (!ELEICAO_ATUAL_ID) {
    console.error('‚ùå Nenhum ID de elei√ß√£o na URL!');
    document.getElementById('eleicaoHeader').innerHTML = `
      <h2 style="color: #ff4444;">‚ùå Erro: Nenhuma elei√ß√£o selecionada</h2>
      <p><a href="autoridade.html" class="voltar-btn">‚Üê Voltar para elei√ß√µes</a></p>
    `;
    return;
  }
  
  try {
    // Carregar dados da elei√ß√£o
    ELEICAO_ATUAL_DATA = await dbEleicoes.get(ELEICAO_ATUAL_ID);
    console.log('üìä Dados da elei√ß√£o:', ELEICAO_ATUAL_DATA);
    
    // Atualizar header
    document.getElementById('eleicaoNome').textContent = ELEICAO_ATUAL_DATA.name;
    document.getElementById('eleicaoId').textContent = ELEICAO_ATUAL_ID;
    document.getElementById('eleicaoInfo').innerHTML = `
      <strong>Cargos:</strong> ${ELEICAO_ATUAL_DATA.position} | 
      <strong>ID:</strong> ${ELEICAO_ATUAL_ID}
    `;
    
  } catch (error) {
    console.error('‚ùå Erro ao carregar elei√ß√£o:', error);
    document.getElementById('eleicaoHeader').innerHTML = `
      <h2 style="color: #ff4444;">‚ùå Erro: Elei√ß√£o n√£o encontrada</h2>
      <p><a href="autoridade.html" class="voltar-btn">‚Üê Voltar para elei√ß√µes</a></p>
    `;
  }
}

// --- FUN√á√ÉO PARA CADASTRAR CANDIDATO ---
function cadastrarCandidato() {
  if (!ELEICAO_ATUAL_ID) {
    alert('‚ùå Nenhuma elei√ß√£o selecionada!');
    return;
  }
  
  // ‚úÖ CORRE√á√ÉO: Enviar o ID da elei√ß√£o para o cadastro
  window.location.href = `cad_candidato.html?eleicao_id=${ELEICAO_ATUAL_ID}`;
}

// --- CONTROLE DE ABAS ---
function showTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('[id^="tab-"]').forEach(c => c.style.display = 'none');

  document.querySelector(`button[onclick="showTab('${tab}')"]`).classList.add('active');
  document.getElementById(`tab-${tab}`).style.display = 'block';

  if (tab === "candidatos") carregarCandidatos();
  if (tab === "mesarios") carregarMesarios();
  if (tab === "api-cliente") carregarConfigAPI();
  if (tab === "monitor") carregarResultados(); // ‚úÖ AGORA CARREGA RESULTADOS
}

// --- CARREGAR CANDIDATOS (FILTRADOS POR ELEI√á√ÉO) ---
async function carregarCandidatos() {
  try {
    const res = await dbCandidatos.allDocs({ include_docs: true });
    const cont = document.getElementById('candidatos-list');

    // ‚úÖ CORRE√á√ÉO: Filtrar candidatos apenas da elei√ß√£o atual
    const candidatosFiltrados = res.rows.filter(row => 
      row.doc.eleicao_id === ELEICAO_ATUAL_ID
    );

    console.log('üë• Candidatos filtrados:', candidatosFiltrados.length, 'de', res.rows.length);

    if (candidatosFiltrados.length === 0) {
      cont.innerHTML = `
        <div class="empty-state">
          <h3>Nenhum candidato cadastrado nesta elei√ß√£o</h3>
          <p>Clique em "Cadastrar Candidato" para come√ßar</p>
        </div>
      `;
      return;
    }

    cont.innerHTML = candidatosFiltrados.map(r => {
      const candidato = r.doc;
      const status = candidato.ativo ? 'status-ativa' : 'status-inativa';
      const statusText = candidato.ativo ? 'Ativo' : 'Inativo';
      
      return `
        <div class="candidato-card">
          ${candidato.foto ? `<img src="${candidato.foto}" class="candidato-foto" alt="${candidato.nome}">` : '<div class="candidato-foto" style="background:#333; display:flex; align-items:center; justify-content:center;">üë§</div>'}
          <h3>${candidato.nome}</h3>
          <p><strong>Partido:</strong> ${candidato.partido || 'N/A'}</p>
          <p><strong>Cargo:</strong> ${candidato.cargo || 'N/A'}</p>
          <p><strong>N√∫mero:</strong> ${candidato.numero || 'N/A'}</p>
          <span class="status-badge ${status}">${statusText}</span>
          
          <div style="margin-top: 15px;">
            <button class="action-btn" onclick="editarCandidato('${candidato._id}')">
              ‚úèÔ∏è Editar
            </button>
            <button class="delete-btn" onclick="excluirCandidato('${candidato._id}')">
              üóëÔ∏è Excluir
            </button>
          </div>
        </div>
      `;
    }).join('');
  } catch (error) {
    console.error('Erro ao carregar candidatos:', error);
    document.getElementById('candidatos-list').innerHTML = `
      <div class="empty-state">
        <h3>Erro ao carregar candidatos</h3>
        <p>Recarregue a p√°gina e tente novamente</p>
      </div>
    `;
  }
}

// ======================
// MONITOR DE RESULTADOS EM TEMPO REAL
// ======================

async function carregarResultados() {
  try {
    // Buscar todos os votos
    const todosVotos = await dbVotes.allDocs({ include_docs: true });
    const votosValidos = todosVotos.rows.filter(row => 
      row.doc.cid_pinata && !row.doc.erro && row.doc.candidato_id !== 'branco'
    );
    
    const votosBrancos = todosVotos.rows.filter(row => 
      row.doc.candidato_id === 'branco'
    );
    
    // Buscar candidatos ativos desta elei√ß√£o
    const todosCandidatos = await dbCandidatos.allDocs({ include_docs: true });
    const candidatosAtivos = todosCandidatos.rows.filter(row => 
      row.doc.ativo !== false && row.doc.eleicao_id === ELEICAO_ATUAL_ID
    );

    // Atualizar estat√≠sticas
    document.getElementById('total-votos').textContent = todosVotos.rows.length;
    document.getElementById('votos-validos').textContent = votosValidos.length;
    document.getElementById('votos-brancos').textContent = votosBrancos.length;
    document.getElementById('candidatos-ativos').textContent = candidatosAtivos.length;

    // Calcular votos por candidato
    const resultados = candidatosAtivos.map(candidatoRow => {
      const candidato = candidatoRow.doc;
      const votosDoCandidato = votosValidos.filter(voto => 
        voto.doc.candidato_id === candidato._id
      ).length;
      
      const porcentagem = votosValidos.length > 0 ? 
        ((votosDoCandidato / votosValidos.length) * 100).toFixed(1) : 0;
      
      return {
        candidato: candidato,
        votos: votosDoCandidato,
        porcentagem: porcentagem
      };
    });

    // Ordenar por mais votos
    resultados.sort((a, b) => b.votos - a.votos);

    // Gerar HTML dos resultados
    const container = document.getElementById('resultados-candidatos');
    
    if (resultados.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <h3>Nenhum candidato com votos ainda</h3>
          <p>Os resultados aparecer√£o aqui quando os votos come√ßarem a chegar</p>
        </div>
      `;
      return;
    }

    container.innerHTML = resultados.map((resultado, index) => {
      const candidato = resultado.candidato;
      const emojiPosicao = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : 'üìä';
      
      return `
        <div class="candidato-resultado">
          <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
            ${candidato.foto ? 
              `<img src="${candidato.foto}" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid #d4af37;">` : 
              `<div style="width: 60px; height: 60px; border-radius: 50%; background: #333; display: flex; align-items: center; justify-content: center; border: 2px solid #d4af37; font-size: 1.5rem;">üë§</div>`
            }
            
            <div style="flex: 1;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 style="color: #d4af37; margin: 0; font-size: 1.2rem;">
                  ${emojiPosicao} ${candidato.nome}
                </h3>
                <div style="font-size: 1.5rem; font-weight: bold; color: #d4af37;">
                  ${resultado.votos}
                </div>
              </div>
              <p style="margin: 5px 0; color: #ccc;">
                ${candidato.partido || 'Independ.'} ‚Ä¢ N¬∫ ${candidato.numero || '--'}
              </p>
            </div>
          </div>

          <!-- BARRA DE PROGRESSO -->
          <div class="barra-progresso">
            <div class="preenchimento-barra" style="width: ${resultado.porcentagem}%;">
              ${resultado.porcentagem}%
            </div>
          </div>

          <div style="display: flex; justify-content: space-between; color: #888; font-size: 0.9rem;">
            <span>${resultado.votos} votos</span>
            <span>${resultado.porcentagem}% dos votos v√°lidos</span>
          </div>
        </div>
      `;
    }).join('');

    // Mostrar gr√°fico de compara√ß√£o se tiver mais de 1 candidato
    if (resultados.length > 1) {
      document.getElementById('grafico-comparacao').style.display = 'block';
      gerarGraficoComparacao(resultados);
    } else {
      document.getElementById('grafico-comparacao').style.display = 'none';
    }

  } catch (error) {
    console.error('Erro ao carregar resultados:', error);
    document.getElementById('resultados-candidatos').innerHTML = `
      <div class="empty-state">
        <h3>Erro ao carregar resultados</h3>
        <p>Recarregue a p√°gina e tente novamente</p>
      </div>
    `;
  }
}

function gerarGraficoComparacao(resultados) {
  const container = document.getElementById('barras-comparacao');
  const maxVotos = Math.max(...resultados.map(r => r.votos));
  
  container.innerHTML = resultados.map(resultado => {
    const larguraBarra = maxVotos > 0 ? (resultado.votos / maxVotos) * 100 : 0;
    
    return `
      <div style="margin-bottom: 15px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
          <span style="color: #ccc; font-size: 0.9rem;">
            ${resultado.candidato.nome.split(' ')[0]} (${resultado.votos} votos)
          </span>
          <span style="color: #d4af37; font-weight: bold;">${resultado.porcentagem}%</span>
        </div>
        <div style="background: #333; border-radius: 5px; height: 25px; overflow: hidden;">
          <div style="
            background: linear-gradient(90deg, #d4af37, #ffd700);
            height: 100%; 
            width: ${larguraBarra}%;
            border-radius: 5px;
            transition: width 0.5s ease-in-out;
          "></div>
        </div>
      </div>
    `;
  }).join('');
}

function atualizarResultados() {
  carregarResultados();
  // Efeito visual de atualiza√ß√£o
  const btn = event.target;
  const originalText = btn.innerHTML;
  btn.innerHTML = '‚è≥ Atualizando...';
  btn.disabled = true;
  
  setTimeout(() => {
    btn.innerHTML = originalText;
    btn.disabled = false;
  }, 1000);
}

function exportarResultados() {
  alert('üìà Funcionalidade de exporta√ß√£o em PDF/Excel ser√° implementada em breve!');
}

// Atualizar automaticamente a cada 30 segundos
setInterval(() => {
  const monitorTab = document.getElementById('tab-monitor');
  if (monitorTab.style.display !== 'none') {
    carregarResultados();
  }
}, 30000);

// --- SISTEMA DE MES√ÅRIOS ---
async function carregarMesarios() {
  try {
    const res = await dbMesarios.allDocs({ include_docs: true });
    const cont = document.getElementById('lista-mesarios');

    // ‚úÖ CORRE√á√ÉO: Filtrar mes√°rios apenas da elei√ß√£o atual
    const mesariosFiltrados = res.rows.filter(row => 
      row.doc.eleicao_id === ELEICAO_ATUAL_ID
    );

    if (mesariosFiltrados.length === 0) {
      cont.innerHTML = `
        <div class="empty-state">
          <h3>Nenhum mes√°rio cadastrado nesta elei√ß√£o</h3>
          <p>Clique em "Cadastrar Novo Mes√°rio" para come√ßar</p>
        </div>
      `;
      return;
    }

    cont.innerHTML = mesariosFiltrados.map(r => {
      const mesario = r.doc;
      const status = mesario.ativo ? 'status-ativa' : 'status-inativa';
      const statusText = mesario.ativo ? 'Ativo' : 'Inativo';
      
      return `
        <div class="mesario-card">
          <h4>${mesario.nome}</h4>
          <div class="mesario-info"><strong>Usu√°rio:</strong> ${mesario.usuario}</div>
          <div class="mesario-info"><strong>Elei√ß√£o:</strong> ${mesario.eleicao_titulo || 'N/A'}</div>
          <div class="mesario-info"><strong>Criado:</strong> ${new Date(mesario.criado_em).toLocaleDateString()}</div>
          <span class="status-badge ${status}">${statusText}</span>
          
          <div style="margin-top: 10px;">
            <button class="action-btn" onclick="resetarSenhaMesario('${mesario._id}')">
              üîë Resetar Senha
            </button>
            <button class="action-btn" onclick="${mesario.ativo ? 'desativarMesario' : 'ativarMesario'}('${mesario._id}')">
              ${mesario.ativo ? 'üö´ Desativar' : '‚úÖ Ativar'}
            </button>
            <button class="delete-btn" onclick="excluirMesario('${mesario._id}')">
              üóëÔ∏è Excluir
            </button>
          </div>
        </div>
      `;
    }).join('');
  } catch (error) {
    console.error('Erro ao carregar mes√°rios:', error);
  }
}

async function criarNovoMesario() {
  if (!ELEICAO_ATUAL_DATA) {
    alert('‚ùå Nenhuma elei√ß√£o carregada!');
    return;
  }

  const nome = prompt('Nome completo do mes√°rio:');
  if (!nome) return;

  const usuario = prompt('Usu√°rio de acesso:');
  if (!usuario) return;

  // ‚úÖ CORRE√á√ÉO: Usar a elei√ß√£o atual automaticamente
  const eleicaoSelecionada = ELEICAO_ATUAL_DATA;
  
  // Gerar senha tempor√°ria
  const senhaTemporaria = Math.random().toString(36).substr(2, 10);
  
  const mesario = {
    _id: `mesario_${Date.now()}`,
    nome: nome,
    usuario: usuario,
    senha: senhaTemporaria,
    eleicao_id: eleicaoSelecionada._id,
    eleicao_titulo: eleicaoSelecionada.name, // ‚úÖ Usar .name em vez de .titulo
    ativo: true,
    criado_em: new Date().toISOString(),
    ultimo_acesso: null
  };

  await dbMesarios.put(mesario);

  // Mostrar credenciais
  const credenciais = `
    ‚úÖ Mes√°rio cadastrado com sucesso!

    üìã Credenciais de Acesso:
    üë§ Usu√°rio: ${usuario}
    üîë Senha: ${senhaTemporaria}
    üó≥Ô∏è Elei√ß√£o: ${eleicaoSelecionada.name}

    ‚ö†Ô∏è Salve estas credenciais com seguran√ßa!
    O mes√°rio usar√° estas credenciais para acessar o Ponto do Eleitor.
  `;

  alert(credenciais);
  carregarMesarios();
}

async function resetarSenhaMesario(mesarioId) {
  const novaSenha = Math.random().toString(36).substr(2, 10);
  const mesario = await dbMesarios.get(mesarioId);
  
  mesario.senha = novaSenha;
  await dbMesarios.put(mesario);
  
  alert(`Senha resetada!\nNova senha: ${novaSenha}\n\n‚ö†Ô∏è Compartilhe com o mes√°rio.`);
}

async function desativarMesario(mesarioId) {
  const mesario = await dbMesarios.get(mesarioId);
  mesario.ativo = false;
  await dbMesarios.put(mesario);
  carregarMesarios();
}

async function ativarMesario(mesarioId) {
  const mesario = await dbMesarios.get(mesarioId);
  mesario.ativo = true;
  await dbMesarios.put(mesario);
  carregarMesarios();
}

async function excluirMesario(mesarioId) {
  if (confirm('Tem certeza que deseja excluir este mes√°rio?')) {
    const mesario = await dbMesarios.get(mesarioId);
    await dbMesarios.remove(mesario);
    carregarMesarios();
  }
}

// --- FUN√á√ïES PARA CANDIDATOS ---
async function editarCandidato(candidatoId) {
  alert('Funcionalidade de edi√ß√£o ser√° implementada em breve!');
}

async function excluirCandidato(candidatoId) {
  if (confirm('Tem certeza que deseja excluir este candidato?')) {
    try {
      const candidato = await dbCandidatos.get(candidatoId);
      await dbCandidatos.remove(candidato);
      carregarCandidatos();
    } catch (error) {
      console.error('Erro ao excluir candidato:', error);
      alert('Erro ao excluir candidato!');
    }
  }
}

// --- API DO CLIENTE ---
function carregarConfigAPI() {
  const configSalva = localStorage.getItem('api_config_cliente');
  if (configSalva) {
    API_CONFIG = { ...API_CONFIG, ...JSON.parse(configSalva) };
    API_CONFIG.configurado = true;
    atualizarStatusAPI();
  }

  // Preencher campos
  document.getElementById('api-base-url').value = API_CONFIG.baseURL;
  document.getElementById('api-token').value = API_CONFIG.token;
  document.getElementById('endpoint-validar').value = API_CONFIG.endpoints.validarCPF;
  document.getElementById('endpoint-codigo').value = API_CONFIG.endpoints.validarCodigo;
}

function salvarConfigAPI() {
  const baseURL = document.getElementById('api-base-url').value;
  const token = document.getElementById('api-token').value;
  
  if (!baseURL || !token) {
    alert('Preencha a URL base e o token!');
    return;
  }
  
  API_CONFIG = {
    baseURL: baseURL,
    token: token,
    endpoints: {
      validarCPF: document.getElementById('endpoint-validar').value || '/api/eleitores/validar',
      validarCodigo: document.getElementById('endpoint-codigo').value || '/api/eleitores/codigo'
    },
    configurado: true
  };
  
  localStorage.setItem('api_config_cliente', JSON.stringify(API_CONFIG));
  atualizarStatusAPI();
  alert('‚úÖ Configura√ß√£o salva com sucesso!');
}

function testarConexaoAPI() {
  if (!API_CONFIG.configurado) {
    alert('Configure a API primeiro!');
    return;
  }
  
  // Simula√ß√£o de teste de conex√£o
  setTimeout(() => {
    alert('‚úÖ Conex√£o com API testada com sucesso!\n\nEm produ√ß√£o, validaria os endpoints reais.');
  }, 1000);
}

function atualizarStatusAPI() {
  const statusElement = document.getElementById('api-status');
  if (API_CONFIG.configurado) {
    statusElement.textContent = '‚úÖ API: Configurada';
    statusElement.className = 'api-status configurada';
  } else {
    statusElement.textContent = '‚ö†Ô∏è API: N√£o Configurada';
    statusElement.className = 'api-status nao-configurada';
  }
}

// ======================
//      PAGAMENTO - PRE√áOS ATUALIZADOS
// ======================
function calcularPrecoBRL(q) {
  if (q < 1000) return q * 0.10;      // 10 centavos por voto
  if (q < 100000) return q * 0.05;    // 5 centavos por voto  
  if (q < 1000000) return q * 0.03;   // 3 centavos por voto
  return q * 0.01;                    // 1 centavo por voto (acima de 1M)
}

function simularPagamento() {
  const q = parseInt(document.getElementById("quantidade").value);
  const moeda = document.getElementById("moeda").value;

  if (!q || q < 10) {
    alert("Escolha pelo menos 10 votos!");
    return;
  }

  const precoBRL = calcularPrecoBRL(q);

  document.getElementById("precoEstimado").textContent =
    `Pre√ßo total: R$ ${precoBRL.toFixed(2)} (${(precoBRL/q).toFixed(3)} por voto)`;

  document.getElementById("resultadoPagamento").textContent =
    `Pagamento SIMULADO em ${moeda} aprovado! Cr√©ditos liberados: ${q} votos`;
}

// INICIALIZA√á√ÉO
document.addEventListener("DOMContentLoaded", async () => {
  await inicializarPainel();
  carregarCandidatos();
  carregarConfigAPI();
});
</script>
</body>
</html>
