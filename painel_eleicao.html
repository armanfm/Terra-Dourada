<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel de Autoridade ‚Äî Terra Dourada</title>
  <script src="https://cdn.jsdelivr.net/npm/pouchdb@7.3.1/dist/pouchdb.min.js"></script>

  <style>
    body {
      background: #050703;
      color: #f5f5f5;
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }
    header {
      text-align: center;
      margin-bottom: 30px;
      border-bottom: 1px solid rgba(212,175,55,0.3);
      padding-bottom: 20px;
    }
    h1 {
      color: #d4af37;
      margin-bottom: 10px;
    }
    
    /* Abas */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .tab {
      background: transparent;
      border: 1px solid #d4af37;
      color: #d4af37;
      padding: 10px 20px;
      border-radius: 20px;
      cursor: pointer;
      transition: .3s;
    }
    .tab.active {
      background: rgba(212,175,55,0.2);
    }
    .tab:hover {
      background: rgba(212,175,55,0.1);
    }
    
    /* Conte√∫do principal */
    .content {
      background: #111;
      border-radius: 15px;
      padding: 30px;
      border: 1px solid rgba(212,175,55,0.3);
      min-height: 400px;
    }

    /* Grid de cards (para elei√ß√µes E candidatos) */
    .grid-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .card {
      background: #1a1a1a;
      border: 1px solid rgba(212,175,55,0.2);
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      transition: transform 0.3s, border-color 0.3s;
    }
    .card:hover {
      transform: translateY(-3px);
      border-color: #d4af37;
    }
    .card-foto {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      margin: 0 auto 15px;
      border: 2px solid #d4af37;
    }
    .card h3 {
      color: #d4af37;
      margin-bottom: 10px;
    }
    .card p {
      margin: 5px 0;
      color: #ccc;
      font-size: 0.9rem;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 15px;
      font-size: 0.8rem;
      margin: 5px 0;
    }
    .status-ativa {
      background: rgba(86, 171, 47, 0.2);
      color: #56ab2f;
      border: 1px solid #56ab2f;
    }
    .status-inativa {
      background: rgba(255, 68, 68, 0.2);
      color: #ff4444;
      border: 1px solid #ff4444;
    }

    /* Bot√µes de a√ß√£o */
    .action-buttons {
      margin-top: 15px;
      display: flex;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .action-btn {
      background: rgba(212,175,55,0.2);
      border: 1px solid #d4af37;
      color: #d4af37;
      padding: 6px 12px;
      border-radius: 15px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: .3s;
    }
    .action-btn:hover {
      background: rgba(212,175,55,0.4);
    }
    .delete-btn {
      background: #ff4444;
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 15px;
      cursor: pointer;
      font-size: 0.8rem;
    }
    .delete-btn:hover {
      background: #ff6666;
    }

    /* Bot√µes do header */
    .header-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    .candidato-btn {
      background: rgba(148, 0, 211, 0.2);
      border: 1px solid #9400d3;
      color: #9400d3;
      padding: 12px 25px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 1.1rem;
      transition: .3s;
    }
    .candidato-btn:hover {
      background: rgba(148, 0, 211, 0.4);
    }
    .auditor-btn {
      background: rgba(86, 171, 47, 0.2);
      border: 1px solid #56ab2f;
      color: #56ab2f;
      padding: 12px 25px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 1.1rem;
      transition: .3s;
    }
    .auditor-btn:hover {
      background: rgba(86, 171, 47, 0.4);
    }

    /* Estados vazios */
    .empty-state {
      text-align: center;
      color: #888;
      padding: 40px;
    }
    .empty-state h3 {
      color: #d4af37;
      margin-bottom: 10px;
    }

    /* Se√ß√µes espec√≠ficas */
    .auth-section {
      text-align: center;
      margin-top: 30px;
    }
    .auth-link {
      background: rgba(212,175,55,0.1);
      border: 1px dashed #d4af37;
      border-radius: 10px;
      padding: 15px;
      margin: 10px 0;
      word-break: break-all;
    }
    .generate-btn {
      background: transparent;
      border: 1px solid #d4af37;
      color: #d4af37;
      padding: 10px 20px;
      border-radius: 20px;
      cursor: pointer;
      margin: 10px;
    }
    .generate-btn:hover {
      background: rgba(212,175,55,0.2);
    }
    .cadastro-btn {
      background: rgba(212,175,55,0.2);
      border: 1px solid #d4af37;
      color: #d4af37;
      padding: 12px 25px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 1.1rem;
      margin-top: 20px;
    }
    .cadastro-btn:hover {
      background: rgba(212,175,55,0.4);
    }

    /* API Config */
    .api-config-section {
      background: rgba(212,175,55,0.05);
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #d4af37;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #d4af37;
      background: #1a1a1a;
      color: white;
    }
    .api-status {
      padding: 8px 15px;
      border-radius: 15px;
      font-size: 0.9rem;
      display: inline-block;
      margin: 10px 0;
    }
    .api-status.configurada {
      background: rgba(86, 171, 47, 0.2);
      border: 1px solid #56ab2f;
      color: #56ab2f;
    }
    .api-status.nao-configurada {
      background: rgba(212,175,55,0.2);
      border: 1px solid #d4af37;
      color: #d4af37;
    }

    /* Mes√°rios */
    .mesarios-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .mesario-card {
      background: #1a1a1a;
      border: 1px solid rgba(212,175,55,0.2);
      border-radius: 10px;
      padding: 15px;
    }
    .mesario-card h4 {
      color: #d4af37;
      margin: 0 0 10px 0;
    }
    .mesario-info {
      font-size: 0.9rem;
      color: #ccc;
      margin: 5px 0;
    }

    /* Monitor de votos */
    .authorized-votes {
      margin-top: 30px;
      background: rgba(212,175,55,0.05);
      border-radius: 10px;
      padding: 15px;
    }
    .vote-status {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    /* Pagamento */
    #precoEstimado {
      margin-top: 20px;
      font-size: 1.2rem;
      color: #d4af37;
    }
    #resultadoPagamento {
      margin-top: 20px;
      color: #0f0;
    }
  </style>
</head>

<body>

<div class="container">
  <header>
    <h1>üåç Painel de Autoridade ‚Äî Terra Dourada</h1>
    <p>Gerencie elei√ß√µes, candidatos e cr√©ditos</p>
    
    <div class="header-buttons">
      <button class="candidato-btn" onclick="window.location.href='cad_candidato.html'">
        üë§ Cadastrar Candidato
      </button>
      <button class="auditor-btn" onclick="window.location.href='auditor.html'">
        üëÅÔ∏è Painel do Auditor
      </button>
    </div>
  </header>

  <!-- BOT√ïES DAS ABAS -->
  <div class="tabs">
    <button class="tab active" onclick="showTab('candidatos')">üë• Candidatos</button>
    <button class="tab" onclick="showTab('mesarios')">üë• Mes√°rios</button>
    <button class="tab" onclick="showTab('api-cliente')">üîå API Cliente</button>
    <button class="tab" onclick="window.location.href='eleitor_point.html'">üîê Autorizar Votos</button>
    <button class="tab" onclick="showTab('monitor')">üëÅÔ∏è Monitorar Votos</button>
    <button class="tab" onclick="showTab('pagamento')">üí∞ Comprar Cr√©ditos</button>
  </div>

  <!-- CONTE√öDO -->
  <div class="content">

    <!-- ABA CANDIDATOS -->
    <div id="tab-candidatos">
      <h2>Lista de Candidatos Cadastrados</h2>
      <div id="candidatos-list" class="grid-cards"></div>
    </div>

    <!-- ABA MES√ÅRIOS -->
    <div id="tab-mesarios" style="display: none;">
      <h2>üë• Gerenciar Mes√°rios</h2>
      
      <div style="text-align: center; margin: 20px 0;">
        <button class="cadastro-btn" onclick="criarNovoMesario()">
          ‚ûï Cadastrar Novo Mes√°rio
        </button>
      </div>

      <div id="lista-mesarios" class="mesarios-grid"></div>
    </div>

    <!-- ABA API CLIENTE -->
    <div id="tab-api-cliente" style="display: none;">
      <h2>üîå Configurar API do Cliente</h2>
      
      <div class="api-config-section">
        <h3>‚öôÔ∏è Configura√ß√£o da API</h3>
        
        <div class="form-group">
          <label>URL Base da API *</label>
          <input type="text" id="api-base-url" placeholder="https://api.cliente.com" style="width: 100%;">
        </div>
        
        <div class="form-group">
          <label>Token de Autentica√ß√£o *</label>
          <input type="password" id="api-token" placeholder="Bearer token..." style="width: 100%;">
        </div>

        <h4 style="color: #d4af37; margin: 20px 0 10px 0;">Endpoints Personalizados</h4>
        
        <div class="form-group">
          <label>Valida√ß√£o de Eleitor</label>
          <input type="text" id="endpoint-validar" placeholder="/api/eleitores/validar" style="width: 100%;">
        </div>
        
        <div class="form-group">
          <label>Valida√ß√£o por C√≥digo</label>
          <input type="text" id="endpoint-codigo" placeholder="/api/eleitores/codigo" style="width: 100%;">
        </div>

        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button class="action-btn" onclick="salvarConfigAPI()">üíæ Salvar Configura√ß√£o</button>
          <button class="action-btn" onclick="testarConexaoAPI()">üîç Testar Conex√£o</button>
        </div>

        <div id="api-status" class="api-status nao-configurada">‚ö†Ô∏è API: N√£o Configurada</div>
      </div>
    </div>

    <!-- ABA AUTORIZA√á√ÉO -->
    <div id="tab-autorizacao" style="display: none;">
      <h2>Gerar Autoriza√ß√£o de Voto</h2>
      
      <div style="text-align: center; margin: 20px 0;">
        <button class="generate-btn" onclick="gerarLinkMesario()">
          üîó Gerar Link para Mes√°rio
        </button>
        <button class="generate-btn" onclick="gerarAutorizacao()">
          üé´ Gerar Autoriza√ß√£o Direta
        </button>
      </div>

      <div id="auth-links" class="auth-section"></div>
    </div>

    <!-- ABA MONITOR -->
    <div id="tab-monitor" style="display: none;">
      <h2>Votos Autorizados e Realizados</h2>
      <div id="authorized-votes" class="authorized-votes"></div>
    </div>

    <!-- ABA PAGAMENTO -->
    <div id="tab-pagamento" style="display: none;">
      <h2>üí∞ Comprar Cr√©ditos de Vota√ß√£o</h2>
      
      <label>Quantidade de votos:</label><br>
      <input id="quantidade" type="number" min="10" placeholder="Ex: 500"
        style="padding:10px; width:220px; border-radius:8px; margin-top:10px;"><br><br>

      <label>Moeda de pagamento:</label><br>
      <select id="moeda" style="padding:10px; width:240px; border-radius:8px; margin-top:10px;">
        <option value="SOL">Solana (SOL)</option>
        <option value="USDC">USDC</option>
        <option value="USD">D√≥lar (USD)</option>
        <option value="EUR">Euro (EUR)</option>
        <option value="CNY">Yuan (CNY)</option>
        <option value="BRL">Real (BRL)</option>
      </select>

      <div id="precoEstimado" style="margin-top:20px; font-size:1.2rem; color:#d4af37;"></div>

      <button class="cadastro-btn" onclick="simularPagamento()" style="margin-top:20px;">
        üí≥ Simular Pagamento
      </button>

      <div id="resultadoPagamento" style="margin-top:20px; color:#0f0;"></div>
    </div>

  </div>
</div>

<script>
// --- BANCOS ---
const dbAuth = new PouchDB('terra_dourada_autorizacoes');
const dbEleicoes = new PouchDB('terra_dourada_eleicoes');
const dbVotes = new PouchDB('terra_dourada_votos_local');
const dbMesarios = new PouchDB('terra_dourada_mesarios');
const dbCandidatos = new PouchDB('terra_dourada_candidatos');

// --- CONFIGURA√á√ÉO DA API ---
let API_CONFIG = {
  baseURL: '',
  token: '',
  endpoints: {
    validarCPF: '/api/eleitores/validar',
    validarCodigo: '/api/eleitores/codigo'
  },
  configurado: false
};

// --- CONTROLE DE ABAS ---
function showTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('[id^="tab-"]').forEach(c => c.style.display = 'none');

  document.querySelector(`button[onclick="showTab('${tab}')"]`).classList.add('active');
  document.getElementById(`tab-${tab}`).style.display = 'block';

  if (tab === "candidatos") carregarCandidatos();
  if (tab === "mesarios") carregarMesarios();
  if (tab === "api-cliente") carregarConfigAPI();
  if (tab === "monitor") carregarVotosAutorizados();
}

// --- CARREGAR CANDIDATOS (NOVO LAYOUT) ---
async function carregarCandidatos() {
  try {
    console.log('Carregando candidatos...');
    const res = await dbCandidatos.allDocs({ include_docs: true });
    console.log('Candidatos encontrados:', res.rows);
    
    const cont = document.getElementById('candidatos-list');

    if (res.rows.length === 0) {
      cont.innerHTML = `
        <div class="empty-state">
          <h3>Nenhum candidato cadastrado</h3>
          <p>Clique em "Cadastrar Candidato" para come√ßar</p>
        </div>
      `;
      return;
    }

    cont.innerHTML = res.rows.map(r => {
      const candidato = r.doc;
      console.log('Processando candidato:', candidato);
      
      const status = candidato.ativo ? 'status-ativa' : 'status-inativa';
      const statusText = candidato.ativo ? 'Ativo' : 'Inativo';
      
      return `
        <div class="card">
          ${candidato.foto ? `<img src="${candidato.foto}" class="card-foto" alt="${candidato.nome}">` : '<div class="card-foto" style="background:#333; display:flex; align-items:center; justify-content:center;">üë§</div>'}
          <h3>${candidato.nome || 'Sem nome'}</h3>
          <p><strong>Partido:</strong> ${candidato.partido || 'N/A'}</p>
          <p><strong>Cargo:</strong> ${candidato.cargo || 'N/A'}</p>
          <p><strong>N√∫mero:</strong> ${candidato.numero || 'N/A'}</p>
          <span class="status-badge ${status}">${statusText}</span>
          
          <div class="action-buttons">
            <button class="action-btn" onclick="editarCandidato('${candidato._id}')">
              ‚úèÔ∏è Editar
            </button>
            <button class="delete-btn" onclick="excluirCandidato('${candidato._id}')">
              üóëÔ∏è Excluir
            </button>
          </div>
        </div>
      `;
    }).join('');
  } catch (error) {
    console.error('Erro ao carregar candidatos:', error);
    document.getElementById('candidatos-list').innerHTML = `
      <div class="empty-state">
        <h3>Erro ao carregar candidatos</h3>
        <p>Recarregue a p√°gina e tente novamente</p>
        <p>Erro: ${error.message}</p>
      </div>
    `;
  }
}

// --- SISTEMA DE MES√ÅRIOS ---
async function carregarMesarios() {
  try {
    const res = await dbMesarios.allDocs({ include_docs: true });
    const cont = document.getElementById('lista-mesarios');

    if (res.rows.length === 0) {
      cont.innerHTML = `
        <div class="empty-state">
          <h3>Nenhum mes√°rio cadastrado</h3>
          <p>Clique em "Cadastrar Novo Mes√°rio" para come√ßar</p>
        </div>
      `;
      return;
    }

    cont.innerHTML = res.rows.map(r => {
      const mesario = r.doc;
      const status = mesario.ativo ? 'status-ativa' : 'status-inativa';
      const statusText = mesario.ativo ? 'Ativo' : 'Inativo';
      
      return `
        <div class="mesario-card">
          <h4>${mesario.nome}</h4>
          <div class="mesario-info"><strong>Usu√°rio:</strong> ${mesario.usuario}</div>
          <div class="mesario-info"><strong>Elei√ß√£o:</strong> ${mesario.eleicao_titulo || 'N/A'}</div>
          <div class="mesario-info"><strong>Criado:</strong> ${new Date(mesario.criado_em).toLocaleDateString()}</div>
          <span class="status-badge ${status}">${statusText}</span>
          
          <div style="margin-top: 10px;">
            <button class="action-btn" onclick="resetarSenhaMesario('${mesario._id}')">
              üîë Resetar Senha
            </button>
            <button class="action-btn" onclick="${mesario.ativo ? 'desativarMesario' : 'ativarMesario'}('${mesario._id}')">
              ${mesario.ativo ? 'üö´ Desativar' : '‚úÖ Ativar'}
            </button>
            <button class="delete-btn" onclick="excluirMesario('${mesario._id}')">
              üóëÔ∏è Excluir
            </button>
          </div>
        </div>
      `;
    }).join('');
  } catch (error) {
    console.error('Erro ao carregar mes√°rios:', error);
  }
}

async function criarNovoMesario() {
  // Buscar elei√ß√µes para sele√ß√£o
  const eleicoes = await dbEleicoes.allDocs({ include_docs: true });
  if (eleicoes.rows.length === 0) {
    alert('Cadastre uma elei√ß√£o primeiro!');
    return;
  }

  const nome = prompt('Nome completo do mes√°rio:');
  if (!nome) return;

  const usuario = prompt('Usu√°rio de acesso:');
  if (!usuario) return;

  // Selecionar elei√ß√£o
  let eleicaoOptions = 'Selecione a elei√ß√£o:\n';
  eleicoes.rows.forEach((row, index) => {
    eleicaoOptions += `${index + 1}. ${row.doc.titulo}\n`;
  });

  const eleicaoIndex = parseInt(prompt(eleicaoOptions)) - 1;
  if (isNaN(eleicaoIndex) || eleicaoIndex < 0 || eleicaoIndex >= eleicoes.rows.length) {
    alert('Sele√ß√£o inv√°lida!');
    return;
  }

  const eleicaoSelecionada = eleicoes.rows[eleicaoIndex].doc;
  
  // Gerar senha tempor√°ria
  const senhaTemporaria = Math.random().toString(36).substr(2, 10);
  
  const mesario = {
    _id: `mesario_${Date.now()}`,
    nome: nome,
    usuario: usuario,
    senha: senhaTemporaria, // Em produ√ß√£o, usar hash
    eleicao_id: eleicaoSelecionada._id,
    eleicao_titulo: eleicaoSelecionada.titulo,
    ativo: true,
    criado_em: new Date().toISOString(),
    ultimo_acesso: null
  };

  await dbMesarios.put(mesario);

  // Mostrar credenciais
  const credenciais = `
    ‚úÖ Mes√°rio cadastrado com sucesso!

    üìã Credenciais de Acesso:
    üë§ Usu√°rio: ${usuario}
    üîë Senha: ${senhaTemporaria}
    üó≥Ô∏è Elei√ß√£o: ${eleicaoSelecionada.titulo}

    ‚ö†Ô∏è Salve estas credenciais com seguran√ßa!
    O mes√°rio usar√° estas credenciais para acessar o Ponto do Eleitor.
  `;

  alert(credenciais);
  carregarMesarios();
}

async function resetarSenhaMesario(mesarioId) {
  const novaSenha = Math.random().toString(36).substr(2, 10);
  const mesario = await dbMesarios.get(mesarioId);
  
  mesario.senha = novaSenha;
  await dbMesarios.put(mesario);
  
  alert(`Senha resetada!\nNova senha: ${novaSenha}\n\n‚ö†Ô∏è Compartilhe com o mes√°rio.`);
}

async function desativarMesario(mesarioId) {
  const mesario = await dbMesarios.get(mesarioId);
  mesario.ativo = false;
  await dbMesarios.put(mesario);
  carregarMesarios();
}

async function ativarMesario(mesarioId) {
  const mesario = await dbMesarios.get(mesarioId);
  mesario.ativo = true;
  await dbMesarios.put(mesario);
  carregarMesarios();
}

async function excluirMesario(mesarioId) {
  if (confirm('Tem certeza que deseja excluir este mes√°rio?')) {
    const mesario = await dbMesarios.get(mesarioId);
    await dbMesarios.remove(mesario);
    carregarMesarios();
  }
}

// --- FUN√á√ïES PARA CANDIDATOS ---
async function editarCandidato(candidatoId) {
  alert('Funcionalidade de edi√ß√£o ser√° implementada em breve!');
}

async function excluirCandidato(candidatoId) {
  if (confirm('Tem certeza que deseja excluir este candidato?')) {
    try {
      const candidato = await dbCandidatos.get(candidatoId);
      await dbCandidatos.remove(candidato);
      carregarCandidatos();
    } catch (error) {
      console.error('Erro ao excluir candidato:', error);
      alert('Erro ao excluir candidato!');
    }
  }
}

// --- API DO CLIENTE ---
function carregarConfigAPI() {
  const configSalva = localStorage.getItem('api_config_cliente');
  if (configSalva) {
    API_CONFIG = { ...API_CONFIG, ...JSON.parse(configSalva) };
    API_CONFIG.configurado = true;
    atualizarStatusAPI();
  }

  // Preencher campos
  document.getElementById('api-base-url').value = API_CONFIG.baseURL;
  document.getElementById('api-token').value = API_CONFIG.token;
  document.getElementById('endpoint-validar').value = API_CONFIG.endpoints.validarCPF;
  document.getElementById('endpoint-codigo').value = API_CONFIG.endpoints.validarCodigo;
}

function salvarConfigAPI() {
  const baseURL = document.getElementById('api-base-url').value;
  const token = document.getElementById('api-token').value;
  
  if (!baseURL || !token) {
    alert('Preencha a URL base e o token!');
    return;
  }
  
  API_CONFIG = {
    baseURL: baseURL,
    token: token,
    endpoints: {
      validarCPF: document.getElementById('endpoint-validar').value || '/api/eleitores/validar',
      validarCodigo: document.getElementById('endpoint-codigo').value || '/api/eleitores/codigo'
    },
    configurado: true
  };
  
  localStorage.setItem('api_config_cliente', JSON.stringify(API_CONFIG));
  atualizarStatusAPI();
  alert('‚úÖ Configura√ß√£o salva com sucesso!');
}

function testarConexaoAPI() {
  if (!API_CONFIG.configurado) {
    alert('Configure a API primeiro!');
    return;
  }
  
  // Simula√ß√£o de teste de conex√£o
  setTimeout(() => {
    alert('‚úÖ Conex√£o com API testada com sucesso!\n\nEm produ√ß√£o, validaria os endpoints reais.');
  }, 1000);
}

function atualizarStatusAPI() {
  const statusElement = document.getElementById('api-status');
  if (API_CONFIG.configurado) {
    statusElement.textContent = '‚úÖ API: Configurada';
    statusElement.className = 'api-status configurada';
  } else {
    statusElement.textContent = '‚ö†Ô∏è API: N√£o Configurada';
    statusElement.className = 'api-status nao-configurada';
  }
}

// --- AUTORIZA√á√ÉO DE VOTOS ---
async function gerarLinkMesario() {
  const eleicoes = await dbEleicoes.allDocs({ include_docs: true });
  if (eleicoes.rows.length === 0) {
    alert('Cadastre uma elei√ß√£o primeiro!');
    return;
  }

  let eleicaoOptions = 'Selecione a elei√ß√£o:\n';
  eleicoes.rows.forEach((row, index) => {
    eleicaoOptions += `${index + 1}. ${row.doc.titulo}\n`;
  });

  const eleicaoIndex = parseInt(prompt(eleicaoOptions)) - 1;
  if (isNaN(eleicaoIndex) || eleicaoIndex < 0 || eleicaoIndex >= eleicoes.rows.length) {
    alert('Sele√ß√£o inv√°lida!');
    return;
  }

  const eleicao = eleicoes.rows[eleicaoIndex].doc;
  const token = crypto.randomUUID();
  
  await dbAuth.put({
    _id: token,
    token: token,
    eleicao_id: eleicao._id,
    tipo: 'acesso_mesario',
    created_at: new Date().toISOString(),
    expires_at: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(), // 24h
    usado: false
  });

  const mesarioURL = `${window.location.origin}/eleitor_point.html?auth=${token}&eleicao=${eleicao._id}`;
  
  document.getElementById("auth-links").innerHTML += `
    <div class="auth-link">
      <h4>üîó Link para Mes√°rio - ${eleicao.titulo}</h4>
      <a href="${mesarioURL}" target="_blank">${mesarioURL}</a><br>
      <small>Expira em: ${new Date(Date.now() + 24 * 60 * 60 * 1000).toLocaleString()}</small>
      <button class="action-btn" onclick="copiarLink('${mesarioURL}')" style="margin-top: 10px;">
        üìã Copiar Link
      </button>
    </div>
  `;
}

async function gerarAutorizacao() {
  const token = crypto.randomUUID();
  const expiresAt = new Date(Date.now() + 3600000);

  await dbAuth.put({
    _id: token,
    token,
    created_at: new Date().toISOString(),
    expires_at: expiresAt.toISOString(),
    used: false
  });

  const voteURL = `${window.location.origin}/voto.html?auth=${token}`;

  document.getElementById("auth-links").innerHTML += `
    <div class="auth-link">
      üîó <a href="${voteURL}" target="_blank">${voteURL}</a><br>
      <small>Expira: ${expiresAt.toLocaleTimeString()}</small>
    </div>
  `;
}

function copiarLink(link) {
  navigator.clipboard.writeText(link);
  alert('‚úÖ Link copiado!');
}

// --- FUN√á√ïES EXISTENTES MANTIDAS ---
async function carregarVotosAutorizados() {
  const auths = await dbAuth.allDocs({ include_docs: true });
  const votes = await dbVotes.allDocs({ include_docs: true });

  document.getElementById("authorized-votes").innerHTML =
    auths.rows.map(r => {
      const v = votes.rows.find(x => x.doc.auth_token === r.doc.token);
      return `
        <div class="vote-status">
          <div>
            Token: ${r.doc.token.slice(0,8)}...
          </div>
          <div>${v ? "‚úÖ Votou" : "‚è≥ Pendente"}</div>
        </div>
      `;
    }).join('');
}

// ======================
//      PAGAMENTO - PRE√áOS ATUALIZADOS
// ======================
function calcularPrecoBRL(q) {
  if (q < 1000) return q * 0.10;      // 10 centavos por voto
  if (q < 100000) return q * 0.05;    // 5 centavos por voto  
  if (q < 1000000) return q * 0.03;   // 3 centavos por voto
  return q * 0.01;                    // 1 centavo por voto (acima de 1M)
}

function simularPagamento() {
  const q = parseInt(document.getElementById("quantidade").value);
  const moeda = document.getElementById("moeda").value;

  if (!q || q < 10) {
    alert("Escolha pelo menos 10 votos!");
    return;
  }

  const precoBRL = calcularPrecoBRL(q);

  document.getElementById("precoEstimado").textContent =
    `Pre√ßo total: R$ ${precoBRL.toFixed(2)} (${(precoBRL/q).toFixed(3)} por voto)`;

  document.getElementById("resultadoPagamento").textContent =
    `Pagamento SIMULADO em ${moeda} aprovado! Cr√©ditos liberados: ${q} votos`;
}

// INICIALIZA√á√ÉO
document.addEventListener("DOMContentLoaded", () => {
  carregarCandidatos();
  carregarConfigAPI();
});
</script>
</body>
</html>
