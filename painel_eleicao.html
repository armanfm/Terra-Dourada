<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel de Autoridade ‚Äî Terra Dourada</title>
  <script src="https://cdn.jsdelivr.net/npm/pouchdb@7.3.1/dist/pouchdb.min.js"></script>

  <style>
    /* ESTILOS EXISTENTES MANTIDOS */
    body {
      background: #050703;
      color: #f5f5f5;
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }
    header {
      text-align: center;
      margin-bottom: 30px;
      border-bottom: 1px solid rgba(212,175,55,0.3);
      padding-bottom: 20px;
    }
    h1 {
      color: #d4af37;
      margin-bottom: 10px;
    }
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .tab {
      background: transparent;
      border: 1px solid #d4af37;
      color: #d4af37;
      padding: 10px 20px;
      border-radius: 20px;
      cursor: pointer;
      transition: .3s;
    }
    .tab.active {
      background: rgba(212,175,55,0.2);
    }
    .tab:hover {
      background: rgba(212,175,55,0.1);
    }
    .content {
      background: #111;
      border-radius: 15px;
      padding: 30px;
      border: 1px solid rgba(212,175,55,0.3);
      min-height: 400px;
    }
    
    /* NOVOS ESTILOS PARA COMPARTILHAMENTO */
    .share-btn {
      background: rgba(30, 144, 255, 0.2);
      border: 1px solid #1e90ff;
      color: #1e90ff;
      padding: 12px 25px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 1.1rem;
      margin-top: 20px;
      transition: .3s;
    }
    .share-btn:hover {
      background: rgba(30, 144, 255, 0.4);
    }
    
    .share-section {
      background: rgba(30, 144, 255, 0.05);
      border: 1px dashed #1e90ff;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      text-align: center;
    }
    
    .share-link {
      background: rgba(30, 144, 255, 0.1);
      border: 1px solid #1e90ff;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      word-break: break-all;
      text-align: left;
    }

    .header-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    /* ESTILOS EXISTENTES MANTIDOS */
    .candidatos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .candidato-card {
      background: #1a1a1a;
      border: 1px solid rgba(212,175,55,0.2);
      border-radius: 10px;
      padding: 20px;
      text-align: center;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 15px;
      font-size: 0.8rem;
      margin: 5px 0;
    }
    .status-ativa {
      background: rgba(86, 171, 47, 0.2);
      color: #56ab2f;
      border: 1px solid #56ab2f;
    }
    .status-inativa {
      background: rgba(255, 68, 68, 0.2);
      color: #ff4444;
      border: 1px solid #ff4444;
    }
    .action-btn {
      background: rgba(212,175,55,0.2);
      border: 1px solid #d4af37;
      color: #d4af37;
      padding: 8px 16px;
      border-radius: 15px;
      cursor: pointer;
      margin: 5px;
      font-size: 0.9rem;
      transition: .3s;
    }
    .action-btn:hover {
      background: rgba(212,175,55,0.4);
    }
    .empty-state {
      text-align: center;
      color: #888;
      padding: 40px;
    }
    .eleicao-header {
      background: rgba(212,175,55,0.1);
      border: 1px solid #d4af37;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      text-align: center;
    }
  </style>
</head>

<body>

<div class="container">
  <header>
    <h1>üåç Painel de Autoridade ‚Äî Terra Dourada</h1>
    <p>Gerencie elei√ß√µes, candidatos e cr√©ditos</p>
    
    <!-- INFO DA ELEI√á√ÉO ATUAL -->
    <div class="eleicao-header" id="eleicaoHeader">
      <h2 id="eleicaoNome">Carregando elei√ß√£o...</h2>
      <p id="eleicaoInfo">ID: <span id="eleicaoId">-</span></p>
      
      <!-- BOT√ÉO DE COMPARTILHAMENTO NO HEADER -->
      <button class="share-btn" onclick="showTab('compartilhar')">
        üîó Compartilhar Esta Elei√ß√£o
      </button>
    </div>
    
    <div class="header-buttons">
      <button class="candidato-btn" onclick="cadastrarCandidato()">
        üë§ Cadastrar Candidato
      </button>
      <button class="auditor-btn" onclick="window.location.href='auditor.html'">
        üëÅÔ∏è Painel do Auditor
      </button>
      <button class="share-btn" onclick="showTab('compartilhar')">
        üì§ Compartilhar
      </button>
    </div>
  </header>

  <!-- BOT√ïES DAS ABAS -->
  <div class="tabs">
    <button class="tab active" onclick="showTab('candidatos')">üë• Candidatos</button>
    <button class="tab" onclick="showTab('mesarios')">üë• Mes√°rios</button>
    <button class="tab" onclick="showTab('api-cliente')">üîå API Cliente</button>
    <button class="tab" onclick="window.location.href='eleitor_point.html?eleicao=' + ELEICAO_ATUAL_ID">üîê Autorizar Votos</button>
    <button class="tab" onclick="showTab('monitor')">üëÅÔ∏è Monitorar Votos</button>
    <button class="tab" onclick="showTab('pagamento')">üí∞ Comprar Cr√©ditos</button>
    <button class="tab" onclick="showTab('compartilhar')">üì§ Compartilhar</button>
  </div>

  <!-- CONTE√öDO -->
  <div class="content">

    <!-- ABA CANDIDATOS -->
    <div id="tab-candidatos">
      <h2>Lista de Candidatos Cadastrados</h2>
      <div id="candidatos-list" class="candidatos-grid"></div>
    </div>

    <!-- ABA COMPARTILHAMENTO -->
    <div id="tab-compartilhar" style="display: none;">
      <h2>üì§ Compartilhar Elei√ß√£o</h2>
      
      <div class="share-section">
        <h3>üîó Links de Compartilhamento</h3>
        <p>Gere links para compartilhar esta elei√ß√£o com diferentes p√∫blicos:</p>
        
        <button class="action-btn" onclick="gerarLinkPublico()">
          üåê Link P√∫blico
        </button>
        <button class="action-btn" onclick="gerarLinkMesarios()">
          üë• Link para Mes√°rios
        </button>
        <button class="action-btn" onclick="gerarLinkAuditores()">
          üëÅÔ∏è Link para Auditores
        </button>
        <button class="action-btn" onclick="gerarLinkCandidatos()">
          üë§ Link para Candidatos
        </button>
        
        <div id="share-links" class="auth-section"></div>
      </div>
    </div>

    <!-- ABA MES√ÅRIOS -->
    <div id="tab-mesarios" style="display: none;">
      <h2>üë• Gerenciar Mes√°rios</h2>
      <div style="text-align: center; margin: 20px 0;">
        <button class="cadastro-btn" onclick="criarNovoMesario()">
          ‚ûï Cadastrar Novo Mes√°rio
        </button>
      </div>
      <div id="lista-mesarios" class="mesarios-grid"></div>
    </div>

    <!-- ABA API CLIENTE -->
    <div id="tab-api-cliente" style="display: none;">
      <h2>üîå Configurar API do Cliente</h2>
      <div class="api-config-section">
        <!-- Conte√∫do da API -->
      </div>
    </div>

    <!-- ABA MONITOR -->
    <div id="tab-monitor" style="display: none;">
      <h2>Votos Autorizados e Realizados</h2>
      <div id="authorized-votes" class="authorized-votes"></div>
    </div>

    <!-- ABA PAGAMENTO -->
    <div id="tab-pagamento" style="display: none;">
      <h2>üí∞ Comprar Cr√©ditos de Vota√ß√£o</h2>
      <!-- Conte√∫do do pagamento -->
    </div>

  </div>
</div>

<script>
// --- BANCOS ---
const dbAuth = new PouchDB('terra_dourada_autorizacoes');
const dbEleicoes = new PouchDB('terra_dourada_eleicoes');
const dbVotes = new PouchDB('terra_dourada_votos_local');
const dbMesarios = new PouchDB('terra_dourada_mesarios');
const dbCandidatos = new PouchDB('terra_dourada_candidatos');

// --- VARI√ÅVEL GLOBAL DA ELEI√á√ÉO ATUAL ---
let ELEICAO_ATUAL_ID = null;
let ELEICAO_ATUAL_DATA = null;

// --- CONFIGURA√á√ÉO DA API ---
let API_CONFIG = {
  baseURL: '',
  token: '',
  endpoints: {
    validarCPF: '/api/eleitores/validar',
    validarCodigo: '/api/eleitores/codigo'
  },
  configurado: false
};

// --- INICIALIZA√á√ÉO - CARREGAR ELEI√á√ÉO ---
async function inicializarPainel() {
  const urlParams = new URLSearchParams(window.location.search);
  ELEICAO_ATUAL_ID = urlParams.get('id');
  
  console.log('üÜî ID da Elei√ß√£o:', ELEICAO_ATUAL_ID);
  
  if (!ELEICAO_ATUAL_ID) {
    console.error('‚ùå Nenhum ID de elei√ß√£o na URL!');
    document.getElementById('eleicaoHeader').innerHTML = `
      <h2 style="color: #ff4444;">‚ùå Erro: Nenhuma elei√ß√£o selecionada</h2>
      <p><a href="autoridade.html" class="voltar-btn">‚Üê Voltar para elei√ß√µes</a></p>
    `;
    return;
  }
  
  try {
    ELEICAO_ATUAL_DATA = await dbEleicoes.get(ELEICAO_ATUAL_ID);
    console.log('üìä Dados da elei√ß√£o:', ELEICAO_ATUAL_DATA);
    
    document.getElementById('eleicaoNome').textContent = ELEICAO_ATUAL_DATA.name;
    document.getElementById('eleicaoId').textContent = ELEICAO_ATUAL_ID;
    document.getElementById('eleicaoInfo').innerHTML = `
      <strong>Cargos:</strong> ${ELEICAO_ATUAL_DATA.position} | 
      <strong>ID:</strong> ${ELEICAO_ATUAL_ID}
    `;
    
  } catch (error) {
    console.error('‚ùå Erro ao carregar elei√ß√£o:', error);
    document.getElementById('eleicaoHeader').innerHTML = `
      <h2 style="color: #ff4444;">‚ùå Erro: Elei√ß√£o n√£o encontrada</h2>
      <p><a href="autoridade.html" class="voltar-btn">‚Üê Voltar para elei√ß√µes</a></p>
    `;
  }
}

// --- FUN√á√ïES DE COMPARTILHAMENTO ---
function gerarLinkCompartilhamento() {
  showTab('compartilhar');
}

async function gerarLinkPublico() {
  if (!ELEICAO_ATUAL_DATA) {
    alert('‚ùå Nenhuma elei√ß√£o carregada!');
    return;
  }

  const linkPublico = `${window.location.origin}/publico.html?eleicao=${ELEICAO_ATUAL_ID}`;
  
  exibirLinkCompartilhamento(
    "üåê Link P√∫blico", 
    linkPublico, 
    "Para visualiza√ß√£o p√∫blica da elei√ß√£o (somente leitura)",
    "publico"
  );
}

async function gerarLinkMesarios() {
  if (!ELEICAO_ATUAL_DATA) {
    alert('‚ùå Nenhuma elei√ß√£o carregada!');
    return;
  }

  const token = crypto.randomUUID();
  
  await dbAuth.put({
    _id: token,
    token: token,
    eleicao_id: ELEICAO_ATUAL_ID,
    tipo: 'acesso_mesario',
    created_at: new Date().toISOString(),
    expires_at: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(), // 7 dias
    usado: false
  });

  const linkMesarios = `${window.location.origin}/mesarios.html?auth=${token}&eleicao=${ELEICAO_ATUAL_ID}`;
  
  exibirLinkCompartilhamento(
    "üë• Link para Mes√°rios", 
    linkMesarios, 
    "Acesso completo para mes√°rios gerenciarem vota√ß√£o",
    "mesarios"
  );
}

async function gerarLinkAuditores() {
  if (!ELEICAO_ATUAL_DATA) {
    alert('‚ùå Nenhuma elei√ß√£o carregada!');
    return;
  }

  const token = crypto.randomUUID();
  
  await dbAuth.put({
    _id: token,
    token: token,
    eleicao_id: ELEICAO_ATUAL_ID,
    tipo: 'acesso_auditor',
    created_at: new Date().toISOString(),
    expires_at: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(), // 30 dias
    usado: false
  });

  const linkAuditores = `${window.location.origin}/auditor.html?auth=${token}&eleicao=${ELEICAO_ATUAL_ID}`;
  
  exibirLinkCompartilhamento(
    "üëÅÔ∏è Link para Auditores", 
    linkAuditores, 
    "Acesso para auditores visualizarem resultados e logs",
    "auditor"
  );
}

async function gerarLinkCandidatos() {
  if (!ELEICAO_ATUAL_DATA) {
    alert('‚ùå Nenhuma elei√ß√£o carregada!');
    return;
  }

  const token = crypto.randomUUID();
  
  await dbAuth.put({
    _id: token,
    token: token,
    eleicao_id: ELEICAO_ATUAL_ID,
    tipo: 'acesso_candidato',
    created_at: new Date().toISOString(),
    expires_at: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(), // 30 dias
    usado: false
  });

  const linkCandidatos = `${window.location.origin}/candidato_painel.html?auth=${token}&eleicao=${ELEICAO_ATUAL_ID}`;
  
  exibirLinkCompartilhamento(
    "üë§ Link para Candidatos", 
    linkCandidatos, 
    "Acesso para candidatos acompanharem suas vota√ß√µes",
    "candidato"
  );
}

function exibirLinkCompartilhamento(titulo, link, descricao, tipo) {
  const shareContainer = document.getElementById("share-links");
  
  const linkElement = `
    <div class="share-link">
      <h4>${titulo}</h4>
      <p><small>${descricao}</small></p>
      <a href="${link}" target="_blank">${link}</a>
      <div style="margin-top: 10px;">
        <button class="action-btn" onclick="copiarLink('${link}')">
          üìã Copiar Link
        </button>
        <button class="action-btn" onclick="compartilharWhatsApp('${link}', '${titulo}')">
          üí¨ WhatsApp
        </button>
        <button class="action-btn" onclick="compartilharEmail('${link}', '${titulo}')">
          üìß E-mail
        </button>
        ${tipo === 'publico' ? `
        <button class="action-btn" onclick="gerarQRCode('${link}')">
          üì± QR Code
        </button>
        ` : ''}
      </div>
    </div>
  `;
  
  shareContainer.innerHTML += linkElement;
}

// --- FUN√á√ïES AUXILIARES DE COMPARTILHAMENTO ---
function copiarLink(link) {
  navigator.clipboard.writeText(link).then(() => {
    alert('‚úÖ Link copiado para a √°rea de transfer√™ncia!');
  }).catch(err => {
    console.error('Erro ao copiar:', err);
    // Fallback para navegadores antigos
    const textArea = document.createElement('textarea');
    textArea.value = link;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
    alert('‚úÖ Link copiado!');
  });
}

function compartilharWhatsApp(link, titulo) {
  const texto = `Confira esta elei√ß√£o: ${titulo}\n\n${link}`;
  const url = `https://wa.me/?text=${encodeURIComponent(texto)}`;
  window.open(url, '_blank');
}

function compartilharEmail(link, titulo) {
  const assunto = `Convite: ${titulo}`;
  const corpo = `Ol√°,\n\nConvido voc√™ para acessar esta elei√ß√£o:\n\n${titulo}\n\nLink de acesso: ${link}\n\nAtenciosamente.`;
  const url = `mailto:?subject=${encodeURIComponent(assunto)}&body=${encodeURIComponent(corpo)}`;
  window.location.href = url;
}

function gerarQRCode(link) {
  const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(link)}`;
  
  const qrWindow = window.open('', '_blank');
  qrWindow.document.write(`
    <html>
      <head><title>QR Code - ${ELEICAO_ATUAL_DATA?.name || 'Elei√ß√£o'}</title></head>
      <body style="text-align: center; padding: 20px; font-family: Arial;">
        <h2>üì± QR Code para Compartilhamento</h2>
        <p><strong>${ELEICAO_ATUAL_DATA?.name || 'Elei√ß√£o'}</strong></p>
        <img src="${qrCodeUrl}" alt="QR Code">
        <p><small>Escaneie este QR Code para acessar a elei√ß√£o</small></p>
        <p><a href="${link}" target="_blank">${link}</a></p>
        <button onclick="window.print()" style="padding: 10px 20px; margin: 10px;">üñ®Ô∏è Imprimir</button>
        <button onclick="window.close()" style="padding: 10px 20px; margin: 10px;">‚ùå Fechar</button>
      </body>
    </html>
  `);
}

// --- CONTROLE DE ABAS ---
function showTab(tab) {
  // Remover active de todas as tabs
  document.querySelectorAll('.tab').forEach(t => {
    t.classList.remove('active');
  });
  
  // Esconder todo conte√∫do
  document.querySelectorAll('[id^="tab-"]').forEach(c => {
    c.style.display = 'none';
  });

  // Ativar tab clicada
  const tabButton = document.querySelector(`.tab[onclick="showTab('${tab}')"]`);
  if (tabButton) {
    tabButton.classList.add('active');
  }

  // Mostrar conte√∫do da tab
  const tabContent = document.getElementById(`tab-${tab}`);
  if (tabContent) {
    tabContent.style.display = 'block';
  }

  // Carregar conte√∫do espec√≠fico se necess√°rio
  if (tab === "candidatos") carregarCandidatos();
  if (tab === "mesarios") carregarMesarios();
  if (tab === "api-cliente") carregarConfigAPI();
  if (tab === "monitor") carregarVotosAutorizados();
  if (tab === "compartilhar") {
    document.getElementById("share-links").innerHTML = `
      <div class="empty-state">
        <p>Gere links de compartilhamento usando os bot√µes acima</p>
      </div>
    `;
  }
}

// --- FUN√á√ÉO PARA CADASTRAR CANDIDATO ---
function cadastrarCandidato() {
  if (!ELEICAO_ATUAL_ID) {
    alert('‚ùå Nenhuma elei√ß√£o selecionada!');
    return;
  }
  
  window.location.href = `cad_candidato.html?eleicao_id=${ELEICAO_ATUAL_ID}`;
}

// --- CARREGAR CANDIDATOS ---
async function carregarCandidatos() {
  try {
    const res = await dbCandidatos.allDocs({ include_docs: true });
    const cont = document.getElementById('candidatos-list');

    const candidatosFiltrados = res.rows.filter(row => 
      row.doc.eleicao_id === ELEICAO_ATUAL_ID
    );

    if (candidatosFiltrados.length === 0) {
      cont.innerHTML = `
        <div class="empty-state">
          <h3>Nenhum candidato cadastrado nesta elei√ß√£o</h3>
          <p>Clique em "Cadastrar Candidato" para come√ßar</p>
        </div>
      `;
      return;
    }

    cont.innerHTML = candidatosFiltrados.map(r => {
      const candidato = r.doc;
      const status = candidato.ativo ? 'status-ativa' : 'status-inativa';
      const statusText = candidato.ativo ? 'Ativo' : 'Inativo';
      
      return `
        <div class="candidato-card">
          ${candidato.foto ? `<img src="${candidato.foto}" class="candidato-foto" alt="${candidato.nome}">` : '<div class="candidato-foto" style="background:#333; display:flex; align-items:center; justify-content:center;">üë§</div>'}
          <h3>${candidato.nome}</h3>
          <p><strong>Partido:</strong> ${candidato.partido || 'N/A'}</p>
          <p><strong>Cargo:</strong> ${candidato.cargo || 'N/A'}</p>
          <p><strong>N√∫mero:</strong> ${candidato.numero || 'N/A'}</p>
          <span class="status-badge ${status}">${statusText}</span>
          
          <div style="margin-top: 15px;">
            <button class="action-btn" onclick="editarCandidato('${candidato._id}')">
              ‚úèÔ∏è Editar
            </button>
            <button class="delete-btn" onclick="excluirCandidato('${candidato._id}')">
              üóëÔ∏è Excluir
            </button>
          </div>
        </div>
      `;
    }).join('');
  } catch (error) {
    console.error('Erro ao carregar candidatos:', error);
    document.getElementById('candidatos-list').innerHTML = `
      <div class="empty-state">
        <h3>Erro ao carregar candidatos</h3>
        <p>Recarregue a p√°gina e tente novamente</p>
      </div>
    `;
  }
}

// --- FUN√á√ïES EXISTENTES (simplificadas) ---
async function carregarMesarios() {
  // Sua implementa√ß√£o existente
}

async function carregarConfigAPI() {
  // Sua implementa√ß√£o existente
}

async function carregarVotosAutorizados() {
  // Sua implementa√ß√£o existente
}

function editarCandidato(id) {
  alert('Editar candidato: ' + id);
}

function excluirCandidato(id) {
  if (confirm('Tem certeza que deseja excluir este candidato?')) {
    alert('Excluir candidato: ' + id);
  }
}

// INICIALIZA√á√ÉO
document.addEventListener("DOMContentLoaded", async () => {
  await inicializarPainel();
  carregarCandidatos();
});
</script>
</body>
</html>
