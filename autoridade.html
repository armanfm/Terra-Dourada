<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel de Autoridade ‚Äî Terra Dourada</title>
  <script src="https://cdn.jsdelivr.net/npm/pouchdb@7.3.1/dist/pouchdb.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    body {
      background: #050703;
      color: #f5f5f5;
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }
    header {
      text-align: center;
      margin-bottom: 30px;
      border-bottom: 1px solid rgba(212,175,55,0.3);
      padding-bottom: 20px;
    }
    h1 {
      color: #d4af37;
      margin-bottom: 10px;
    }
    
    /* Abas */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .tab {
      background: transparent;
      border: 1px solid #d4af37;
      color: #d4af37;
      padding: 12px 25px;
      border-radius: 20px;
      cursor: pointer;
      transition: .3s;
      font-size: 1rem;
    }
    .tab.active {
      background: rgba(212,175,55,0.2);
    }
    .tab:hover {
      background: rgba(212,175,55,0.1);
    }
    
    /* BOT√ÉO P2P SOCIAL - VERDE */
    .tab-p2p {
      background: transparent;
      border: 1px solid #56ab2f;
      color: #56ab2f;
      padding: 12px 25px;
      border-radius: 20px;
      cursor: pointer;
      transition: .3s;
      font-size: 1rem;
    }
    .tab-p2p:hover {
      background: rgba(86, 171, 47, 0.1);
    }
    .tab-p2p.active {
      background: rgba(86, 171, 47, 0.2);
    }

    /* BOT√ÉO EDITAR PERFIL - AZUL */
    .tab-perfil {
      background: transparent;
      border: 1px solid #2d8cf0;
      color: #2d8cf0;
      padding: 12px 25px;
      border-radius: 20px;
      cursor: pointer;
      transition: .3s;
      font-size: 1rem;
    }
    .tab-perfil:hover {
      background: rgba(45, 140, 240, 0.1);
    }
    .tab-perfil.active {
      background: rgba(45, 140, 240, 0.2);
    }

    /* Conte√∫do principal */
    .content {
      background: #111;
      border-radius: 15px;
      padding: 40px;
      border: 1px solid rgba(212,175,55,0.3);
      min-height: 500px;
    }

    /* Grid de elei√ß√µes */
    .eleicoes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 25px;
    }
    .eleicao-card {
      background: #1a1a1a;
      border: 1px solid rgba(212,175,55,0.3);
      border-radius: 15px;
      padding: 25px;
      text-align: center;
      transition: transform 0.3s, border-color 0.3s;
      cursor: pointer;
    }
    .eleicao-card:hover {
      transform: translateY(-5px);
      border-color: #d4af37;
    }
    .eleicao-logo {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #d4af37;
      margin: 0 auto 15px;
    }
    .eleicao-card h3 {
      color: #d4af37;
      margin: 10px 0;
      font-size: 1.3rem;
    }
    .eleicao-card p {
      margin: 5px 0;
      color: #ccc;
      font-size: 0.9rem;
    }
    .status-badge {
      display: inline-block;
      padding: 6px 15px;
      border-radius: 20px;
      font-size: 0.8rem;
      margin: 10px 0;
      font-weight: bold;
    }
    .status-ativa {
      background: rgba(86, 171, 47, 0.2);
      color: #56ab2f;
      border: 1px solid #56ab2f;
    }
    .status-inativa {
      background: rgba(255, 68, 68, 0.2);
      color: #ff4444;
      border: 1px solid #ff4444;
    }

    /* Formul√°rio de cadastro */
    .form-container {
      max-width: 500px;
      margin: 0 auto;
    }
    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }
    label {
      display: block;
      margin-bottom: 8px;
      color: #d4af37;
    }
    input, textarea, select {
      width: 100%; 
      padding: 12px;
      border-radius: 8px; 
      border: 1px solid #d4af37;
      background: #1a1a1a; 
      color: #fff; 
      font-size: 0.95rem;
      box-sizing: border-box;
    }
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    /* ESTILOS ESPEC√çFICOS PARA PERFIL */
    .input-with-gps {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .input-with-gps input {
      flex: 1;
    }
    .gps-button {
      background: #56ab2f;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 15px;
      cursor: pointer;
      transition: background 0.3s ease;
      white-space: nowrap;
    }
    .gps-button:hover {
      background: #478c25;
    }
    .gps-button i {
      margin-right: 5px;
    }
    
    .photo-upload {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 20px;
    }
    .photo-preview {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      border: 2px solid #d4af37;
      background-color: #1a1a1a;
      margin-bottom: 15px;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .photo-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .photo-preview i {
      font-size: 3rem;
      color: #555;
    }
    .photo-upload label {
      background: transparent; 
      border: 1px solid #d4af37;
      color: #d4af37; 
      padding: 10px 20px; 
      border-radius: 30px;
      cursor: pointer; 
      transition: 0.3s ease;
      display: inline-block;
    }
    .photo-upload label:hover {
      background: rgba(212,175,55,0.15);
    }
    .photo-upload input[type="file"] {
      display: none;
    }
    .submit-btn {
      background: rgba(212,175,55,0.2);
      border: 1px solid #d4af37;
      color: #d4af37; 
      padding: 12px 35px; 
      border-radius: 30px;
      cursor: pointer; 
      transition: 0.3s ease;
      font-size: 1rem;
      margin-top: 20px;
      width: 100%;
    }
    .submit-btn:hover {
      background: rgba(212,175,55,0.4);
    }

    /* Estados vazios */
    .empty-state {
      text-align: center;
      color: #888;
      padding: 60px 20px;
    }
    .empty-state h3 {
      color: #d4af37;
      margin-bottom: 10px;
    }

    /* Novo estilo para o campo de tipo */
    .tipo-eleicao {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }
    .tipo-option {
      background: #1a1a1a;
      border: 1px solid #d4af37;
      border-radius: 10px;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      transition: 0.3s;
    }
    .tipo-option:hover {
      background: rgba(212,175,55,0.1);
    }
    .tipo-option.selecionado {
      background: rgba(212,175,55,0.2);
      border-color: #d4af37;
    }
    .tipo-option i {
      font-size: 1.5rem;
      margin-bottom: 8px;
      display: block;
    }
    .tipo-option small {
      display: block;
      margin-top: 5px;
      color: #888;
      font-size: 0.8rem;
    }

    /* Tela de confirma√ß√£o */
    .confirmation-screen {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(10, 15, 10, 0.95);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    .confirmation-card {
      background: #1a1f1a;
      border: 2px solid #d4af37;
      border-radius: 15px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      text-align: center;
    }
    .confirmation-card img {
      width: 200px;
      height: 150px;
      object-fit: cover;
      margin: 0 auto 20px;
      border-radius: 10px;
      border: 3px solid #d4af37;
      display: block;
    }
    .confirmation-card h2 {
      color: #d4af37;
      margin-bottom: 20px;
    }
    .confirmation-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
    }
    .confirm-button {
      background: rgba(212,175,55,0.2);
      border: 1px solid #d4af37;
      color: #d4af37;
      padding: 12px 25px;
      border-radius: 20px;
      cursor: pointer;
      transition: 0.3s;
      font-size: 1rem;
    }
    .confirm-button:hover {
      background: rgba(212,175,55,0.4);
    }
    .cancel-button {
      background: transparent;
      border: 1px solid #888;
      color: #888;
      padding: 12px 25px;
      border-radius: 20px;
      cursor: pointer;
      transition: 0.3s;
      font-size: 1rem;
    }
    .cancel-button:hover {
      background: rgba(136,136,136,0.2);
    }

    /* Loading */
    #processando {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #000c;
      color: #d4af37;
      font-size: 1.5rem;
      font-family: system-ui;
      backdrop-filter: blur(4px);
      justify-content: center;
      align-items: center;
      text-shadow: 0 0 8px #d4af37;
      z-index: 2000;
    }

    /* Info do usu√°rio */
    .user-info {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(212,175,55,0.1);
      border: 1px solid rgba(212,175,55,0.3);
      border-radius: 10px;
      padding: 10px 15px;
      font-size: 0.9rem;
      color: #d4af37;
    }
  </style>
</head>

<body>

<!-- Informa√ß√£o do usu√°rio logado -->
<div class="user-info" id="userInfo">
  <i class="fas fa-user"></i> Carregando...
</div>

<div class="container">
  <header>
    <h1>üåç Painel de Autoridade ‚Äî Terra Dourada</h1>
    <p>Gerencie suas elei√ß√µes de forma segura e transparente</p>
  </header>

  <!-- ABAS -->
  <div class="tabs">
    <button class="tab active" onclick="showTab('eleicoes')">üó≥Ô∏è Minhas Elei√ß√µes</button>
    <button class="tab" onclick="showTab('cadastro')">‚ûï Nova Elei√ß√£o</button>
    <!-- BOT√ÉO EDITAR PERFIL -->
    <button class="tab-perfil" onclick="showTab('perfil')">üë§ Editar Perfil</button>
    <!-- BOT√ÉO P2P SOCIAL -->
    <button class="tab-p2p" onclick="irParaRedeSocial()">üåê P2P Social</button>
  </div>

  <!-- CONTE√öDO PRINCIPAL -->
  <div class="content">
    
    <!-- ABA: MINHAS ELEI√á√ïES -->
    <div id="tab-eleicoes">
      <h2 style="text-align: center; color: #d4af37; margin-bottom: 30px;">Minhas Elei√ß√µes</h2>
      <div id="eleicoes-list" class="eleicoes-grid"></div>
    </div>

    <!-- ABA: CADASTRO DE ELEI√á√ÉO -->
    <div id="tab-cadastro" style="display: none;">
      <h2 style="text-align: center; color: #d4af37; margin-bottom: 30px;">Criar Nova Elei√ß√£o</h2>
      
      <div class="form-container">
        <!-- Foto/Slogan -->
        <div class="photo-upload">
          <div class="photo-preview" id="photoPreview">
            <i class="fas fa-image"></i>
          </div>
          <label for="photoInput">
            <i class="fas fa-camera"></i> Escolher Slogan/Imagem
          </label>
          <input type="file" id="photoInput" accept="image/*">
        </div>
        
        <div class="form-group">
          <label for="electionName">Nome da Elei√ß√£o</label>
          <input type="text" id="electionName" placeholder="Ex: Elei√ß√µes Municipais 2024">
        </div>

        <!-- Campo: Tipo da Elei√ß√£o -->
        <div class="form-group">
          <label>Tipo da Elei√ß√£o</label>
          <div class="tipo-eleicao">
            <div class="tipo-option selecionado" onclick="selecionarTipo('online', this)">
              <i class="fas fa-globe"></i>
              <strong>üåê Online</strong>
              <small>Vota√ß√£o remota por link</small>
            </div>
            <div class="tipo-option" onclick="selecionarTipo('presencial', this)">
              <i class="fas fa-building"></i>
              <strong>üèõÔ∏è Presencial</strong>
              <small>Vota√ß√£o f√≠sica com mes√°rio</small>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label for="position">Cargos em Disputa</label>
          <input type="text" id="position" placeholder="Ex: Vereador, Prefeito, Deputado">
        </div>
        
        <div class="form-group">
          <label for="description">Descri√ß√£o da Elei√ß√£o</label>
          <textarea id="description" placeholder="Descreva os objetivos e regras desta elei√ß√£o"></textarea>
        </div>
        
        <button class="submit-btn" onclick="criarEleicao()">
          üó≥Ô∏è CRIAR ELEI√á√ÉO
        </button>
      </div>
    </div>

    <!-- NOVA ABA: EDITAR PERFIL -->
    <div id="tab-perfil" style="display: none;">
      <h2 style="text-align: center; color: #2d8cf0; margin-bottom: 30px;">üë§ Editar Perfil</h2>
      
      <div class="form-container">
        <!-- Foto de Perfil -->
        <div class="photo-upload">
          <div class="photo-preview" id="perfilPhotoPreview">
            <i class="fas fa-user"></i>
          </div>
          <label for="perfilPhotoInput">
            <i class="fas fa-camera"></i> Alterar Foto
          </label>
          <input type="file" id="perfilPhotoInput" accept="image/*">
        </div>
        
        <div class="form-group">
          <label for="perfilNome"><i class="fas fa-signature"></i> Nome Completo</label>
          <input type="text" id="perfilNome" placeholder="Seu nome completo">
        </div>
        
        <div class="form-group">
          <label for="perfilEmail"><i class="fas fa-envelope"></i> Email</label>
          <input type="email" id="perfilEmail" readonly style="background: #2a2a2a;">
        </div>
        
        <div class="form-group">
          <label for="perfilTelefone"><i class="fas fa-phone"></i> Telefone</label>
          <input type="tel" id="perfilTelefone" placeholder="(00) 00000-0000">
        </div>
        
        <div class="form-group">
          <label for="perfilLocalizacao"><i class="fas fa-map-marker-alt"></i> Localiza√ß√£o</label>
          <div class="input-with-gps">
            <input type="text" id="perfilLocalizacao" placeholder="Cidade, Estado">
            <button type="button" class="gps-button" onclick="obterLocalizacaoGPS()">
              <i class="fas fa-location-arrow"></i> GPS
            </button>
          </div>
        </div>
        
       <div class="form-group">
  <label for="perfilAreaAtuacao"><i class="fas fa-briefcase"></i> √Årea de Atua√ß√£o</label>
  <input type="text" id="perfilAreaAtuacao" placeholder="Ex: Pol√≠tica, Educa√ß√£o, Tecnologia, etc.">
</div>
        
        <button class="submit-btn" onclick="salvarPerfil()">
          üíæ SALVAR PERFIL
        </button>
      </div>
    </div>

  </div>
</div>

<!-- TELA DE CONFIRMA√á√ÉO -->
<div id="confirmationScreen" class="confirmation-screen">
  <div id="confirmationCard" class="confirmation-card">
    <img id="confirmationImage" src="" alt="Slogan da Elei√ß√£o">
    <h2>Confirma√ß√£o de Elei√ß√£o</h2>
    <p>Voc√™ est√° prestes a criar a elei√ß√£o:</p>
    <h3 id="confirmationElectionName" style="color: #d4af37; margin: 10px 0 20px;"></h3>
    <p id="confirmationTipo" style="margin-bottom: 10px;"></p>
    <p id="confirmationPosition" style="margin-bottom: 10px;"></p>
    <p id="confirmationDescription" style="margin-bottom: 20px; color: #bbb;"></p>
    <p>Tem certeza de que deseja confirmar a cria√ß√£o?</p>
    <div class="confirmation-buttons">
      <button id="confirmCadastroButton" class="confirm-button">Sim, criar elei√ß√£o</button>
      <button onclick="fecharTelaConfirmacao()" class="cancel-button">Cancelar</button>
    </div>
  </div>
</div>

<!-- LOADING -->
<div id="processando"><div>Processando elei√ß√£o‚Ä¶</div></div>

<script>
// Banco de dados
const dbEleicoes = new PouchDB('terra_dourada_eleicoes');
const dbConfig = new PouchDB('terra_dourada_config');
const dbPerfis = new PouchDB('terra_dourada_perfis'); // NOVO: Banco para perfis

// Vari√°veis
let photoBase64 = null;
let perfilPhotoBase64 = null; // NOVO: Foto do perfil
let electionData = null;
let tipoEleicao = 'online';
let usuarioLogado = null;

// FUN√á√ÉO: Ir para Rede Social P2P
function irParaRedeSocial() {
  if (!usuarioLogado) {
    alert('Erro: Usu√°rio n√£o identificado. Fa√ßa login novamente.');
    window.location.href = 'login.html';
    return;
  }
  
  const userId = encodeURIComponent(usuarioLogado.email);
  window.location.href = `rede_social.html?user_id=${userId}`;
}

// FUN√á√ÉO: Identificar usu√°rio logado
async function identificarUsuarioLogado() {
  try {
    console.log('üîç Identificando usu√°rio logado...');
    
    const usuarioData = JSON.parse(localStorage.getItem("usuario_data") || '{}');
    if (usuarioData.email) {
      console.log('‚úÖ Usu√°rio do localStorage:', usuarioData.email);
      return usuarioData;
    }
    
    const conta = await dbConfig.get('dono_da_sala');
    console.log('‚úÖ Usu√°rio do PouchDB:', conta.email);
    return conta;
    
  } catch (error) {
    console.error('‚ùå Erro ao identificar usu√°rio:', error);
    alert('Sess√£o expirada. Fa√ßa login novamente.');
    window.location.href = 'login.html';
    return null;
  }
}

// FUN√á√ÉO: Atualizar info do usu√°rio na tela
function atualizarInfoUsuario(usuario) {
  const userInfo = document.getElementById('userInfo');
  if (usuario && userInfo) {
    userInfo.innerHTML = `<i class="fas fa-user"></i> ${usuario.name || usuario.email} (${usuario.provider})`;
  }
}

// --- CONTROLE DE ABAS ---
function showTab(tab) {
  // Atualizar abas
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-p2p').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-perfil').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('[id^="tab-"]').forEach(c => c.style.display = 'none');

  // Ativar aba atual
  event.currentTarget.classList.add('active');
  document.getElementById(`tab-${tab}`).style.display = 'block';

  // Recarregar elei√ß√µes se for a aba de listagem
  if (tab === 'eleicoes') {
    carregarEleicoes();
  }
  
  // Carregar dados do perfil se for a aba de perfil
  if (tab === 'perfil') {
    carregarDadosPerfil();
  }
}

// FUN√á√ÉO: Selecionar Tipo
function selecionarTipo(tipo, element) {
  tipoEleicao = tipo;
  
  document.querySelectorAll('.tipo-option').forEach(opt => {
    opt.classList.remove('selecionado');
  });
  element.classList.add('selecionado');
}

// FUN√á√ÉO: Carregar elei√ß√µes do usu√°rio
async function carregarEleicoes() {
  try {
    if (!usuarioLogado) {
      console.error('‚ùå Usu√°rio n√£o identificado');
      return;
    }

    const res = await dbEleicoes.allDocs({ include_docs: true });
    const cont = document.getElementById('eleicoes-list');

    const eleicoesDoUsuario = res.rows.filter(row => 
      row.doc.ownerId === usuarioLogado.email || row.doc.ownerEmail === usuarioLogado.email
    );

    console.log(`üìä Elei√ß√µes encontradas: ${res.rows.length}, Do usu√°rio: ${eleicoesDoUsuario.length}`);

    if (eleicoesDoUsuario.length === 0) {
      cont.innerHTML = `
        <div class="empty-state">
          <h3>Nenhuma elei√ß√£o cadastrada</h3>
          <p>Clique em "Nova Elei√ß√£o" para criar sua primeira elei√ß√£o</p>
          <p style="margin-top: 10px; font-size: 0.8rem; color: #666;">
            Usu√°rio: ${usuarioLogado.email}
          </p>
        </div>
      `;
      return;
    }

    cont.innerHTML = eleicoesDoUsuario.map(r => {
      const eleicao = r.doc;
      const status = eleicao.status === 'ativa' ? 'status-ativa' : 'status-inativa';
      const statusText = eleicao.status === 'ativa' ? 'Ativa' : 'Inativa';
      const logo = eleicao.photo || 'https://via.placeholder.com/80/1a1a1a/d4af37?text=üó≥Ô∏è';
      const tipoIcon = eleicao.tipo === 'presencial' ? 'üèõÔ∏è' : 'üåê';
      const tipoText = eleicao.tipo === 'presencial' ? 'Presencial' : 'Online';
      
      return `
        <div class="eleicao-card" onclick="abrirPainelEleicao('${eleicao._id}')">
          <img src="${logo}" alt="${eleicao.name}" class="eleicao-logo">
          <h3>${eleicao.name}</h3>
          <p><strong>Tipo:</strong> ${tipoIcon} ${tipoText}</p>
          <p><strong>Cargo:</strong> ${eleicao.position}</p>
          <p><strong>Criada em:</strong> ${new Date(eleicao.createdAt).toLocaleDateString()}</p>
          <span class="status-badge ${status}">${statusText}</span>
          <p style="margin-top: 15px; font-size: 0.8rem; color: #888;">
            Clique para gerenciar esta elei√ß√£o
          </p>
        </div>
      `;
    }).join('');
  } catch (error) {
    console.error('Erro ao carregar elei√ß√µes:', error);
  }
}

// FUN√á√ÉO: Abrir painel da elei√ß√£o
function abrirPainelEleicao(eleicaoId) {
  window.location.href = `painel_eleicao.html?id=${eleicaoId}`;
}

// --- UPLOAD DE FOTO ELEI√á√ÉO ---
document.getElementById('photoInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(event) {
      photoBase64 = event.target.result;
      document.getElementById('photoPreview').innerHTML = `<img src="${photoBase64}" alt="Slogan da elei√ß√£o">`;
    };
    reader.readAsDataURL(file);
  }
});

// --- NOVO: UPLOAD DE FOTO PERFIL ---
document.getElementById('perfilPhotoInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(event) {
      perfilPhotoBase64 = event.target.result;
      document.getElementById('perfilPhotoPreview').innerHTML = `<img src="${perfilPhotoBase64}" alt="Foto de perfil">`;
    };
    reader.readAsDataURL(file);
  }
});

// --- NOVO: Obter localiza√ß√£o por GPS ---
function obterLocalizacaoGPS() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      function(position) {
        const latitude = position.coords.latitude;
        const longitude = position.coords.longitude;
        
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`)
          .then(response => response.json())
          .then(data => {
            if (data.address) {
              const cidade = data.address.city || data.address.town || data.address.village;
              const estado = data.address.state;
              if (cidade && estado) {
                document.getElementById('perfilLocalizacao').value = `${cidade}, ${estado}`;
              } else {
                document.getElementById('perfilLocalizacao').value = `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
              }
            }
          })
          .catch(error => {
            console.error('Erro ao obter localiza√ß√£o:', error);
            document.getElementById('perfilLocalizacao').value = `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
          });
      },
      function(error) {
        alert('Erro ao obter localiza√ß√£o: ' + error.message);
      }
    );
  } else {
    alert('Geolocaliza√ß√£o n√£o √© suportada pelo seu navegador.');
  }
}

// --- NOVO: Formata√ß√£o autom√°tica do telefone ---
document.getElementById('perfilTelefone').addEventListener('input', function(e) {
  let value = e.target.value.replace(/\D/g, '');
  
  if (value.length <= 10) {
    value = value.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
  } else {
    value = value.replace(/(\d{2})(\d{5})(\d{0,4})/, '($1) $2-$3');
  }
  
  e.target.value = value;
});

// --- NOVO: Carregar dados do perfil ---
async function carregarDadosPerfil() {
  if (!usuarioLogado) return;
  
  try {
    const perfilId = `perfil_${usuarioLogado.email}`;
    
    try {
      const perfil = await dbPerfis.get(perfilId);
      
      // Preencher campos com dados salvos
      document.getElementById('perfilNome').value = perfil.nome || '';
      document.getElementById('perfilEmail').value = perfil.email || usuarioLogado.email;
      document.getElementById('perfilTelefone').value = perfil.telefone || '';
      document.getElementById('perfilLocalizacao').value = perfil.localizacao || '';
      document.getElementById('perfilAreaAtuacao').value = perfil.areaAtuacao || '';
      
      if (perfil.foto) {
        perfilPhotoBase64 = perfil.foto;
        document.getElementById('perfilPhotoPreview').innerHTML = `<img src="${perfil.foto}" alt="Foto de perfil">`;
      }
      
    } catch (error) {
      // Perfil n√£o existe ainda, usar dados b√°sicos
      if (error.name === 'not_found') {
        document.getElementById('perfilEmail').value = usuarioLogado.email;
        document.getElementById('perfilNome').value = usuarioLogado.name || '';
      }
    }
    
  } catch (error) {
    console.error('Erro ao carregar perfil:', error);
  }
}

// --- NOVO: Salvar perfil ---
async function salvarPerfil() {
  if (!usuarioLogado) {
    alert('Erro: Usu√°rio n√£o identificado.');
    return;
  }

  const nome = document.getElementById('perfilNome').value.trim();
  const telefone = document.getElementById('perfilTelefone').value.trim();
  const localizacao = document.getElementById('perfilLocalizacao').value.trim();
 const areaAtuacao = document.getElementById('perfilAreaAtuacao').value.trim();

  // Valida√ß√£o
  if (!nome) {
    alert('Por favor, preencha seu nome completo.');
    return;
  }

  if (!telefone) {
    alert('Por favor, preencha seu telefone.');
    return;
  }



  try {
    const perfilId = `perfil_${usuarioLogado.email}`;
    
    // Preparar dados do perfil
    const perfil = {
      _id: perfilId,
      nome: nome,
      email: usuarioLogado.email,
      telefone: telefone,
      localizacao: localizacao,
      areaAtuacao: areaAtuacao,
      foto: perfilPhotoBase64,
      atualizadoEm: new Date().toISOString(),
      provider: usuarioLogado.provider
    };

    // Salvar no banco de dados
    await dbPerfis.put(perfil);
    
    console.log('üíæ Perfil salvo:', perfil);
    alert('‚úÖ Perfil salvo com sucesso!');
    
    // Atualizar info do usu√°rio
    atualizarInfoUsuario({...usuarioLogado, name: nome});
    
  } catch (error) {
    console.error('Erro ao salvar perfil:', error);
    alert('Erro ao salvar perfil. Tente novamente.');
  }
}

// --- CRIAR ELEI√á√ÉO ---
function criarEleicao() {
  const name = document.getElementById('electionName').value.trim();
  const position = document.getElementById('position').value.trim();
  const description = document.getElementById('description').value.trim();
  
  if (!name || !position) {
    alert('Por favor, preencha pelo menos o nome e os cargos da elei√ß√£o.');
    return;
  }
  
  if (!photoBase64) {
    alert('Por favor, selecione uma imagem/slogan para a elei√ß√£o.');
    return;
  }
  
  electionData = {
    name: name,
    tipo: tipoEleicao,
    position: position,
    description: description,
    photo: photoBase64
  };
  
  abrirTelaConfirmacao(electionData);
}

// --- TELA DE CONFIRMA√á√ÉO ---
function abrirTelaConfirmacao(dadosEleicao) {
  document.getElementById('confirmationImage').src = dadosEleicao.photo;
  document.getElementById('confirmationElectionName').textContent = dadosEleicao.name;
  document.getElementById('confirmationTipo').textContent = `Tipo: ${dadosEleicao.tipo === 'presencial' ? 'üèõÔ∏è Presencial' : 'üåê Online'}`;
  document.getElementById('confirmationPosition').textContent = `Cargos: ${dadosEleicao.position}`;
  document.getElementById('confirmationDescription').textContent = dadosEleicao.description || 'Sem descri√ß√£o';
  
  document.getElementById('confirmCadastroButton').onclick = function() {
    confirmarEleicao();
  };
  
  document.getElementById('confirmationScreen').style.display = 'flex';
}

function fecharTelaConfirmacao() {
  document.getElementById('confirmationScreen').style.display = 'none';
  electionData = null;
}

// FUN√á√ÉO: Confirmar elei√ß√£o
async function confirmarEleicao() {
  if (!usuarioLogado) {
    alert('Erro: Usu√°rio n√£o identificado. Fa√ßa login novamente.');
    window.location.href = 'login.html';
    return;
  }

  document.getElementById("processando").style.display = "flex";

  try {
    const printBase64 = await capturarPrint();
    const hashPrint = await sha256Base64(printBase64);
    
    const electionId = `election_${Date.now()}`;
    
    const election = {
      _id: electionId,
      name: electionData.name,
      tipo: electionData.tipo,
      position: electionData.position,
      description: electionData.description,
      photo: electionData.photo,
      screenshot_hash: hashPrint,
      status: 'ativa',
      createdAt: new Date().toISOString(),
      candidateCount: 0,
      ownerId: usuarioLogado.email,
      ownerEmail: usuarioLogado.email,
      ownerName: usuarioLogado.name,
      ownerProvider: usuarioLogado.provider
    };
    
    await dbEleicoes.put(election);
    
    console.log("üíæ Elei√ß√£o criada para usu√°rio:", usuarioLogado.email, election);

    document.getElementById("processando").style.display = "none";
    
    // Limpar formul√°rio
    document.getElementById('electionName').value = '';
    document.getElementById('position').value = '';
    document.getElementById('description').value = '';
    document.getElementById('photoPreview').innerHTML = '<i class="fas fa-image"></i>';
    photoBase64 = null;
    
    // Resetar tipo para padr√£o
    document.querySelectorAll('.tipo-option').forEach(opt => {
      opt.classList.remove('selecionado');
    });
    document.querySelector('.tipo-option').classList.add('selecionado');
    tipoEleicao = 'online';
    
    fecharTelaConfirmacao();
    
    // Voltar para a aba de elei√ß√µes e recarregar
    showTab('eleicoes');
    
    alert('üéâ Elei√ß√£o criada com sucesso!');
    
  } catch (error) {
    console.error('Erro ao criar elei√ß√£o:', error);
    document.getElementById("processando").style.display = "none";
    alert('Erro ao criar elei√ß√£o. Tente novamente.');
  }
}

// --- FUN√á√ïES AUXILIARES ---
async function sha256Base64(dataURL) {
  const base64 = dataURL.split(",")[1];
  const bytes = Uint8Array.from(atob(base64), c => c.charCodeAt(0));
  const hashBuffer = await crypto.subtle.digest("SHA-256", bytes);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
}

async function capturarPrint() {
  const elemento = document.getElementById("confirmationCard");
  const canvas = await html2canvas(elemento);
  return canvas.toDataURL("image/png");
}

// INICIALIZA√á√ÉO
document.addEventListener("DOMContentLoaded", async () => {
  console.log('üöÄ Iniciando Painel de Autoridade...');
  
  usuarioLogado = await identificarUsuarioLogado();
  
  if (usuarioLogado) {
    console.log('‚úÖ Usu√°rio identificado:', usuarioLogado.email);
    atualizarInfoUsuario(usuarioLogado);
    carregarEleicoes();
  } else {
    console.error('‚ùå N√£o foi poss√≠vel identificar o usu√°rio');
  }
});
</script>
</body>
</html>
