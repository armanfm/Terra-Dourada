<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel de Autoridade ‚Äî Terra Dourada</title>
  <script src="https://cdn.jsdelivr.net/npm/pouchdb@7.3.1/dist/pouchdb.min.js"></script>

  <style>
    body {
      background: #050703;
      color: #f5f5f5;
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }
    header {
      text-align: center;
      margin-bottom: 30px;
      border-bottom: 1px solid rgba(212,175,55,0.3);
      padding-bottom: 20px;
    }
    h1 {
      color: #d4af37;
      margin-bottom: 10px;
    }
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .tab {
      background: transparent;
      border: 1px solid #d4af37;
      color: #d4af37;
      padding: 10px 20px;
      border-radius: 20px;
      cursor: pointer;
      transition: .3s;
    }
    .tab.active {
      background: rgba(212,175,55,0.2);
    }
    .tab:hover {
      background: rgba(212,175,55,0.1);
    }
    .content {
      background: #111;
      border-radius: 15px;
      padding: 30px;
      border: 1px solid rgba(212,175,55,0.3);
      min-height: 400px;
    }
    .candidates-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .candidate-card {
      background: #1a1a1a;
      border: 1px solid rgba(212,175,55,0.2);
      border-radius: 10px;
      padding: 15px;
      text-align: center;
    }
    .candidate-card img {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #d4af37;
      margin-bottom: 10px;
    }
    .delete-btn {
      background: #ff4444;
      border: none;
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
    }
    .auth-section {
      text-align: center;
      margin-top: 30px;
    }
    .auth-link {
      background: rgba(212,175,55,0.1);
      border: 1px dashed #d4af37;
      border-radius: 10px;
      padding: 15px;
      margin: 10px 0;
      word-break: break-all;
    }
    .generate-btn {
      background: transparent;
      border: 1px solid #d4af37;
      color: #d4af37;
      padding: 10px 20px;
      border-radius: 20px;
      cursor: pointer;
      margin: 10px;
    }
    .generate-btn:hover {
      background: rgba(212,175,55,0.2);
    }
    .cadastro-btn {
      background: rgba(212,175,55,0.2);
      border: 1px solid #d4af37;
      color: #d4af37;
      padding: 12px 25px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 1.1rem;
      margin-top: 20px;
    }
    .cadastro-btn:hover {
      background: rgba(212,175,55,0.4);
    }
    .empty-state {
      text-align: center;
      color: #888;
      padding: 40px;
    }
    .authorized-votes {
      margin-top: 30px;
      background: rgba(212,175,55,0.05);
      border-radius: 10px;
      padding: 15px;
    }
    .vote-status {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .auditor-btn {
      background: rgba(86, 171, 47, 0.2);
      border: 1px solid #56ab2f;
      color: #56ab2f;
      padding: 12px 25px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 1.1rem;
      margin-top: 20px;
      transition: .3s;
    }
    .auditor-btn:hover {
      background: rgba(86, 171, 47, 0.4);
    }
    .header-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 15px;
      flex-wrap: wrap;
    }
  </style>
</head>

<body>

<div class="container">
  <header>
    <h1>üåç Painel de Autoridade ‚Äî Terra Dourada</h1>
    <p>Gerencie candidatos, votos e cr√©ditos</p>
    
    <!-- BOT√ïES ADICIONAIS NO HEADER -->
    <div class="header-buttons">
      <button class="cadastro-btn" onclick="window.location.href='cad_candidato.html'">
        Cadastrar Novo Candidato
      </button>
      <button class="auditor-btn" onclick="window.location.href='auditor.html'">
        üëÅÔ∏è Painel do Auditor
      </button>
    </div>
  </header>

  <!-- BOT√ïES DAS ABAS -->
  <div class="tabs">
    <button class="tab active" onclick="showTab('candidatos')">üìã Candidatos</button>
    <button class="tab" onclick="showTab('autorizacao')">üîê Autorizar Votos</button>
    <button class="tab" onclick="showTab('monitor')">üëÅÔ∏è Monitorar Votos</button>
    <button class="tab" onclick="showTab('pagamento')">üí∞ Comprar Cr√©ditos</button>
  </div>

  <!-- CONTE√öDO -->
  <div class="content">

    <!-- ABA CANDIDATOS -->
    <div id="tab-candidatos">
      <h2>Lista de Candidatos Cadastrados</h2>
      <div id="candidates-list" class="candidates-grid"></div>
    </div>

    <!-- ABA AUTORIZA√á√ÉO -->
    <div id="tab-autorizacao" style="display: none;">
      <h2>Gerar Autoriza√ß√£o de Voto</h2>
      <div class="auth-section">
        <button class="generate-btn" onclick="gerarAutorizacao()">üé´ Gerar Nova Autoriza√ß√£o</button>
        <div id="auth-links"></div>
      </div>
    </div>

    <!-- ABA MONITOR -->
    <div id="tab-monitor" style="display: none;">
      <h2>Votos Autorizados e Realizados</h2>
      <div id="authorized-votes" class="authorized-votes"></div>
    </div>

    <!-- ABA PAGAMENTO -->
    <div id="tab-pagamento" style="display: none;">

      <h2>üí∞ Comprar Cr√©ditos de Vota√ß√£o</h2>

      <label>Quantidade de votos:</label><br>
      <input id="quantidade" type="number" min="10" placeholder="Ex: 500"
        style="padding:10px; width:220px; border-radius:8px; margin-top:10px;"><br><br>

      <label>Moeda de pagamento:</label><br>
      <select id="moeda"
        style="padding:10px; width:240px; border-radius:8px; margin-top:10px;">
        <option value="SOL">Solana (SOL)</option>
        <option value="USDC">USDC</option>
        <option value="USD">D√≥lar (USD)</option>
        <option value="EUR">Euro (EUR)</option>
        <option value="CNY">Yuan (CNY)</option>
        <option value="BRL">Real (BRL)</option>
      </select>

      <div id="precoEstimado" style="margin-top:20px; font-size:1.2rem; color:#d4af37;"></div>

      <button class="cadastro-btn" onclick="simularPagamento()" style="margin-top:20px;">
        üí≥ Simular Pagamento
      </button>

      <div id="resultadoPagamento" style="margin-top:20px; color:#0f0;"></div>
    </div>

  </div>
</div>

<script>

// --- BANCOS ---
const dbAuth = new PouchDB('terra_dourada_autorizacoes');
const dbCandidates = new PouchDB('terra_dourada_candidates');
const dbVotes = new PouchDB('terra_dourada_votos_local');

// --- CONTROLE DE ABAS ---
function showTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('[id^="tab-"]').forEach(c => c.style.display = 'none');

  document.querySelector(`button[onclick="showTab('${tab}')"]`).classList.add('active');
  document.getElementById(`tab-${tab}`).style.display = 'block';

  if (tab === "candidatos") carregarCandidatos();
  if (tab === "monitor") carregarVotosAutorizados();
}

// --- CARREGAR CANDIDATOS ---
async function carregarCandidatos() {
  const res = await dbCandidates.allDocs({ include_docs: true });
  const cont = document.getElementById('candidates-list');

  cont.innerHTML = res.rows.map(r => `
    <div class="candidate-card">
      <img src="${r.doc.photo}">
      <h3>${r.doc.name}</h3>
      <p style="color:#d4af37">${r.doc.position}</p>
      <button class="delete-btn" onclick="excluirCandidato('${r.doc._id}')">Excluir</button>
    </div>
  `).join('');
}

// --- EXCLUS√ÉO ---
async function excluirCandidato(id) {
  const doc = await dbCandidates.get(id);
  await dbCandidates.remove(doc);
  carregarCandidatos();
}

// --- AUTORIZA√á√ÉO ---
async function gerarAutorizacao() {
  const token = crypto.randomUUID();
  const expiresAt = new Date(Date.now() + 3600000);

  await dbAuth.put({
    _id: token,
    token,
    created_at: new Date().toISOString(),
    expires_at: expiresAt.toISOString(),
    used: false
  });

  const voteURL = `${window.location.origin}/voto.html?auth=${token}`;

  document.getElementById("auth-links").innerHTML += `
    <div class="auth-link">
      üîó <a href="${voteURL}" target="_blank">${voteURL}</a><br>
      <small>Expira: ${expiresAt.toLocaleTimeString()}</small>
    </div>
  `;
}

// --- MONITOR ---
async function carregarVotosAutorizados() {
  const auths = await dbAuth.allDocs({ include_docs: true });
  const votes = await dbVotes.allDocs({ include_docs: true });

  document.getElementById("authorized-votes").innerHTML =
    auths.rows.map(r => {
      const v = votes.rows.find(x => x.doc.auth_token === r.doc.token);
      return `
        <div class="vote-status">
          <div>
            Token: ${r.doc.token.slice(0,8)}...
          </div>
          <div>${v ? "‚úÖ Votou" : "‚è≥ Pendente"}</div>
        </div>
      `;
    }).join('');
}

// ======================
//      PAGAMENTO
// ======================

// TABELA OFICIAL (BRL)
function calcularPrecoBRL(q) {
  if (q < 100) return q * 0.05;
  if (q < 1000) return q * 0.04;
  if (q < 10000) return q * 0.03;
  if (q < 100000) return q * 0.02;
  if (q < 1000000) return q * 0.01;
  if (q < 10000000) return q * 0.009;
  if (q < 100000000) return q * 0.008;
  return q * 0.007;
}

function simularPagamento() {
  const q = parseInt(document.getElementById("quantidade").value);
  const moeda = document.getElementById("moeda").value;

  if (!q || q < 10) {
    alert("Escolha pelo menos 10 votos!");
    return;
  }

  const precoBRL = calcularPrecoBRL(q);

  document.getElementById("precoEstimado").textContent =
    `Pre√ßo-base BRL: R$ ${precoBRL.toFixed(2)}`;

  document.getElementById("resultadoPagamento").textContent =
    `Pagamento SIMULADO em ${moeda} aprovado! Cr√©ditos liberados: ${q}`;
}

document.addEventListener("DOMContentLoaded", () => {
  carregarCandidatos();
});

</script>
</body>
</html>