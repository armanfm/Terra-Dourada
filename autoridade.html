<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel de Autoridade ‚Äî Terra Dourada</title>
  <script src="https://cdn.jsdelivr.net/npm/pouchdb@7.3.1/dist/pouchdb.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    body {
      background: #050703;
      color: #f5f5f5;
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }
    header {
      text-align: center;
      margin-bottom: 30px;
      border-bottom: 1px solid rgba(212,175,55,0.3);
      padding-bottom: 20px;
    }
    h1 {
      color: #d4af37;
      margin-bottom: 10px;
    }
    
    /* Abas */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .tab {
      background: transparent;
      border: 1px solid #d4af37;
      color: #d4af37;
      padding: 12px 25px;
      border-radius: 20px;
      cursor: pointer;
      transition: .3s;
      font-size: 1rem;
    }
    .tab.active {
      background: rgba(212,175,55,0.2);
    }
    .tab:hover {
      background: rgba(212,175,55,0.1);
    }
    
    /* Conte√∫do principal */
    .content {
      background: #111;
      border-radius: 15px;
      padding: 40px;
      border: 1px solid rgba(212,175,55,0.3);
      min-height: 500px;
    }

    /* Grid de elei√ß√µes */
    .eleicoes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 25px;
    }
    .eleicao-card {
      background: #1a1a1a;
      border: 1px solid rgba(212,175,55,0.3);
      border-radius: 15px;
      padding: 25px;
      text-align: center;
      transition: transform 0.3s, border-color 0.3s;
      cursor: pointer;
    }
    .eleicao-card:hover {
      transform: translateY(-5px);
      border-color: #d4af37;
    }
    .eleicao-logo {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #d4af37;
      margin: 0 auto 15px;
    }
    .eleicao-card h3 {
      color: #d4af37;
      margin: 10px 0;
      font-size: 1.3rem;
    }
    .eleicao-card p {
      margin: 5px 0;
      color: #ccc;
      font-size: 0.9rem;
    }
    .status-badge {
      display: inline-block;
      padding: 6px 15px;
      border-radius: 20px;
      font-size: 0.8rem;
      margin: 10px 0;
      font-weight: bold;
    }
    .status-ativa {
      background: rgba(86, 171, 47, 0.2);
      color: #56ab2f;
      border: 1px solid #56ab2f;
    }
    .status-inativa {
      background: rgba(255, 68, 68, 0.2);
      color: #ff4444;
      border: 1px solid #ff4444;
    }

    /* Formul√°rio de cadastro */
    .form-container {
      max-width: 500px;
      margin: 0 auto;
    }
    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }
    label {
      display: block;
      margin-bottom: 8px;
      color: #d4af37;
    }
    input, textarea {
      width: 100%; 
      padding: 12px;
      border-radius: 8px; 
      border: 1px solid #d4af37;
      background: #1a1a1a; 
      color: #fff; 
      font-size: 0.95rem;
      box-sizing: border-box;
    }
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    .photo-upload {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 20px;
    }
    .photo-preview {
      width: 200px;
      height: 150px;
      border-radius: 10px;
      border: 2px solid #d4af37;
      background-color: #1a1a1a;
      margin-bottom: 15px;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .photo-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .photo-preview i {
      font-size: 3rem;
      color: #555;
    }
    .photo-upload label {
      background: transparent; 
      border: 1px solid #d4af37;
      color: #d4af37; 
      padding: 10px 20px; 
      border-radius: 30px;
      cursor: pointer; 
      transition: 0.3s ease;
      display: inline-block;
    }
    .photo-upload label:hover {
      background: rgba(212,175,55,0.15);
    }
    .photo-upload input[type="file"] {
      display: none;
    }
    .submit-btn {
      background: rgba(212,175,55,0.2);
      border: 1px solid #d4af37;
      color: #d4af37; 
      padding: 12px 35px; 
      border-radius: 30px;
      cursor: pointer; 
      transition: 0.3s ease;
      font-size: 1rem;
      margin-top: 20px;
      width: 100%;
    }
    .submit-btn:hover {
      background: rgba(212,175,55,0.4);
    }

    /* Estados vazios */
    .empty-state {
      text-align: center;
      color: #888;
      padding: 60px 20px;
    }
    .empty-state h3 {
      color: #d4af37;
      margin-bottom: 10px;
    }

    /* Novo estilo para o campo de tipo */
    .tipo-eleicao {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }
    .tipo-option {
      background: #1a1a1a;
      border: 1px solid #d4af37;
      border-radius: 10px;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      transition: 0.3s;
    }
    .tipo-option:hover {
      background: rgba(212,175,55,0.1);
    }
    .tipo-option.selecionado {
      background: rgba(212,175,55,0.2);
      border-color: #d4af37;
    }
    .tipo-option i {
      font-size: 1.5rem;
      margin-bottom: 8px;
      display: block;
    }
    .tipo-option small {
      display: block;
      margin-top: 5px;
      color: #888;
      font-size: 0.8rem;
    }

    /* Tela de confirma√ß√£o */
    .confirmation-screen {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(10, 15, 10, 0.95);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    .confirmation-card {
      background: #1a1f1a;
      border: 2px solid #d4af37;
      border-radius: 15px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      text-align: center;
    }
    .confirmation-card img {
      width: 200px;
      height: 150px;
      object-fit: cover;
      margin: 0 auto 20px;
      border-radius: 10px;
      border: 3px solid #d4af37;
      display: block;
    }
    .confirmation-card h2 {
      color: #d4af37;
      margin-bottom: 20px;
    }
    .confirmation-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
    }
    .confirm-button {
      background: rgba(212,175,55,0.2);
      border: 1px solid #d4af37;
      color: #d4af37;
      padding: 12px 25px;
      border-radius: 20px;
      cursor: pointer;
      transition: 0.3s;
      font-size: 1rem;
    }
    .confirm-button:hover {
      background: rgba(212,175,55,0.4);
    }
    .cancel-button {
      background: transparent;
      border: 1px solid #888;
      color: #888;
      padding: 12px 25px;
      border-radius: 20px;
      cursor: pointer;
      transition: 0.3s;
      font-size: 1rem;
    }
    .cancel-button:hover {
      background: rgba(136,136,136,0.2);
    }

    /* Loading */
    #processando {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #000c;
      color: #d4af37;
      font-size: 1.5rem;
      font-family: system-ui;
      backdrop-filter: blur(4px);
      justify-content: center;
      align-items: center;
      text-shadow: 0 0 8px #d4af37;
      z-index: 2000;
    }
  </style>
</head>

<body>

<div class="container">
  <header>
    <h1>üåç Painel de Autoridade ‚Äî Terra Dourada</h1>
    <p>Gerencie suas elei√ß√µes de forma segura e transparente</p>
  </header>

  <!-- ABAS -->
  <div class="tabs">
    <button class="tab active" onclick="showTab('eleicoes')">üó≥Ô∏è Minhas Elei√ß√µes</button>
    <button class="tab" onclick="showTab('cadastro')">‚ûï Nova Elei√ß√£o</button>
  </div>

  <!-- CONTE√öDO PRINCIPAL -->
  <div class="content">
    
    <!-- ABA: MINHAS ELEI√á√ïES -->
    <div id="tab-eleicoes">
      <h2 style="text-align: center; color: #d4af37; margin-bottom: 30px;">Minhas Elei√ß√µes</h2>
      <div id="eleicoes-list" class="eleicoes-grid"></div>
    </div>

    <!-- ABA: CADASTRO DE ELEI√á√ÉO -->
    <div id="tab-cadastro" style="display: none;">
      <h2 style="text-align: center; color: #d4af37; margin-bottom: 30px;">Criar Nova Elei√ß√£o</h2>
      
      <div class="form-container">
        <!-- Foto/Slogan -->
        <div class="photo-upload">
          <div class="photo-preview" id="photoPreview">
            <i class="fas fa-image"></i>
          </div>
          <label for="photoInput">
            <i class="fas fa-camera"></i> Escolher Slogan/Imagem
          </label>
          <input type="file" id="photoInput" accept="image/*">
        </div>
        
        <div class="form-group">
          <label for="electionName">Nome da Elei√ß√£o</label>
          <input type="text" id="electionName" placeholder="Ex: Elei√ß√µes Municipais 2024">
        </div>

        <!-- NOVO CAMPO: Tipo da Elei√ß√£o -->
        <div class="form-group">
          <label>Tipo da Elei√ß√£o</label>
          <div class="tipo-eleicao">
            <div class="tipo-option selecionado" onclick="selecionarTipo('online', this)">
              <i class="fas fa-globe"></i>
              <strong>üåê Online</strong>
              <small>Vota√ß√£o remota por link</small>
            </div>
            <div class="tipo-option" onclick="selecionarTipo('presencial', this)">
              <i class="fas fa-building"></i>
              <strong>üèõÔ∏è Presencial</strong>
              <small>Vota√ß√£o f√≠sica com mes√°rio</small>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label for="position">Cargos em Disputa</label>
          <input type="text" id="position" placeholder="Ex: Vereador, Prefeito, Deputado">
        </div>
        
        <div class="form-group">
          <label for="description">Descri√ß√£o da Elei√ß√£o</label>
          <textarea id="description" placeholder="Descreva os objetivos e regras desta elei√ß√£o"></textarea>
        </div>
        
        <button class="submit-btn" onclick="criarEleicao()">
          üó≥Ô∏è CRIAR ELEI√á√ÉO
        </button>
      </div>
    </div>

  </div>
</div>

<!-- TELA DE CONFIRMA√á√ÉO -->
<div id="confirmationScreen" class="confirmation-screen">
  <div id="confirmationCard" class="confirmation-card">
    <img id="confirmationImage" src="" alt="Slogan da Elei√ß√£o">
    <h2>Confirma√ß√£o de Elei√ß√£o</h2>
    <p>Voc√™ est√° prestes a criar a elei√ß√£o:</p>
    <h3 id="confirmationElectionName" style="color: #d4af37; margin: 10px 0 20px;"></h3>
    <p id="confirmationTipo" style="margin-bottom: 10px;"></p>
    <p id="confirmationPosition" style="margin-bottom: 10px;"></p>
    <p id="confirmationDescription" style="margin-bottom: 20px; color: #bbb;"></p>
    <p>Tem certeza de que deseja confirmar a cria√ß√£o?</p>
    <div class="confirmation-buttons">
      <button id="confirmCadastroButton" class="confirm-button">Sim, criar elei√ß√£o</button>
      <button onclick="fecharTelaConfirmacao()" class="cancel-button">Cancelar</button>
    </div>
  </div>
</div>

<!-- LOADING -->
<div id="processando"><div>Processando elei√ß√£o‚Ä¶</div></div>

<script>
// Banco de dados
const dbEleicoes = new PouchDB('terra_dourada_eleicoes');

// Vari√°veis
let photoBase64 = null;
let electionData = null;
let tipoEleicao = 'online'; // Padr√£o: online

// --- CONTROLE DE ABAS ---
function showTab(tab) {
  // Atualizar abas
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('[id^="tab-"]').forEach(c => c.style.display = 'none');

  // Ativar aba atual
  event.currentTarget.classList.add('active');
  document.getElementById(`tab-${tab}`).style.display = 'block';

  // Recarregar elei√ß√µes se for a aba de listagem
  if (tab === 'eleicoes') {
    carregarEleicoes();
  }
}

// --- NOVA FUN√á√ÉO: Selecionar Tipo ---
function selecionarTipo(tipo, element) {
  tipoEleicao = tipo;
  
  // Atualizar interface
  document.querySelectorAll('.tipo-option').forEach(opt => {
    opt.classList.remove('selecionado');
  });
  element.classList.add('selecionado');
}

// --- CARREGAR ELEI√á√ïES ---
async function carregarEleicoes() {
  try {
    const res = await dbEleicoes.allDocs({ include_docs: true });
    const cont = document.getElementById('eleicoes-list');

    if (res.rows.length === 0) {
      cont.innerHTML = `
        <div class="empty-state">
          <h3>Nenhuma elei√ß√£o cadastrada</h3>
          <p>Clique em "Nova Elei√ß√£o" para criar sua primeira elei√ß√£o</p>
        </div>
      `;
      return;
    }

    cont.innerHTML = res.rows.map(r => {
      const eleicao = r.doc;
      const status = eleicao.status === 'ativa' ? 'status-ativa' : 'status-inativa';
      const statusText = eleicao.status === 'ativa' ? 'Ativa' : 'Inativa';
      const logo = eleicao.photo || 'https://via.placeholder.com/80/1a1a1a/d4af37?text=üó≥Ô∏è';
      const tipoIcon = eleicao.tipo === 'presencial' ? 'üèõÔ∏è' : 'üåê';
      const tipoText = eleicao.tipo === 'presencial' ? 'Presencial' : 'Online';
      
      return `
        <div class="eleicao-card" onclick="abrirPainelEleicao('${eleicao._id}')">
          <img src="${logo}" alt="${eleicao.name}" class="eleicao-logo">
          <h3>${eleicao.name}</h3>
          <p><strong>Tipo:</strong> ${tipoIcon} ${tipoText}</p>
          <p><strong>Cargo:</strong> ${eleicao.position}</p>
          <p><strong>Criada em:</strong> ${new Date(eleicao.createdAt).toLocaleDateString()}</p>
          <span class="status-badge ${status}">${statusText}</span>
          <p style="margin-top: 15px; font-size: 0.8rem; color: #888;">
            Clique para gerenciar esta elei√ß√£o
          </p>
        </div>
      `;
    }).join('');
  } catch (error) {
    console.error('Erro ao carregar elei√ß√µes:', error);
  }
}

// --- ABRIR PAINEL DA ELEI√á√ÉO ---
function abrirPainelEleicao(eleicaoId) {
  window.location.href = `painel_eleicao.html?id=${eleicaoId}`;
}

// --- UPLOAD DE FOTO ---
document.getElementById('photoInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(event) {
      photoBase64 = event.target.result;
      document.getElementById('photoPreview').innerHTML = `<img src="${photoBase64}" alt="Slogan da elei√ß√£o">`;
    };
    reader.readAsDataURL(file);
  }
});

// --- CRIAR ELEI√á√ÉO ---
function criarEleicao() {
  const name = document.getElementById('electionName').value.trim();
  const position = document.getElementById('position').value.trim();
  const description = document.getElementById('description').value.trim();
  
  // Valida√ß√£o
  if (!name || !position) {
    alert('Por favor, preencha pelo menos o nome e os cargos da elei√ß√£o.');
    return;
  }
  
  if (!photoBase64) {
    alert('Por favor, selecione uma imagem/slogan para a elei√ß√£o.');
    return;
  }
  
  // Preparar dados
  electionData = {
    name: name,
    tipo: tipoEleicao,
    position: position,
    description: description,
    photo: photoBase64
  };
  
  // Abrir tela de confirma√ß√£o
  abrirTelaConfirmacao(electionData);
}

// --- TELA DE CONFIRMA√á√ÉO ---
function abrirTelaConfirmacao(dadosEleicao) {
  document.getElementById('confirmationImage').src = dadosEleicao.photo;
  document.getElementById('confirmationElectionName').textContent = dadosEleicao.name;
  document.getElementById('confirmationTipo').textContent = `Tipo: ${dadosEleicao.tipo === 'presencial' ? 'üèõÔ∏è Presencial' : 'üåê Online'}`;
  document.getElementById('confirmationPosition').textContent = `Cargos: ${dadosEleicao.position}`;
  document.getElementById('confirmationDescription').textContent = dadosEleicao.description || 'Sem descri√ß√£o';
  
  document.getElementById('confirmCadastroButton').onclick = function() {
    confirmarEleicao();
  };
  
  document.getElementById('confirmationScreen').style.display = 'flex';
}

function fecharTelaConfirmacao() {
  document.getElementById('confirmationScreen').style.display = 'none';
  electionData = null;
}

// --- CONFIRMAR ELEI√á√ÉO ---
async function confirmarEleicao() {
  document.getElementById("processando").style.display = "flex";

  try {
    // Capturar screenshot da confirma√ß√£o
    const printBase64 = await capturarPrint();
    const hashPrint = await sha256Base64(printBase64);
    
    // Criar ID √∫nico
    const electionId = `election_${Date.now()}`;
    
    // Criar documento da elei√ß√£o
    const election = {
      _id: electionId,
      name: electionData.name,
      tipo: electionData.tipo,
      position: electionData.position,
      description: electionData.description,
      photo: electionData.photo,
      screenshot_hash: hashPrint,
      status: 'ativa',
      createdAt: new Date().toISOString(),
      candidateCount: 0
    };
    
    // Salvar no banco de dados
    await dbEleicoes.put(election);
    
    console.log("üíæ Elei√ß√£o criada:", election);

    document.getElementById("processando").style.display = "none";
    
    // Limpar formul√°rio
    document.getElementById('electionName').value = '';
    document.getElementById('position').value = '';
    document.getElementById('description').value = '';
    document.getElementById('photoPreview').innerHTML = '<i class="fas fa-image"></i>';
    photoBase64 = null;
    
    // Resetar tipo para padr√£o
    document.querySelectorAll('.tipo-option').forEach(opt => {
      opt.classList.remove('selecionado');
    });
    document.querySelector('.tipo-option').classList.add('selecionado');
    tipoEleicao = 'online';
    
    fecharTelaConfirmacao();
    
    // Voltar para a aba de elei√ß√µes e recarregar
    showTab('eleicoes');
    
    // Mostrar mensagem de sucesso
    alert('üéâ Elei√ß√£o criada com sucesso!');
    
  } catch (error) {
    console.error('Erro ao criar elei√ß√£o:', error);
    document.getElementById("processando").style.display = "none";
    alert('Erro ao criar elei√ß√£o. Tente novamente.');
  }
}

// --- FUN√á√ïES AUXILIARES ---
async function sha256Base64(dataURL) {
  const base64 = dataURL.split(",")[1];
  const bytes = Uint8Array.from(atob(base64), c => c.charCodeAt(0));
  const hashBuffer = await crypto.subtle.digest("SHA-256", bytes);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
}

async function capturarPrint() {
  const elemento = document.getElementById("confirmationCard");
  const canvas = await html2canvas(elemento);
  return canvas.toDataURL("image/png");
}

// --- INICIALIZA√á√ÉO ---
document.addEventListener("DOMContentLoaded", () => {
  carregarEleicoes();
});
</script>
</body>
</html>
